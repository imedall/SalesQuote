<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iMED ALL inc. - Sales Quote System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2d7a7f 0%, #1f5a5e 100%);
            min-height: 100vh;
        }

        body.modal-open {
            overflow: hidden;
        }

        /* Hide all pages by default */
        .page { display: none; }
        .page.active { display: block; }

        /* Common Styles */
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 420px;
            padding: 48px 40px;
            margin: 20px auto;
        }

        .logo-section {
            text-align: center;
            margin-bottom: 32px;
        }

        .logo-section h1 {
            font-size: 32px;
            font-weight: 700;
            color: #2d7a7f;
            margin-bottom: 8px;
        }

        .logo-section h2 {
            font-size: 20px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .logo-section p {
            color: #6b7280;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="email"],
        input[type="password"],
        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="search"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
            background: white;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2d7a7f;
            box-shadow: 0 0 0 3px rgba(45, 122, 127, 0.1);
        }

        input::placeholder, textarea::placeholder { color: #9ca3af; }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2d7a7f 0%, #1f5a5e 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 122, 127, 0.3);
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        .btn-secondary:disabled {
             background: #d1d5db;
             color: #9ca3af;
             cursor: not-allowed;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-danger:disabled {
            background: #fca5a5;
            color: #fee2e2;
            cursor: not-allowed;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
            display: block;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
            display: block;
        }

        .message.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
            display: block;
        }

        .warning-box {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            color: #92400e;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            line-height: 1.6;
        }

        .warning-box strong {
            display: block;
            margin-bottom: 8px;
            font-size: 15px;
        }

        /* Login Page Specific */
        .forgot-password {
            text-align: center;
            margin-top: 16px;
        }

        .forgot-password a {
            color: #2d7a7f;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .forgot-password a:hover {
            text-decoration: underline;
        }

        .admin-setup-link {
            text-align: center;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e5e7eb;
        }

        .admin-setup-link a {
            color: #6b7280;
            text-decoration: none;
            font-size: 13px;
            cursor: pointer;
        }

        .admin-setup-link a:hover {
            color: #2d7a7f;
            text-decoration: underline;
        }

        .verification-notice {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            color: #92400e;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 20px;
            display: none;
        }

        .verification-notice a {
            color: #92400e;
            font-weight: 600;
            text-decoration: underline;
            cursor: pointer;
        }

        /* Admin Setup Page Specific */
        .password-requirements {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .back-link {
            text-align: center;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e5e7eb;
        }

        .back-link a {
            color: #6b7280;
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
        }

        .back-link a:hover {
            color: #2d7a7f;
            text-decoration: underline;
        }

        #setupComplete {
            display: none;
            text-align: center;
        }

        #setupComplete .success-icon {
            font-size: 64px;
            color: #10b981;
            margin-bottom: 16px;
        }

        #setupComplete h3 {
            color: #374151;
            margin-bottom: 8px;
        }

        #setupComplete p {
            color: #6b7280;
            margin-bottom: 24px;
        }

        /* Sales Quote Page Specific */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-title h1 {
            color: #2d7a7f;
            font-size: 28px;
            margin-bottom: 4px;
        }

        .header-title p {
            color: #6b7280;
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #2d7a7f;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .user-role {
            font-size: 12px;
            color: #6b7280;
        }

        .role-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 6px;
            vertical-align: middle;
        }
        .role-badge-admin { background: #dbeafe; color: #1e40af; }
        .role-badge-sales { background: #d1fae5; color: #065f46; }
        .role-badge-viewer { background: #e5e7eb; color: #4b5563; }

        .main-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
        }

        .section-header h2 {
            color: #374151;
            font-size: 24px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .quote-summary {
            background: #f9fafb;
            padding: 24px;
            border-radius: 8px;
            margin-top: 24px;
        }

        .quote-summary h3 {
            color: #374151;
            margin-bottom: 16px;
            font-size: 18px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .summary-row:last-child {
            border-bottom: none;
            padding-top: 16px;
            margin-top: 8px;
            border-top: 2px solid #2d7a7f;
            font-weight: 700;
            font-size: 20px;
            color: #2d7a7f;
        }

        .summary-label {
            color: #6b7280;
        }

        .summary-value {
            font-weight: 600;
            color: #374151;
        }

        /* Item List Styles */
        .items-container {
            margin-bottom: 24px;
        }

        .item-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 2px solid #e5e7eb;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .item-number {
            font-weight: 700;
            color: #2d7a7f;
            font-size: 18px;
        }

        .btn-remove {
            background: #fee2e2;
            color: #991b1b;
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-remove:hover:not(:disabled) {
            background: #fecaca;
        }

        .btn-add-item {
            width: 100%;
            margin-bottom: 24px;
        }

        /* History Table */
        .history-container {
            margin-top: 32px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            max-width: 400px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f3f4f6;
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            font-size: 14px;
            white-space: nowrap;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            color: #6b7280;
            font-size: 14px;
            vertical-align: middle;
        }

        tr:hover {
            background: #f9fafb;
        }

        #searchHistoryTable tbody tr:hover {
            background: #f0f9ff;
            cursor: pointer;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .price-cell {
            min-width: 120px;
        }

        .status-cell {
            min-width: 180px;
        }

        .notes-cell button {
            font-size: 14px;
            color: #2d7a7f;
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .notes-cell button:hover {
            text-decoration: underline;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: #9ca3af;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .no-history-message {
            display: none;
            text-align: center;
            padding: 32px;
            color: #9ca3af;
            font-size: 15px;
        }

        .action-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .action-button:hover {
            background-color: #e5e7eb;
        }

        .action-button svg {
            width: 20px;
            height: 20px;
            color: #6b7280;
        }

        .action-button.create-order-btn svg {
            color: #f39237;
        }

        /* User Management Styles */
        .user-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-card-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-card-details h3 {
            color: #374151;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .user-card-details p {
            color: #6b7280;
            font-size: 14px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-admin { background: #dbeafe; color: #1e40af; }
        .badge-sales { background: #d1fae5; color: #065f46; }
        .badge-viewer { background: #e5e7eb; color: #4b5563; }
       .badge-active { background: #d1fae5; color: #065f46; }
       .badge-inactive { background: #fee2e2; color: #991b1b; }

        .item-selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
        }
        .item-selection-header:hover {
            background: #f9fafb;
        }
        .item-selection-header h4 {
            margin: 0;
        }
        .selected-item-display {const API_URL = `https://api.appsheet.com/api/v2/apps/${APPSHEET_CONFIG.APP_ID}/tables/${encodedTableName}/Action`;
            font-size: 13px;
            color: #1f5a5e;
            font-weight: 600;
            margin: 4px 0 0 0;
        }
        .toggle-icon {
            font-size: 20px;
            color: #6b7280;
        }
        .item-selection-body.collapsed {
            display: none;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-overlay {
            display: none; /* Add this line to hide overlays by default */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.visible {
            display: flex; /* Use flex to show it */
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: scale(0.95);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h3, .modal-header h4 {
            color: #374151;
            font-size: 20px;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #9ca3af;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-close:hover {
            color: #374151;
        }

        .modal-actions, .modal-footer {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding: 15px 20px;
            border-top: 1px solid #e5e7eb;
        }

        .modal-actions .btn, .modal-footer .btn {
            flex: 1;
        }

        .modal-footer {
            justify-content: space-between;
            align-items: center;
        }

        .hot-item-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
            box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: white;
            border: 2px solid #e5e7eb;
            color: #374151;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            width: auto;
        }

        .filter-btn:hover {
            border-color: #2d7a7f;
            background: #f0f9ff;
            transform: none;
        }

        .filter-btn.active {
            background: #2d7a7f;
            color: white;
            border-color: #2d7a7f;
        }

        .price-group {
            display: flex;
            gap: 20px;
        }

        .price-group .form-group {
            flex: 1;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #2d7a7f;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .header-actions {
                width: 100%;
                flex-direction: column;
            }
            .user-info {
                width: 100%;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .main-content {
                padding: 20px;
            }
            .btn {
                width: 100%;
            }
            .action-buttons {
                flex-direction: column;
            }
            .user-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            .price-group {
                flex-direction: column;
                gap: 0;
            }
        }

        @media (max-width: 640px) {
            th, td {
                padding: 8px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
<!-- LOGIN PAGE -->
    <div id="loginPage" class="page active">
        <div class="container">
            <div class="logo-section">
                <h1>iMED ALL inc.</h1>
                <p>Sales Quote System</p>
            </div>

            <div id="loginMessage" class="message"></div>
            <div id="verificationNotice" class="verification-notice">
                Please verify your email before logging in.
                <a onclick="resendVerificationEmail()">Resend verification email</a>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary" id="loginBtn" style="width: 100%;">Sign In</button>
            </form>

            <div class="forgot-password">
                <a onclick="showPasswordReset()">Forgot Password?</a>
            </div>

            <div class="admin-setup-link">
                <a onclick="navigateTo('adminSetup')">First time? Set up admin account</a>
            </div>
        </div>
    </div>

    <!-- ADMIN SETUP PAGE -->
    <div id="adminSetupPage" class="page">
        <div class="container" style="max-width: 480px;">
            <div class="logo-section">
                <h1>iMED ALL inc.</h1>
                <h2>Admin Account Setup</h2>
                <p>Create the first administrator account for your sales quote system.</p>
            </div>

            <div id="setupMessage" class="message"></div>

            <div id="setupForm">
                <div class="warning-box">
                    <strong>⚠️ Important:</strong>
                    This page should only be used once to create the first admin account. After setup, admins can create additional users from the User Management section. Ensure you assign the correct role.
                </div>

                <form id="adminSetupForm">
                    <div class="form-group">
                        <label for="setupName">Full Name</label>
                        <input type="text" id="setupName" required placeholder="John Doe">
                    </div>

                    <div class="form-group">
                        <label for="setupEmail">Email Address</label>
                        <input type="email" id="setupEmail" required placeholder="admin@imedall.com">
                    </div>

                    <div class="form-group">
                        <label for="setupPassword">Password</label>
                        <input type="password" id="setupPassword" required>
                        <div class="password-requirements">
                            Minimum 8 characters, include uppercase, lowercase, and numbers
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="setupConfirmPassword">Confirm Password</label>
                        <input type="password" id="setupConfirmPassword" required>
                    </div>

                    <div class="form-group">
                        <label for="setupRole">Role *</label>
                        <select id="setupRole" required>
                            <option value="Admin" selected>Admin</option>
                            <option value="Sales Rep">Sales Rep</option>
                            <option value="Viewer">Viewer</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary" id="setupBtn" style="width: 100%;">Create Admin Account</button>
                </form>
            </div>

            <div id="setupComplete">
                <div class="success-icon">✓</div>
                <h3>Admin Account Created!</h3>
                <p>A verification email has been sent to your email address. Please verify your email before logging in.</p>
                <button onclick="navigateTo('login')" class="btn btn-primary" style="width: 100%;">Go to Login</button>
            </div>

            <div class="back-link">
                <a onclick="navigateTo('login')">← Back to Login</a>
            </div>
        </div>
    </div>

    <!-- SALES QUOTE PAGE -->
    <div id="salesQuotePage" class="page">
        <div class="app-container">
            <!-- Header -->
            <div class="header">
                <div class="header-title">
                    <h1>iMED ALL inc.</h1>
                    <p>Sales Quote System</p>
                </div>
                <div class="header-actions">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar"></div>
                        <div class="user-details">
                            <div class="user-name" id="userName">Loading...</div>
                            <div class="user-role" id="userRole">Loading role...</div>
                        </div>
                    </div>
                    <button onclick="navigateTo('userManagement')" class="btn btn-secondary" id="userManagementBtn" style="display: none;">
                        User Management
                    </button>
                    <button onclick="handleLogout()" class="btn btn-secondary">Logout</button>
                </div>
            </div>

            <div class="main-content">
                <!-- Item Details Section -->
                <section class="item-info">
                    <h3 style="margin-bottom: 16px; color: #374151; font-size: 18px;">Item Details</h3>
                    
                    <!-- WEB PRICING SECTION - NEW -->
                    <div id="webPricingSection" style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 16px; margin-bottom: 20px; display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="color: #1e40af; margin: 0; font-size: 16px;">🌐 PartSource Web Pricing</h4>
                            <button onclick="refreshWebPrice()" class="btn btn-secondary" id="refreshPriceBtn" style="padding: 6px 16px; font-size: 13px;">
                                🔄 Refresh Price
                            </button>
                        </div>
                        <div id="webPriceContent">
                            <p style="margin: 0; color: #6b7280; font-size: 14px;">Web price: Not available</p>
                        </div>
                    </div>
                    <!-- PN-SPECIFIC PRICING NOTES SECTION - UPDATED -->
                    <div id="pnPricingNotesSection" style="background: #fff7ed; border: 2px solid #fb923c; border-radius: 8px; padding: 16px; margin-bottom: 20px; display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="color: #c2410c; margin: 0; font-size: 16px;">💰 Pricing History for this PN</h4>
                            <button onclick="showAddPriceModal()" class="btn btn-primary" style="padding: 6px 16px; font-size: 13px;">
                                ➕ Add Price
                            </button>
                        </div>
                        
                        <!-- Pricing Table -->
                        <div style="overflow-x: auto; margin-top: 12px;">
                            <table style="width: 100%; background: white; border-radius: 8px; overflow: hidden; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                        <th style="padding: 12px 8px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Date</th>
                                        <th style="padding: 12px 8px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Vendor</th>
                                        <th style="padding: 12px 8px; text-align: right; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Exchange</th>
                                        <th style="padding: 12px 8px; text-align: right; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Outright</th>
                                        <th style="padding: 12px 8px; text-align: center; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; width: 100px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pnPricingTableBody">
                                    <tr>
                                        <td colspan="5" style="padding: 20px; text-align: center; color: #9ca3af; font-size: 14px;">
                                            No vendor prices added yet. Click "+ Add Price" to add one.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- PRODUCT IMAGE SECTION - NEW -->
                    <div id="productImageSection" style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 20px; display: none;">
                        <details id="imageExpandable" style="cursor: pointer;">
                            <summary style="color: #374151; font-weight: 600; font-size: 16px; list-style: none; padding: 8px 0; user-select: none;">
                                <span style="display: inline-block; margin-right: 8px;">▶</span>
                                📷 Click to load Product Image
                            </summary>
                            <div id="productImageContainer" style="text-align: center; min-height: 200px; display: flex; align-items: center; justify-content: center; background: white; border-radius: 4px; padding: 16px; margin-top: 12px;">
                                <img id="productImage" style="max-width: 100%; max-height: 400px; display: none;" alt="Product Image">
                                <p id="noImageMessage" style="color: #9ca3af; margin: 0;">No image available</p>
                            </div>
                        </details>
                    </div>
                    
                    <div style="display: flex; gap: 20px; margin-bottom: 16px;">
                        <button onclick="toggleManualEntry()" style="width: auto; padding: 6px 12px; font-size: 13px;" class="btn btn-secondary">
                            Manual Entry
                        </button>
                    </div>
                    <div id="autoItemDetails">
                        <p style="font-size: 15px; color: #4b5563; margin-bottom: 8px; line-height: 1.6;">
                            <strong style="color: #1f2937; font-weight: 600;">Name:</strong> 
                            <span id="itemName">Loading...</span>
                            <span id="hotItemBadge"></span>
                        </p>
                        <p style="font-size: 15px; color: #4b5563; margin-bottom: 8px; line-height: 1.6;">
                            <strong style="color: #1f2937; font-weight: 600;">Part Number:</strong> 
                            <span id="partNumber">...</span>
                        </p>
                    </div>
                    <div id="manualItemDetails" style="display: none;">
                        <div class="form-group">
                            <label for="manualItemName">Item Name:</label>
                            <input type="text" id="manualItemName" placeholder="Enter item name">
                        </div>
                        <div class="form-group">
                            <label for="manualPartNumber">Part Number:</label>
                            <input type="text" id="manualPartNumber" placeholder="Enter part number">
                        </div>
                    </div>
                </section>

                <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 32px 0;">

                <!-- Create New Quote Section -->
                <section class="quote-form">
                    <h3 style="margin-bottom: 16px; color: #374151; font-size: 18px;">Create New Quote</h3>
                    <form id="newQuoteForm">
                        <div class="form-group">
                            <label for="customer">Sold:</label>
                            <select id="customer" name="customer" required>
                                <option value="" disabled selected>Loading Customers...</option>
                            </select>
                        </div>
                        <div class="price-group">
                            <div class="form-group">
                                <label for="exchangePrice">Exchange Quote ($):</label>
                                <input type="text" id="exchangePrice" name="exchangePrice" placeholder="e.g., 1,500.00">
                            </div>
                            <div class="form-group">
                                <label for="outrightPrice">Outright Quote ($):</label>
                                <input type="text" id="outrightPrice" name="outrightPrice" placeholder="e.g., 2,000.00">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="warrantyDays">Warranty (Days):</label>
                            <select id="warrantyDays" name="warrantyDays" onchange="handleWarrantyChange()">
                                <option value="30">30 Days</option>
                                <option value="60">60 Days</option>
                                <option value="90" selected>90 Days</option>
                                <option value="custom">Other (Custom)</option>
                            </select>
                        </div>
                        <div class="form-group" id="customWarrantyGroup" style="display: none;">
                            <label for="customWarranty">Custom Warranty Days:</label>
                            <input type="number" id="customWarranty" placeholder="Enter days" min="1">
                        </div>

                        <div class="form-group">
                            <label for="status">Status:</label>
                            <select id="status" name="status" required>
                                <option value="Quoted">Quoted</option>
                                <option value="Sold at Quoted Price Outright">Sold at Quoted Price Outright</option>
                                <option value="Sold at Quoted Price Exchange">Sold at Quoted Price Exchange</option>
                                <option value="Lost Sale">Lost Sale</option>
                                <option value="No Stock">No Stock</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="notes">Notes:</label>
                            <textarea id="notes" name="notes" rows="3" placeholder="Add any internal notes for this quote..."></textarea>
                        </div>
                        <button type="submit" id="submitButton" class="btn btn-primary" style="width: 100%;">Save Quote</button>
                    </form>
                    <p id="formMessage" class="message"></p>
                </section>

                <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 32px 0;">

                <!-- Quote History for this Part Section -->
                <section class="quote-history">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin-bottom: 0; color: #374151; font-size: 18px;">Quote History for this Part</h3>
                        <select id="historyTimeFilter" style="width: auto; padding: 8px 12px;" onchange="handleHistoryTimeFilterChange(event)">
                            <option value="month">Last Month</option>
                            <option value="6months">Last 6 Months</option>
                            <option value="year">Last Year</option>
                            <option value="all" selected>All Time</option>
                        </select>
                    </div>
                    <div class="history-container">
                        <table id="historyTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Sold</th>
                                    <th class="price-cell">Exchange</th>
                                    <th class="price-cell">Outright</th>
                                    <th class="status-cell">Status</th>
                                    <th>Warranty</th>
                                    <th>Created By</th>
                                    <th>Notes</th>
                                    <th>Sold PO</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody"></tbody>
                        </table>
                        <p id="noHistoryMessage" class="no-history-message">No quote history found for this part.</p>
                    </div>
                </section>

                <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 32px 0;">

                <!-- Search All Quotes Section -->
                <section class="searchable-quote-history">
                    <h3 onclick="toggleSearchSection()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: #374151; font-size: 18px; margin-bottom: 16px;">
                        <span>Search All Quotes</span>
                        <span id="searchToggleIcon" style="font-size: 20px;">▼</span>
                    </h3>
                    <div id="searchQuotesContent" style="display: block;">
                        <div class="form-group">
                            <input type="search" id="quoteSearchInput" placeholder="Search by PN, Sold To, Item Name, or Status...">
                        </div>
                        
                        <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; flex: 1;">
                                <label for="resultsLimit" style="margin: 0; font-size: 14px;">Show:</label>
                                <select id="resultsLimit" style="width: auto; padding: 8px 12px;">
                                    <option value="10" selected>Recent</option>
                                    <option value="today">Today</option>
                                    <option value="yesterday">Yesterday</option>
                                    <option value="week">Last Week</option>
                                    <option value="month">Last Month</option>
                                    <option value="all">All Quotes</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button id="copySelectedButton" type="button" style="width: auto; padding: 10px 24px; font-size: 14px;" class="btn btn-secondary" disabled onclick="copySelectedQuotes()">
                                    Copy (<span id="copyCount">0</span>)
                                </button>
                                <button id="generatePdfButton" type="button" style="width: auto; padding: 10px 24px; font-size: 14px;" class="btn btn-secondary" disabled onclick="generatePDF()">
                                    PDF (<span id="selectedCount">0</span>)
                                </button>
                                <button id="createBulkOrdersButton" type="button" style="width: auto; padding: 10px 24px; font-size: 14px; background: linear-gradient(135deg, #f39237 0%, #d17a2a 100%);" class="btn btn-primary" disabled onclick="createBulkExchanges()">
                                    Create Exchanges (<span id="bulkOrderCount">0</span>)
                                </button>
                                <button id="emergencyRestoreBtn" class="btn btn-secondary" style="width: auto; padding: 10px 24px; font-size: 14px;">📦 Emergency Restore</button>
                            </div>
                        </div>
                        <div class="history-container">
                            <table id="searchHistoryTable">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">
                                            <input type="checkbox" id="selectAllCheckbox" style="cursor: pointer;">
                                        </th>
                                        <th>Date</th>
                                        <th>PN</th>
                                        <th>Sold</th>
                                        <th class="price-cell">Exchange</th>
                                        <th class="price-cell">Outright</th>
                                        <th class="status-cell">Status</th>
                                        <th>Warranty</th>
                                        <th>Created By</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="searchHistoryBody"></tbody>
                            </table>
                            <p id="noSearchResultsMessage" class="no-history-message">Type in the search bar to find quotes.</p>
                        </div>
                    </div>
                </section>

                <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 32px 0;">

                <!-- Price History Section -->
                <section class="price-history-section">
                    <h3 style="color: #374151; font-size: 18px; margin-bottom: 16px;">Price History by Part Number</h3>
                    <div class="form-group" style="display: flex; gap: 12px; align-items: flex-end;">
                        <div style="flex: 1;">
                            <label for="priceHistorySearchInput">Search Part Number:</label>
                            <input type="text" id="priceHistorySearchInput" placeholder="Enter part number...">
                        </div>
                        <button type="button" onclick="handlePriceHistorySearch()" style="width: auto; padding: 12px 32px;" class="btn btn-primary">
                            Search
                        </button>
                    </div>
                    <div class="history-container" id="priceHistoryContainer">
                        <canvas id="priceHistoryChart"></canvas>
                        <p id="noPriceHistoryMessage" class="no-history-message" style="display: none;">
                            No sales history found for this part number.
                        </p>
                    </div>
                </section>
            </div>
        </div>
    </div>
<!-- USER MANAGEMENT PAGE -->
    <div id="userManagementPage" class="page">
        <div class="app-container">
            <div class="header">
                <div class="header-title">
                    <h1>User Management</h1>
                    <p>Manage system users and permissions</p>
                </div>
                <div class="header-actions">
                    <div class="user-info">
                        <div class="user-avatar" id="userMgmtAvatar"></div>
                        <div class="user-details">
                            <div class="user-name" id="userMgmtName">Loading...</div>
                            <div class="user-role" id="userMgmtRole">Loading role...</div>
                        </div>
                    </div>
                    <button onclick="navigateTo('salesQuote')" class="btn btn-secondary">Back to Quotes</button>
                    <button onclick="handleLogout()" class="btn btn-secondary">Logout</button>
                </div>
            </div>

            <div class="main-content">
                <div class="section-header">
                    <h2>Users</h2>
                    <button onclick="showAddUserModal()" class="btn btn-primary" id="addUserShowModalBtn">+ Add User</button>
                </div>

                <div id="userManagementMessage" class="message"></div>

                <div id="usersContainer">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

   <!-- ADD USER MODAL -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New User</h3>
                <button class="btn-close" onclick="closeAddUserModal()">×</button>
            </div>

            <div id="addUserMessage" class="message"></div>

            <form id="addUserForm">
                <div class="form-group">
                    <label for="newUserName">Full Name *</label>
                    <input type="text" id="newUserName" required>
                </div>

                <div class="form-group">
                    <label for="newUserEmail">Email Address *</label>
                    <input type="email" id="newUserEmail" required>
                </div>

                <div class="form-group">
                    <label for="newUserPassword">Password *</label>
                    <input type="password" id="newUserPassword" required>
                    <div class="password-requirements">
                        Minimum 8 characters, include uppercase, lowercase, and numbers
                    </div>
                </div>

                <div class="form-group">
                    <label for="newUserRole">Role *</label>
                    <select id="newUserRole" required>
                        <option value="Viewer">Viewer</option>
                        <option value="Sales Rep">Sales Rep</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>

                <div class="modal-actions">
                    <button type="button" onclick="closeAddUserModal()" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="addUserBtn">Add User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- VIEW QUOTE MODAL -->
    <div id="viewQuoteModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Quote Details</h3>
                <button class="btn-close" onclick="closeViewQuoteModal()">×</button>
            </div>
            <div id="quoteDetails"></div>
            <div class="modal-actions">
                <button onclick="closeViewQuoteModal()" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

<!-- ALL PRICES MODAL -->
    <div id="allPricesModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h4>💰 All Prices for <span id="allPricesPN"></span></h4>
            </div>
            <div class="modal-body">
                <div id="allPricesContent" style="max-height: 500px; overflow-y: auto;">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeAllPricesModal" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

<!-- ADD PRICE MODAL -->
    <div id="addPriceModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h4>➕ Add Vendor Price</h4>
                <p id="addPricePNInfo" style="margin-top: 8px; font-size: 14px; color: #6b7280; font-weight: normal;"></p>
            </div>
            <div id="addPriceMessage" class="message"></div>
            <div class="modal-body">
                <form id="addPriceForm">
                    <div class="form-group">
                        <label for="priceDate">Date: *</label>
                        <input type="date" id="priceDate" name="priceDate" required>
                    </div>
                    <div class="form-group">
                        <label for="priceVendor">Vendor: *</label>
                        <select id="priceVendor" name="priceVendor" required>
                            <option value="">-- Select Vendor --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="priceExchange">Exchange Price:</label>
                        <input type="text" id="priceExchange" name="priceExchange" placeholder="$0.00">
                    </div>
                    <div class="form-group">
                        <label for="priceOutright">Outright Price:</label>
                        <input type="text" id="priceOutright" name="priceOutright" placeholder="$0.00">
                    </div>
                    <div class="form-group">
                        <label for="priceNotes">Notes (Optional):</label>
                        <textarea id="priceNotes" name="priceNotes" rows="3" placeholder="Add any notes about this price..."></textarea>
                    </div>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 20px;">
                        * Required fields. At least one price (Exchange or Outright) must be entered.
                    </p>
                </form>
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeAddPriceModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="saveVendorPrice()" class="btn btn-primary">💾 Save Price</button>
            </div>
        </div>
    </div>
    <!-- EMERGENCY RESTORE MODAL -->
    <div id="emergencyRestoreModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h4>📦 Emergency Restore</h4>
            </div>
            <div id="emergencyRestoreMessage" class="message"></div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: #6b7280;">
                    Upload a JSON backup file to restore quotes. The system will automatically check for duplicates and only add new quotes.
                </p>
                
                <div class="form-group">
                    <label for="restoreFileInput">Select Backup File (JSON)</label>
                    <input type="file" id="restoreFileInput" accept=".json" style="padding: 10px;">
                </div>

                <div id="restorePreview" style="display: none; margin-top: 20px;">
                    <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <h3 style="font-size: 16px; margin-bottom: 12px; color: #374151;">Restore Preview</h3>
                        <p style="margin: 4px 0;"><strong>Total Quotes in File:</strong> <span id="totalQuotesCount">0</span></p>
                        <p style="margin: 4px 0;"><strong>New Quotes to Add:</strong> <span id="newQuotesCount">0</span></p>
                        <p style="margin: 4px 0;"><strong>Duplicates (Will Skip):</strong> <span id="duplicateQuotesCount">0</span></p>
                    </div>
                </div>

                <div style="margin-top: 24px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="closeEmergencyRestoreModal" class="btn btn-secondary">Cancel</button>
                    <button id="analyzeRestoreBtn" class="btn btn-secondary" disabled>🔍 Analyze File</button>
                    <button id="executeRestoreBtn" class="btn btn-primary" disabled>✅ Execute Restore</button>
                </div>
            </div>
        </div>
    </div>

    <!-- EDIT QUOTE MODAL -->
     

    <div id="selectItemNumberModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h4>Select Item Number for Exchange</h4>
            </div>
            <div class="modal-body" id="itemSelectionContainer" style="max-height: 60vh;">
                <div class="spinner"></div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="cancelExchangeSelectionBtn" class="btn btn-secondary">Cancel</button>
                <button id="confirmExchangeCreationBtn" class="btn btn-primary">Confirm & Create Exchanges</button>
            </div>
        </div>
    </div>

        <div id="editModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h4>Edit Quote</h4>
                <p id="editItemInfo" style="margin-top: 8px; font-size: 14px; color: #6b7280; font-weight: normal;"></p>
                <p id="editCreatedByInfo" style="margin-top: 4px; font-size: 13px; color: #9ca3af; font-weight: normal;"></p>
            </div>
            <div class="modal-body">
                <form id="editQuoteForm">
                    <input type="hidden" id="editQuoteId">
                    <div class="form-group">
                        <label for="editItemName">Item Name:</label>
                        <input type="text" id="editItemName" name="itemName" required>
                    </div>
                    <div class="form-group">
                        <label for="editDate">Quote Date:</label>
                        <input type="date" id="editDate" name="date" required>
                    </div>
                    <div class="form-group">
                        <label for="editPartNumber">Part Number:</label>
                        <input type="text" id="editPartNumber" name="partNumber" required>
                    </div>
                    <div class="form-group">
                        <label for="editSoldTo">Sold:</label>
                        <select id="editSoldTo" name="sold" required></select>
                    </div>
                    <div class="price-group">
                        <div class="form-group">
                            <label for="editExchangePrice">Exchange Quote ($):</label>
                            <input type="text" id="editExchangePrice" name="exchangePrice">
                        </div>
                        <div class="form-group">
                            <label for="editOutrightPrice">Outright Quote ($):</label>
                            <input type="text" id="editOutrightPrice" name="outrightPrice">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editStatus">Status:</label>
                        <select id="editStatus" name="status" required>
                            <option value="Quoted">Quoted</option>
                            <option value="Sold at Quoted Price Outright">Sold at Quoted Price Outright</option>
                            <option value="Sold at Quoted Price Exchange">Sold at Quoted Price Exchange</option>
                            <option value="Lost Sale">Lost Sale</option>
                            <option value="No Stock">No Stock</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editWarrantyDays">Warranty (Days):</label>
                        <select id="editWarrantyDays" name="warrantyDays" onchange="handleEditWarrantyChange()">
                            <option value="30">30 Days</option>
                            <option value="60">60 Days</option>
                            <option value="90">90 Days</option>
                            <option value="custom">Other (Custom)</option>
                        </select>
                    </div>
                    <div class="form-group" id="editCustomWarrantyGroup" style="display: none;">
                        <label for="editCustomWarranty">Custom Warranty Days:</label>
                        <input type="number" id="editCustomWarranty" placeholder="Enter days" min="1">
                    </div>
                    <div class="form-group">
                        <label for="editNotes">Notes:</label>
                        <textarea id="editNotes" name="notes" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editSoldPO">Sold PO:</label>
                        <input type="text" id="editSoldPO" name="soldPO" placeholder="Enter PO number (optional)">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="deleteQuoteButton" class="btn btn-danger">Delete</button>
                <div style="display: flex; gap: 12px;">
                    <button type="button" id="cancelEditButton" class="btn btn-secondary">Cancel</button>
                    <button type="button" id="saveEditButton" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>

    <!-- Firebase and Chart.js Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // ===================================
        // FIREBASE CONFIGURATION
        // ===================================
        const firebaseConfig = {
            apiKey: "AIzaSyCe0u6B6qA9y6xvSR_jbY1Do-ljPKy5Lu8",
            authDomain: "imed-sales-quote.firebaseapp.com",
            databaseURL: "https://imed-sales-quote-default-rtdb.firebaseio.com",
            projectId: "imed-sales-quote",
            storageBucket: "imed-sales-quote.firebasestorage.app",
            messagingSenderId: "830326754595",
            appId: "1:830326754595:web:ca03272749599736fad096",
            measurementId: "G-6TCTDFX5PL"
        };

        // ===================================
        // APPSHEET CONFIGURATION
        // ===================================
        const APPSHEET_CONFIG = {
            API_KEY: "V2-p5nLK-I6suM-yAVyE-bhP5n-TaFuq-uDBbY-vjvr0-8RoEu",
            APP_ID: "876dcdc3-0570-427f-9be0-53367d74bf69",
            TABLE_NAME: "Siemens Stock",
            CUSTOMER_COLUMN: "Sold",
            EXCHANGES_TABLE: "Exchanges"
        };

        // ===================================
        // WEB SCRAPING CONFIGURATION
        // ===================================
        const WEB_SCRAPING_CONFIG = {
            BASE_URL: "https://www.partssource.com/parts/siemens-medical-solutions/",
            CACHE_DURATION_HOURS: 24,
            AUTO_REFRESH_DAYS: 7
        };

        let webPriceCache = {};

        // ===================================
        // GLOBAL VARIABLES
        // ===================================
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null;
        let currentUserData = null;
        let itemCounter = 0;
        let quotesData = [];
        let currentQuoteId = null;
        let lastFailedEmail = '';
        let editItemCounter = 0;
        let allQuotesCache = [];
        let soldListCache = [];
        let salesHistoryChart;
        let priceHistoryChart;
        let currentHistoryListener = null;
        let selectedQuotes = new Set();
        let currentResultsLimit = 10;
        let selectedWarrantyDays = 90;
        let customWarrantyDays = '';
        let currentTimeFilter = 'all';
        let currentHistoryTimeFilter = 'all';
        let currentPriceHistoryPn = null;
let siemensStockCache = null;
        let currentQuotesForExchange = [];

        // ===================================
        // NAVIGATION SYSTEM
        // ===================================
        function navigateTo(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

            switch(page) {
                case 'login':
                    document.getElementById('loginPage').classList.add('active');
                    break;
                case 'adminSetup':
                    document.getElementById('adminSetupPage').classList.add('active');
                    break;
                case 'salesQuote':
                    document.getElementById('salesQuotePage').classList.add('active');
                    loadQuotes();
                    break;
                case 'userManagement':
                    if (currentUserData && currentUserData.role === 'Admin') {
                        document.getElementById('userManagementPage').classList.add('active');
                        loadUsers();
                    } else {
                        alert('Access denied. Only Admins can manage users.');
                        navigateTo('salesQuote');
                    }
                    break;
                default:
                    navigateTo('login');
            }
        }

        // ===================================
        // AUTHENTICATION STATE OBSERVER
        // ===================================
        auth.onAuthStateChanged(async (user) => {
            const onSetupPage = document.getElementById('adminSetupPage').classList.contains('active');

            if (user) {
                if (!user.emailVerified) {
                    const setupCompleteVisible = document.getElementById('setupComplete').style.display === 'block';
                    if (onSetupPage && !setupCompleteVisible) {
                        // Still on setup form, let it continue
                    } else if (onSetupPage && setupCompleteVisible) {
                        await auth.signOut();
                        navigateTo('login');
                        showMessage('loginMessage', 'info', 'Account created! Please check your email to verify before logging in.');
                    } else {
                        lastFailedEmail = user.email;
                        await auth.signOut();
                        navigateTo('login');
                        document.getElementById('verificationNotice').style.display = 'block';
                        showMessage('loginMessage', 'error', 'Please verify your email before logging in.');
                    }
                    return;
                }

                // Email verified
                currentUser = user;
                try {
                    const snapshot = await database.ref(`users/${user.uid}`).once('value');
                    currentUserData = snapshot.val();

                    if (!currentUserData) {
                        console.error("User exists in Auth but not in Database.", user.uid);
                        await auth.signOut();
                        navigateTo('login');
                        showMessage('loginMessage', 'error', 'User data missing. Please contact administrator.');
                        return;
                    }

                    if (currentUserData.status !== 'active') {
                        await auth.signOut();
                        navigateTo('login');
                        showMessage('loginMessage', 'error', 'Your account is inactive. Please contact an administrator.');
                        return;
                    }

                    if (!onSetupPage) {
                        await logActivity('login', null, `${currentUserData.name} logged in.`);
                    }

                    updateUserUI();
                    configureUIAccess();

                    const currentPageId = document.querySelector('.page.active')?.id;
                    if (!currentPageId || currentPageId === 'loginPage' || currentPageId === 'adminSetupPage') {
                        navigateTo('salesQuote');
                    }

                } catch (error) {
                    console.error('Error loading user data:', error);
                    await auth.signOut();
                    navigateTo('login');
                    showMessage('loginMessage', 'error', 'Failed to load user data.');
                }
            } else {
                // User signed out
                currentUser = null;
                currentUserData = null;
                navigateTo('login');
            }
        });

        // ===================================
        // UPDATE USER INTERFACE
        // ===================================
        function updateUserUI() {
            if (currentUserData) {
                const name = currentUserData.name;
                const role = currentUserData.role;
                const initial = name ? name.charAt(0).toUpperCase() : '?';
                const roleClass = `role-badge-${role?.toLowerCase().replace(' ', '') || 'viewer'}`;

                // Sales Quote Page Header
                document.getElementById('userName').textContent = name || 'User';
                document.getElementById('userRole').innerHTML = `${role} <span class="role-badge ${roleClass}">${role}</span>`;
                document.getElementById('userAvatar').textContent = initial;

                // User Management Page Header
                if (document.getElementById('userMgmtName')) {
                    document.getElementById('userMgmtName').textContent = name || 'User';
                    document.getElementById('userMgmtRole').innerHTML = `${role} <span class="role-badge ${roleClass}">${role}</span>`;
                    document.getElementById('userMgmtAvatar').textContent = initial;
                }

                // Show User Management button only for Admins
                document.getElementById('userManagementBtn').style.display = (role === 'Admin') ? 'inline-block' : 'none';
            } else {
                document.getElementById('userName').textContent = 'Error';
                document.getElementById('userRole').textContent = '';
                document.getElementById('userAvatar').textContent = '?';
                document.getElementById('userManagementBtn').style.display = 'none';
                if (document.getElementById('userMgmtName')) {
                    document.getElementById('userMgmtName').textContent = 'Error';
                    document.getElementById('userMgmtRole').textContent = '';
                    document.getElementById('userMgmtAvatar').textContent = '?';
                }
            }
        }

        // ===================================
        // CONFIGURE UI ACCESS BASED ON ROLE
        // ===================================
        function configureUIAccess() {
            const role = currentUserData?.role;
            const isAdmin = role === 'Admin';
            const isSalesRep = role === 'Sales Rep';
            const isViewer = role === 'Viewer';

            const saveQuoteBtn = document.getElementById('submitButton');
            const addItemBtn = document.getElementById('addItemBtn');

            if (isViewer) {
                if (saveQuoteBtn) saveQuoteBtn.disabled = true;
                if (addItemBtn) addItemBtn.disabled = true;
            } else {
                if (saveQuoteBtn) saveQuoteBtn.disabled = false;
                if (addItemBtn) addItemBtn.disabled = false;
            }

            const userMgmtBtn = document.getElementById('userManagementBtn');
            if (userMgmtBtn) userMgmtBtn.style.display = isAdmin ? 'inline-block' : 'none';

            const addUserShowModalBtn = document.getElementById('addUserShowModalBtn');
            if (addUserShowModalBtn) addUserShowModalBtn.style.display = isAdmin ? 'inline-block' : 'none';

            const emergencyRestoreBtn = document.getElementById('emergencyRestoreBtn');
            if (emergencyRestoreBtn) emergencyRestoreBtn.style.display = isAdmin ? 'inline-block' : 'none';

            const newUserRoleSelect = document.getElementById('newUserRole');
            if (newUserRoleSelect && !isAdmin) {
                const adminOption = newUserRoleSelect.querySelector('option[value="Admin"]');
                if (adminOption) adminOption.remove();
            }
        }
// ===================================
        // LOGIN FUNCTIONALITY
        // ===================================
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const messageDiv = document.getElementById('loginMessage');
            const verificationNotice = document.getElementById('verificationNotice');

            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            messageDiv.className = 'message';
            messageDiv.style.display = 'none';
            verificationNotice.style.display = 'none';

            try {
                await auth.signInWithEmailAndPassword(email, password);
                // onAuthStateChanged will handle success and verification checks
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Login failed. Please check credentials.';

                switch (error.code) {
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address format.'; break;
                    case 'auth/user-disabled':
                        errorMessage = 'This account has been disabled.'; break;
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = 'Invalid email or password.'; break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Too many attempts. Please try again later.'; break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Network error. Check connection.'; break;
                }

                showMessage('loginMessage', 'error', errorMessage);
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        });

        async function resendVerificationEmail() {
            if (!lastFailedEmail) {
                showMessage('loginMessage', 'info', 'Please attempt to log in first so we know which email to use.');
                return;
            }

            const password = prompt(`Please enter the password for ${lastFailedEmail} to resend verification email:`);
            if (!password) return;

            showMessage('loginMessage', 'info', 'Attempting to resend verification...');

            try {
                const userCredential = await auth.signInWithEmailAndPassword(lastFailedEmail, password);
                if (userCredential.user) {
                    await userCredential.user.sendEmailVerification();
                    await auth.signOut();
                    showMessage('loginMessage', 'success', 'Verification email sent! Please check your inbox (and spam folder).');
                    document.getElementById('verificationNotice').style.display = 'none';
                } else {
                    throw new Error("Could not get user object.");
                }
            } catch (error) {
                console.error('Resend verification error:', error);
                let msg = 'Failed to resend verification email.';
                if (error.code === 'auth/wrong-password') {
                    msg = 'Incorrect password. Cannot resend verification.';
                }
                showMessage('loginMessage', 'error', msg);
            }
        }

        async function showPasswordReset() {
            const email = document.getElementById('loginEmail').value || prompt('Enter your email address to reset password:');
            if (!email) return;

            showMessage('loginMessage', 'info', 'Sending password reset email...');

            try {
                await auth.sendPasswordResetEmail(email);
                showMessage('loginMessage', 'success', 'Password reset email sent! Please check your inbox.');
            } catch (error) {
                console.error('Password reset error:', error);
                let errorMessage = 'Failed to send reset email.';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No account found with that email.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address format.';
                }
                showMessage('loginMessage', 'error', errorMessage);
            }
        }

        // ===================================
        // ADMIN SETUP FUNCTIONALITY
        // ===================================
        document.getElementById('adminSetupForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('setupName').value.trim();
            const email = document.getElementById('setupEmail').value.trim();
            const password = document.getElementById('setupPassword').value;
            const confirmPassword = document.getElementById('setupConfirmPassword').value;
            const role = document.getElementById('setupRole').value;
            const setupBtn = document.getElementById('setupBtn');
            const messageDiv = document.getElementById('setupMessage');

            messageDiv.className = 'message';
            messageDiv.style.display = 'none';

            if (password !== confirmPassword) {
                return showMessage('setupMessage', 'error', 'Passwords do not match.');
            }
            if (password.length < 8 || !/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(password)) {
                return showMessage('setupMessage', 'error', 'Password must meet complexity requirements.');
            }

            setupBtn.disabled = true;
            setupBtn.textContent = 'Creating Account...';

            try {
                const userCheckSnapshot = await database.ref('users').limitToFirst(1).once('value');
                if (userCheckSnapshot.exists()) {
                    throw new Error('Initial setup appears complete. Please use the login page.');
                }

                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                await user.sendEmailVerification();

                const newUserDbData = {
                    uid: user.uid,
                    email: email,
                    name: name,
                    role: role,
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    emailVerified: false
                };
                await database.ref(`users/${user.uid}`).set(newUserDbData);

                document.getElementById('setupForm').style.display = 'none';
                document.getElementById('setupComplete').style.display = 'block';

                await auth.signOut();

            } catch (error) {
                console.error('Setup error:', error);
                let errorMessage = 'Failed to create admin account.';
                switch (error.code) {
                    case 'auth/email-already-in-use': errorMessage = 'This email is already registered.'; break;
                    case 'auth/invalid-email': errorMessage = 'Invalid email address format.'; break;
                    case 'auth/weak-password': errorMessage = 'Password is too weak.'; break;
                    case 'auth/network-request-failed': errorMessage = 'Network error.'; break;
                    default: if (error.message) errorMessage = error.message;
                }
                showMessage('setupMessage', 'error', errorMessage);
                setupBtn.disabled = false;
                setupBtn.textContent = 'Create Admin Account';
            }
        });

        // ===================================
        // LOGOUT FUNCTIONALITY
        // ===================================
        async function handleLogout() {
            if (confirm('Are you sure you want to log out?')) {
                try {
                    await logActivity('logout', null, `${currentUserData?.name || 'User'} logged out.`);
                    await auth.signOut();
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Logout failed. Please try again.');
                    await logActivity('logout_error', null, `Logout error: ${error.message}`);
                }
            }
        }

        // ===================================
        // UTILITY FUNCTIONS
        // ===================================
        function showMessage(elementId, type, text, duration = 5000) {
            const messageDiv = document.getElementById(elementId);
            if (!messageDiv) return;

            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';

            if (duration > 0) {
                setTimeout(() => {
                    if (messageDiv.textContent === text) {
                        messageDiv.style.display = 'none';
                        messageDiv.className = 'message';
                        messageDiv.textContent = '';
                    }
                }, duration);
            }
        }

        async function logActivity(action, targetId, description) {
            if (!currentUser || !currentUserData) return;

            const logEntry = {
                timestamp: new Date().toISOString(),
                userId: currentUser.uid,
                userName: currentUserData.name,
                userEmail: currentUser.email,
                userRole: currentUserData.role,
                action: action,
                targetId: targetId || null,
                description: description
            };

            try {
                await database.ref('activityLog').push(logEntry);
            } catch (error) {
                console.error("Failed to log activity:", error, logEntry);
            }
        }

        function formatPrice(price) {
            const num = parseFloat(price);
            if (isNaN(num)) return '—';
            return `$${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // ===================================
        // TOGGLE FUNCTIONS
        // ===================================
        function toggleManualEntry() {
            const autoDetails = document.getElementById('autoItemDetails');
            const manualDetails = document.getElementById('manualItemDetails');
            
            if (autoDetails.style.display === 'none') {
                autoDetails.style.display = 'block';
                manualDetails.style.display = 'none';
            } else {
                autoDetails.style.display = 'none';
                manualDetails.style.display = 'block';
            }
        }

        function toggleSearchSection() {
            const content = document.getElementById('searchQuotesContent');
            const icon = document.getElementById('searchToggleIcon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '▼';
            } else {
                content.style.display = 'none';
                icon.textContent = '►';
            }
        }

        // ===================================
        // WARRANTY HANDLING
        // ===================================
        function handleWarrantyChange() {
            const select = document.getElementById('warrantyDays');
            const customGroup = document.getElementById('customWarrantyGroup');
            
            if (select.value === 'custom') {
                customGroup.style.display = 'block';
                selectedWarrantyDays = null;
            } else {
                customGroup.style.display = 'none';
                selectedWarrantyDays = parseInt(select.value);
            }
        }

        function getWarrantyDays() {
            const select = document.getElementById('warrantyDays');
            if (select.value === 'custom') {
                const customValue = document.getElementById('customWarranty').value;
                return customValue ? parseInt(customValue) : 90;
            }
            return parseInt(select.value);
        }

        function handleEditWarrantyChange() {
            const select = document.getElementById('editWarrantyDays');
            const customGroup = document.getElementById('editCustomWarrantyGroup');
            
            if (select.value === 'custom') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
            }
        }

        function getEditWarrantyDays() {
            const select = document.getElementById('editWarrantyDays');
            if (select.value === 'custom') {
                const customValue = document.getElementById('editCustomWarranty').value;
                return customValue ? parseInt(customValue) : 90;
            }
            return parseInt(select.value);
        }

        // ===================================
        // CURRENCY INPUT HANDLING
        // ===================================
        function handleCurrencyInput(event) {
            const input = event.target;
            let value = input.value;
            let cursorPosition = input.selectionStart;
            const commasBefore = (value.substring(0, cursorPosition).match(/,/g) || []).length;
            
            let numericValue = value.replace(/[^0-9.]/g, '');
            const parts = numericValue.split('.');
            if (parts.length > 2) numericValue = parts[0] + '.' + parts.slice(1).join('');
            
            const [integerPart, decimalPart] = numericValue.split('.');
            const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            
            let finalValue = formattedInteger;
            if (decimalPart !== undefined) finalValue += '.' + decimalPart.substring(0, 2);
            
            input.value = finalValue;
            
            const commasAfter = (input.value.substring(0, cursorPosition).match(/,/g) || []).length;
            cursorPosition += (commasAfter - commasBefore);
            if(cursorPosition < 0) cursorPosition = 0;
            input.setSelectionRange(cursorPosition, cursorPosition);
        }

        function handleCurrencyBlur(event) {
            const input = event.target;
            let value = input.value;
            if (value === '') return;
            
            const numericValue = parseFloat(value.replace(/,/g, ''));
            if (!isNaN(numericValue)) {
                input.value = numericValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                input.value = '';
            }
        }

        // ===================================
        // HOT ITEM DETECTION
        // ===================================
        function getHotItemStatus(pn) {
            if (!pn) return null;
            
            const now = Date.now();
            const oneWeekAgo = now - (7 * 24 * 60 * 60 * 1000);
            const oneMonthAgo = now - (30 * 24 * 60 * 60 * 1000);
            const oneYearAgo = now - (365 * 24 * 60 * 60 * 1000);
            
            const allQuotesForPn = allQuotesCache.filter(quote => quote.pn === pn);
            
            const quotesByDate = {};
            allQuotesForPn.forEach(quote => {
                const date = new Date(quote.date);
                const dateKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
                
                if (!quotesByDate[dateKey]) {
                    quotesByDate[dateKey] = {
                        timestamp: date.getTime(),
                        count: 0
                    };
                }
                quotesByDate[dateKey].count++;
            });
            
            const uniqueDaysInWeek = Object.values(quotesByDate).filter(day => day.timestamp >= oneWeekAgo).length;
            const totalQuotesInMonth = allQuotesForPn.filter(q => new Date(q.date).getTime() >= oneMonthAgo).length;
            const totalQuotesInYear = allQuotesForPn.filter(q => new Date(q.date).getTime() >= oneYearAgo).length;
            
            if (totalQuotesInYear >= 20) {
                return { level: 'year', label: '🔥 Hot Item of the Year' };
            }
            
            if (totalQuotesInMonth >= 10) {
                return { level: 'month', label: '🔥 Hot Item of the Month' };
            }
            
            if (uniqueDaysInWeek >= 3) {
                return { level: 'week', label: '🔥 Hot Item of the Week' };
            }
            
            return null;
        }

        function updateHotItemBadge(pn) {
            const badgeContainer = document.getElementById('hotItemBadge');
            const hotStatus = getHotItemStatus(pn);
            
            if (hotStatus) {
                badgeContainer.innerHTML = `<span class="hot-item-badge">${hotStatus.label}</span>`;
            } else {
                badgeContainer.innerHTML = '';
            }
        }

        // ===================================
        // UPDATE MAIN VIEW
        // ===================================
        function updateMainView(pn, itemName) {
            document.getElementById('itemName').textContent = itemName || 'N/A';
            document.getElementById('partNumber').textContent = pn || 'N/A';
            
            updateHotItemBadge(pn);
            
            if (currentHistoryListener) {
                currentHistoryListener.off();
            }
            listenForQuoteHistory(pn);
            
            renderPriceHistoryChart(pn);
            document.getElementById('priceHistorySearchInput').value = pn;
            
            // DISPLAY WEB PRICE - NEW
            displayWebPrice(pn);
            
            // LOAD PN PRICING NOTES - NEW
            loadPnPricingNotes(pn);
        }
// ===================================
        // QUOTE FORM SUBMISSION
        // ===================================
        document.getElementById('newQuoteForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            
            if (currentUserData.role === 'Viewer') {
                alert('You do not have permission to create quotes. Please contact your administrator.');
                return;
            }
            
            const form = event.target;
            const formData = new FormData(form);
            
            let pn, itemName;
            const autoDetails = document.getElementById('autoItemDetails');
            if (autoDetails.style.display === 'none') {
                pn = document.getElementById('manualPartNumber').value;
                itemName = document.getElementById('manualItemName').value;
            } else {
                pn = document.getElementById('partNumber').textContent;
                itemName = document.getElementById('itemName').textContent;
            }
            
            const outrightPriceValue = formData.get('outrightPrice').replace(/,/g, '');
            const exchangePriceValue = formData.get('exchangePrice').replace(/,/g, '');
            
            const newQuote = {
                pn: pn,
                itemName: itemName,
                sold: formData.get('customer'),
                outrightPrice: outrightPriceValue ? parseFloat(outrightPriceValue) : null,
                exchangePrice: exchangePriceValue ? parseFloat(exchangePriceValue) : null,
                warrantyDays: getWarrantyDays(),
                status: formData.get('status'),
                notes: formData.get('notes'),
                soldPO: '',
                date: new Date().toISOString(),
                createdBy: currentUser.uid,
                createdByEmail: currentUser.email,
                createdByName: currentUserData.name,
                createdAt: new Date().toISOString()
            };
            
            const messageEl = document.getElementById('formMessage');
            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';
            
            try {
                const quoteRef = await database.ref('quotes').push(newQuote);
                
                await logActivity('create_quote', quoteRef.key, `Created quote for ${itemName} (${pn}) - ${formData.get('customer')}`);
                
                messageEl.textContent = 'Quote saved successfully!';
                messageEl.className = 'success';
                form.reset();
                
                document.getElementById('warrantyDays').value = '90';
                document.getElementById('customWarrantyGroup').style.display = 'none';
                selectedWarrantyDays = 90;
                
            } catch (error) {
                messageEl.textContent = `Error: ${error.message}`;
                messageEl.className = 'error';
            } finally {
                setTimeout(() => {
                    messageEl.textContent = '';
                    messageEl.className = '';
                    submitButton.disabled = false;
                    submitButton.textContent = 'Save Quote';
                }, 2000);
            }
        });

        // ===================================
        // LISTEN FOR QUOTE HISTORY
        // ===================================
        function listenForQuoteHistory(pn) {
            const quotesRef = database.ref('quotes').orderByChild('pn').equalTo(pn);
            currentHistoryListener = quotesRef;
            
            quotesRef.on('value', (snapshot) => {
                const historyBody = document.getElementById('historyBody');
                const noHistoryMessage = document.getElementById('noHistoryMessage');
                let quotes = [];
                
                if (snapshot.exists()) {
                    noHistoryMessage.style.display = 'none';
                    snapshot.forEach(childSnapshot => {
                        quotes.push({ id: childSnapshot.key, ...childSnapshot.val() });
                    });
                    
                    const sortedQuotes = quotes.sort((a, b) => new Date(b.date) - new Date(a.date));
                    const filteredQuotes = filterQuotesByTimeRange(sortedQuotes, currentHistoryTimeFilter);
                    renderHistoryTable(historyBody, filteredQuotes);
                } else {
                    historyBody.innerHTML = '';
                    noHistoryMessage.style.display = 'block';
                }
            });
        }

        function filterQuotesByTimeRange(quotes, timeRange) {
            if (timeRange === 'all') {
                return quotes;
            }
            
            const now = Date.now();
            let cutoffDate;
            
            switch(timeRange) {
                case 'month':
                    cutoffDate = now - (30 * 24 * 60 * 60 * 1000);
                    break;
                case '6months':
                    cutoffDate = now - (180 * 24 * 60 * 60 * 1000);
                    break;
                case 'year':
                    cutoffDate = now - (365 * 24 * 60 * 60 * 1000);
                    break;
                default:
                    return quotes;
            }
            
            return quotes.filter(quote => {
                const quoteDate = new Date(quote.date).getTime();
                return quoteDate >= cutoffDate;
            });
        }

        function handleHistoryTimeFilterChange(event) {
            currentHistoryTimeFilter = event.target.value;
            
            const currentPn = document.getElementById('partNumber').textContent;
            if (currentPn && currentPn !== 'N/A') {
                if (currentHistoryListener) {
                    currentHistoryListener.off();
                    listenForQuoteHistory(currentPn);
                }
            }
        }

        // ===================================
        // LOAD ALL QUOTES FOR SEARCH
        // ===================================
        function fetchAllQuotesForSearch() {
            const quotesRef = database.ref('quotes');
            quotesRef.on('value', (snapshot) => {
                const quotes = snapshot.val();
                if (quotes) {
                    allQuotesCache = Object.keys(quotes)
                        .map(key => ({ id: key, ...quotes[key] }))
                        .sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    const displayQuotes = getQuotesToDisplay();
                    renderHistoryTable(document.getElementById('searchHistoryBody'), displayQuotes, true);
                } else {
                    allQuotesCache = [];
                    document.getElementById('searchHistoryBody').innerHTML = '';
                }
                
                const searchTerm = document.getElementById('quoteSearchInput').value;
                if (searchTerm) filterAndDisplayQuotes(searchTerm);
                
                const currentPn = document.getElementById('partNumber').textContent;
                if (currentPn && currentPn !== 'N/A') {
                    updateHotItemBadge(currentPn);
                }
            });
        }

        function loadQuotes() {
            // This function is called when navigating to sales quote page
            // Most loading is handled by fetchAllQuotesForSearch which is set up on page init
        }

        // ===================================
        // GET QUOTES TO DISPLAY
        // ===================================
        function getQuotesToDisplay() {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
            const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
            const yesterdayStart = new Date(todayStart);
            yesterdayStart.setDate(yesterdayStart.getDate() - 1);
            const yesterdayEnd = new Date(todayEnd);
            yesterdayEnd.setDate(yesterdayEnd.getDate() - 1);
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            let quotes = allQuotesCache;
            
            switch(currentResultsLimit) {
                case 'today':
                    quotes = allQuotesCache.filter(q => {
                        const qDate = new Date(q.date);
                        return qDate >= todayStart && qDate <= todayEnd;
                    });
                    break;
                case 'yesterday':
                    quotes = allQuotesCache.filter(q => {
                        const qDate = new Date(q.date);
                        return qDate >= yesterdayStart && qDate <= yesterdayEnd;
                    });
                    break;
                case 'week':
                    quotes = allQuotesCache.filter(q => new Date(q.date) >= weekAgo);
                    break;
                case 'month':
                    quotes = allQuotesCache.filter(q => new Date(q.date) >= monthAgo);
                    break;
                case 'all':
                    quotes = allQuotesCache;
                    break;
                default:
                    quotes = allQuotesCache.slice(0, parseInt(currentResultsLimit));
                    break;
            }
            
            return quotes;
        }

        function handleResultsLimitChange(event) {
            currentResultsLimit = event.target.value;
            const searchTerm = document.getElementById('quoteSearchInput').value;
            
            if (searchTerm) {
                filterAndDisplayQuotes(searchTerm);
            } else {
                const displayQuotes = getQuotesToDisplay();
                renderHistoryTable(document.getElementById('searchHistoryBody'), displayQuotes, true);
                document.getElementById('noSearchResultsMessage').style.display = displayQuotes.length === 0 ? 'block' : 'none';
            }
        }

        // ===================================
        // FILTER AND DISPLAY QUOTES
        // ===================================
        function filterAndDisplayQuotes(searchTerm) {
            const searchHistoryBody = document.getElementById('searchHistoryBody');
            const noResultsMessage = document.getElementById('noSearchResultsMessage');
            
            if (!searchTerm) {
                const displayQuotes = getQuotesToDisplay();
                renderHistoryTable(searchHistoryBody, displayQuotes, true);
                noResultsMessage.textContent = 'Type in the search bar to find quotes.';
                noResultsMessage.style.display = displayQuotes.length === 0 ? 'block' : 'none';
                return;
            }
            
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
            const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
            const yesterdayStart = new Date(todayStart);
            yesterdayStart.setDate(yesterdayStart.getDate() - 1);
            const yesterdayEnd = new Date(todayEnd);
            yesterdayEnd.setDate(yesterdayEnd.getDate() - 1);
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            let quotesToFilter = allQuotesCache;
            
            switch(currentResultsLimit) {
                case 'today':
                    quotesToFilter = allQuotesCache.filter(q => {
                        const qDate = new Date(q.date);
                        return qDate >= todayStart && qDate <= todayEnd;
                    });
                    break;
                case 'yesterday':
                    quotesToFilter = allQuotesCache.filter(q => {
                        const qDate = new Date(q.date);
                        return qDate >= yesterdayStart && qDate <= yesterdayEnd;
                    });
                    break;
                case 'week':
                    quotesToFilter = allQuotesCache.filter(q => new Date(q.date) >= weekAgo);
                    break;
                case 'month':
                    quotesToFilter = allQuotesCache.filter(q => new Date(q.date) >= monthAgo);
                    break;
                case 'all':
                    quotesToFilter = allQuotesCache;
                    break;
                default:
                    quotesToFilter = allQuotesCache.slice(0, parseInt(currentResultsLimit));
                    break;
            }
            
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const filteredQuotes = quotesToFilter.filter(q =>
                (q.pn && q.pn.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (q.sold && q.sold.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (q.itemName && q.itemName.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (q.status && q.status.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (q.soldPO && q.soldPO.toLowerCase().includes(lowerCaseSearchTerm))
            );
            
            if (filteredQuotes.length > 0) {
                noResultsMessage.style.display = 'none';
                renderHistoryTable(searchHistoryBody, filteredQuotes, true);
            } else {
                searchHistoryBody.innerHTML = '';
                noResultsMessage.textContent = 'No quotes found matching your search.';
                noResultsMessage.style.display = 'block';
            }
        }

        // ===================================
        // RENDER HISTORY TABLE
        // ===================================
        function renderHistoryTable(tableBody, quotes, includePn = false) {
            tableBody.innerHTML = '';
            
            if (quotes.length === 0) return;
            
            quotes.forEach(quote => {
                const row = tableBody.insertRow();
                if (includePn) {
                    row.dataset.pn = quote.pn || '';
                    row.dataset.itemName = quote.itemName || '';
                }
                
                const quoteData = JSON.stringify(quote).replace(/'/g, "&apos;");
                const isChecked = selectedQuotes.has(quote.id);
                
                const createdByName = quote.createdByName || quote.createdByEmail || 'Unknown';
                const createdByShort = createdByName.split(' ')[0]; // First name only
                
                let cells = `
                    ${includePn ? `<td><input type="checkbox" class="quote-checkbox" data-quote-id="${quote.id}" ${isChecked ? 'checked' : ''} style="cursor: pointer;"></td>` : ''}
                    <td>${new Date(quote.date).toLocaleDateString()}</td>
                    ${includePn ? `<td>${quote.pn || 'N/A'}</td>` : ''}
                    <td>${quote.sold || 'N/A'}</td>
                    <td class="price-cell">${formatPrice(quote.exchangePrice)}</td>
                    <td class="price-cell">${formatPrice(quote.outrightPrice)}</td>
                    <td class="status-cell"><select class="status-select" onchange="handleStatusChange(event, '${quote.id}')" ${currentUserData && currentUserData.role === 'Viewer' ? 'disabled' : ''}>
                        <option value="Quoted" ${quote.status === 'Quoted' ? 'selected' : ''}>Quoted</option>
                        <option value="Sold at Quoted Price Outright" ${quote.status === 'Sold at Quoted Price Outright' ? 'selected' : ''}>Sold Outright</option>
                        <option value="Sold at Quoted Price Exchange" ${quote.status === 'Sold at Quoted Price Exchange' ? 'selected' : ''}>Sold Exchange</option>
                        <option value="Lost Sale" ${quote.status === 'Lost Sale' ? 'selected' : ''}>Lost Sale</option>
                        <option value="No Stock" ${quote.status === 'No Stock' ? 'selected' : ''}>No Stock</option>
                    </select></td>
                    <td>${quote.warrantyDays || 90} days</td>
                    <td title="${createdByName}">${createdByShort}</td>
                    <td class="notes-cell">
                        ${quote.notes ? `<button data-action="view-notes" data-quote='${quoteData}'>View</button>` : '—'}
                    </td>
                    <td>${quote.soldPO || '—'}</td>
                    <td style="white-space: nowrap;">
                        <button class="action-button" data-action="edit-quote" data-quote='${quoteData}' title="Edit">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm.75 0a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Zm4.5.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0-.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Zm3.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0-.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" /></svg>
                        </button>
                        <button class="action-button create-order-btn" data-action="create-exchange" data-quote='${quoteData}' title="Create Exchange in AppSheet">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                        </button>
                    </td>
                `;
                row.innerHTML = cells;
            });
            
            if (includePn) {
                document.querySelectorAll('.quote-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', handleCheckboxChange);
                });
            }
        }

        // ===================================
        // STATUS CHANGE HANDLER
        // ===================================
        function handleStatusChange(event, quoteId) {
            const newStatus = event.target.value;
            const selectElement = event.target;
            
            database.ref('quotes/' + quoteId).update({ status: newStatus })
                .then(() => {
                    selectElement.style.borderColor = '#28a745';
                    setTimeout(() => {
                        selectElement.style.borderColor = '#d1d5db';
                    }, 1500);
                })
                .catch(error => {
                    console.error('Update failed:', error);
                    selectElement.style.borderColor = '#dc3545';
                    setTimeout(() => {
                        selectElement.style.borderColor = '#d1d5db';
                    }, 2000);
                });
        }
// ===================================
        // CHECKBOX SELECTION HANDLERS
        // ===================================
        function handleCheckboxChange(event) {
            const checkbox = event.target;
            const quoteId = checkbox.dataset.quoteId;
            
            if (checkbox.checked) {
                selectedQuotes.add(quoteId);
            } else {
                selectedQuotes.delete(quoteId);
            }
            
            updateSelectedCount();
            updateSelectAllCheckbox();
        }

        function updateSelectedCount() {
            const count = selectedQuotes.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('copyCount').textContent = count;
            document.getElementById('bulkOrderCount').textContent = count;
            document.getElementById('generatePdfButton').disabled = count === 0;
            document.getElementById('copySelectedButton').disabled = count === 0;
            document.getElementById('createBulkOrdersButton').disabled = count === 0;
        }

        function handleSelectAll(event) {
            const isChecked = event.target.checked;
            const checkboxes = document.querySelectorAll('.quote-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                const quoteId = checkbox.dataset.quoteId;
                
                if (isChecked) {
                    selectedQuotes.add(quoteId);
                } else {
                    selectedQuotes.delete(quoteId);
                }
            });
            
            updateSelectedCount();
        }

        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.quote-checkbox');
            const checkedBoxes = document.querySelectorAll('.quote-checkbox:checked');
            
            if (checkboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedBoxes.length === checkboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedBoxes.length > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }

        // ===================================
        // COPY SELECTED QUOTES
        // ===================================
        function copySelectedQuotes() {
            if (selectedQuotes.size === 0) {
                alert('Please select at least one quote to copy.');
                return;
            }
            
            const selected = allQuotesCache.filter(q => selectedQuotes.has(q.id));
            
            let copyText = '';
            
            selected.forEach((quote, index) => {
                copyText += `Item ${index + 1}:\n`;
                copyText += `Name: ${quote.itemName || 'N/A'}\n`;
                copyText += `PN: ${quote.pn || 'N/A'}\n`;
                
                if (quote.exchangePrice) {
                    copyText += `Exchange Price: ${formatPrice(quote.exchangePrice)}\n`;
                }
                if (quote.outrightPrice) {
                    copyText += `Outright Price: ${formatPrice(quote.outrightPrice)}\n`;
                }
                copyText += `Warranty: ${quote.warrantyDays || 90} days\n`;
                if (quote.notes && quote.notes.trim() !== '') {
                    copyText += `Notes: ${quote.notes}\n`;
                }
                
                copyText += '\n';
            });
            
            navigator.clipboard.writeText(copyText).then(() => {
                const button = document.getElementById('copySelectedButton');
                const originalText = button.innerHTML;
                button.innerHTML = `Copied! (${selected.length})`;
                button.style.backgroundColor = '#28a745';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.backgroundColor = '';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard. Please try again.');
            });
        }

// ===================================
// EDIT QUOTE MODAL
// ===================================
function openEditModal(quote) {
    const modal = document.getElementById('editModal');
    document.getElementById('editQuoteId').value = quote.id;
    
    const quoteDate = new Date(quote.date);
    const formattedDate = quoteDate.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
    
    const itemInfo = document.getElementById('editItemInfo');
    itemInfo.textContent = `Quoted: ${formattedDate} • ${quote.itemName || 'N/A'} • PN: ${quote.pn || 'N/A'}`;
    
    const createdByInfo = document.getElementById('editCreatedByInfo');
    const createdBy = quote.createdByName || quote.createdByEmail || 'Unknown';
    createdByInfo.textContent = `Created by: ${createdBy}`;
    
    // Set the date input field
    const dateForInput = quote.date.split('T')[0];
    document.getElementById('editDate').value = dateForInput;
    
    const soldToSelect = document.getElementById('editSoldTo');
    soldToSelect.innerHTML = '';
    soldListCache.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        if (name === quote.sold) option.selected = true;
        soldToSelect.appendChild(option);
    });
    
    const outright = quote.outrightPrice ? quote.outrightPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '';
    const exchange = quote.exchangePrice ? quote.exchangePrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '';
    
    document.getElementById('editItemName').value = quote.itemName || '';
    document.getElementById('editPartNumber').value = quote.pn || '';
    document.getElementById('editOutrightPrice').value = outright;
    document.getElementById('editExchangePrice').value = exchange;
    document.getElementById('editStatus').value = quote.status;
    document.getElementById('editNotes').value = quote.notes || '';
            document.getElementById('editSoldPO').value = quote.soldPO || '';
    
    const warrantyDays = quote.warrantyDays || 90;
    if ([30, 60, 90].includes(warrantyDays)) {
        document.getElementById('editWarrantyDays').value = warrantyDays;
        document.getElementById('editCustomWarrantyGroup').style.display = 'none';
    } else {
        document.getElementById('editWarrantyDays').value = 'custom';
        document.getElementById('editCustomWarranty').value = warrantyDays;
        document.getElementById('editCustomWarrantyGroup').style.display = 'block';
    }
    
    modal.classList.add('visible');
    document.body.classList.add('modal-open');
}

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('visible');
            document.body.classList.remove('modal-open');
        }

 async function handleEditFormSubmit() {
            const quoteId = document.getElementById('editQuoteId').value;
            if (!quoteId) return;
            
            const quoteSnapshot = await database.ref('quotes/' + quoteId).once('value');
            const originalQuote = quoteSnapshot.val();
            
            const canEdit = currentUserData.role === 'Admin' || 
                           (currentUserData.role === 'Sales Rep' && originalQuote.createdBy === currentUser.uid);
            
            if (!canEdit) {
                alert('You do not have permission to edit this quote. Only admins or the quote creator can edit quotes.');
                closeEditModal();
                return;
            }
            
            const outrightPriceValue = document.getElementById('editOutrightPrice').value.replace(/,/g, '');
            const exchangePriceValue = document.getElementById('editExchangePrice').value.replace(/,/g, '');
            
            const updatedQuote = {
                itemName: document.getElementById('editItemName').value,
                pn: document.getElementById('editPartNumber').value,
                sold: document.getElementById('editSoldTo').value,
                outrightPrice: outrightPriceValue ? parseFloat(outrightPriceValue) : null,
                exchangePrice: exchangePriceValue ? parseFloat(exchangePriceValue) : null,
                status: document.getElementById('editStatus').value,
                warrantyDays: getEditWarrantyDays(),
                notes: document.getElementById('editNotes').value,
                soldPO: document.getElementById('editSoldPO').value,
                date: new Date(document.getElementById('editDate').value).toISOString(),
                lastModifiedBy: currentUser.uid,
                lastModifiedByEmail: currentUser.email,
                lastModifiedByName: currentUserData.name,
                lastModifiedAt: new Date().toISOString()
            };
            
            try {
                // Save to Firebase
                await database.ref('quotes/' + quoteId).update(updatedQuote);
                
                // Log the activity
                await logActivity('edit_quote', quoteId, `Edited quote for ${updatedQuote.itemName} (${updatedQuote.pn}) - ${updatedQuote.sold}`);
                
                // *** NEW FIX: Manually update the local cache to prevent race conditions ***
                const index = allQuotesCache.findIndex(q => q.id === quoteId);
                if (index > -1) {
                    // Merge new data into the old quote object
                    allQuotesCache[index] = { ...allQuotesCache[index], ...updatedQuote, id: quoteId };
                    
                    // Immediately re-render the search table with the fresh data
                    const searchTerm = document.getElementById('quoteSearchInput').value;
                    if(searchTerm) {
                        filterAndDisplayQuotes(searchTerm);
                    } else {
                        const displayQuotes = getQuotesToDisplay();
                        renderHistoryTable(document.getElementById('searchHistoryBody'), displayQuotes, true);
                    }
                }
                
                closeEditModal();
            } catch (error) {
                console.error("Error updating quote:", error);
                alert("Failed to update quote. See console for details.");
            }
        }

        async function handleDeleteQuote() {
            const quoteId = document.getElementById('editQuoteId').value;
            if (!quoteId) return;
            
            const quoteSnapshot = await database.ref('quotes/' + quoteId).once('value');
            const originalQuote = quoteSnapshot.val();
            
            const canDelete = currentUserData.role === 'Admin' || 
                             (currentUserData.role === 'Sales Rep' && originalQuote.createdBy === currentUser.uid);
            
            if (!canDelete) {
                alert('You do not have permission to delete this quote. Only admins or the quote creator can delete quotes.');
                return;
            }
            
            if (confirm("Are you sure you want to delete this quote permanently?")) {
                try {
                    await logActivity('delete_quote', quoteId, `Deleted quote for ${originalQuote.itemName} (${originalQuote.pn}) - ${originalQuote.sold}`);
                    
                    await database.ref('quotes/' + quoteId).remove();
                    closeEditModal();
                } catch (error) {
                    console.error("Error deleting quote:", error);
                    alert("Failed to delete quote. See console for details.");
                }
            }
        }

        function closeViewQuoteModal() {
            document.getElementById('viewQuoteModal').classList.remove('active');
        }
// ===================================
        // MODAL HELPER FUNCTIONS (NEW)
        // ===================================
        function updateSelectionDisplay(quoteId, radioElement) {
            const display = document.getElementById(`display-${quoteId}`);
            // Get the text from the <label> that the radio button is inside of
            const labelText = radioElement.parentElement.textContent.trim(); 
            display.textContent = `Selected: ${labelText}`;
            
            // Auto-collapse
            const body = document.getElementById(`body-${quoteId}`);
            const icon = document.getElementById(`icon-${quoteId}`);
            body.classList.add('collapsed');
            icon.textContent = '▼';
        }

        function toggleSelectionGroup(quoteId) {
            const body = document.getElementById(`body-${quoteId}`);
            const icon = document.getElementById(`icon-${quoteId}`);
            body.classList.toggle('collapsed');
            icon.textContent = body.classList.contains('collapsed') ? '▼' : '▲';
        }

// ===================================
        // APPSHEET SIEMENS STOCK CACHE
        // ===================================
        async function getSiemensStockCache() {
            // Return cache if it already exists
            if (siemensStockCache) {
                return siemensStockCache;
            }

            const encodedTableName = encodeURIComponent(APPSHEET_CONFIG.TABLE_NAME); // This is "Siemens Stock"
            const API_URL = `https://api.appsheet.com/api/v2/apps/${APPSHEET_CONFIG.APP_ID}/tables/${encodedTableName}/Action`;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ApplicationAccessKey': APPSHEET_CONFIG.API_KEY
                    },
                    body: JSON.stringify({
                        "Action": "Find",
                        "Properties": {},
                        "Rows": []
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch Siemens Stock: ${response.statusText}`);
                }
                
                const data = await response.json();
                siemensStockCache = Array.isArray(data) ? data : []; // Store in cache
                return siemensStockCache;
            } catch (error) {
                console.error("Error fetching Siemens Stock:", error);
                return []; // Return empty on error
            }
        }

         async function fetchStockByPN(pn) {
            if (!pn) return [];
            const stock = await getSiemensStockCache();
            if (!stock) return [];
            
            const lowerPN = pn.toLowerCase();
            const pnColumnName = 'PN';
            const locationColumnName = 'Location'; // Using 'Location' column
            const forbiddenLocations = ['xgone', 'discarded', 'lost'];

            return stock.filter(item => {
                const itemPN = item[pnColumnName] ? item[pnColumnName].toLowerCase() : '';
                // 1. Check for PN match
                if (itemPN !== lowerPN) {
                    return false;
                }
                
                // 2. Check for forbidden locations
                const itemLocation = item[locationColumnName] ? item[locationColumnName].toLowerCase().trim() : '';
                if (forbiddenLocations.includes(itemLocation)) {
                    return false;
                }
                
                // If it passes both, include it
                return true;
            });
        }

        async function openItemSelectionModal(quotes) {
            currentQuotesForExchange = quotes;
            const modal = document.getElementById('selectItemNumberModal');
            const container = document.getElementById('itemSelectionContainer');
            
            modal.classList.add('visible');
            document.body.classList.add('modal-open');
            container.innerHTML = '<div class="spinner"></div>'; // Show loading spinner
            
            let allItemsHtml = '';
            // Create the new collapsible structure for each item
            for (const quote of quotes) {
                const quoteId = quote.id;
                allItemsHtml += `
                    <div class="item-selection-group" id="group-${quoteId}" style="margin-bottom: 12px; border: 1px solid #e5e7eb; border-radius: 8px;">
                        <div class="item-selection-header" onclick="toggleSelectionGroup('${quoteId}')">
                            <div>
                                <h4 style="color: #2d7a7f; margin-bottom: 4px;">${quote.itemName} (PN: ${quote.pn})</h4>
                                <p class="selected-item-display" id="display-${quoteId}">
                                    Loading options...
                                </p>
                            </div>
                            <span class="toggle-icon" id="icon-${quoteId}">▲</span>
                        </div>
                        <div class="item-selection-body" id="body-${quoteId}" style="padding: 0 16px 16px 16px;">
                            <div id="stock-list-${quoteId}">
                                <p style="color: #6b7280;">Loading matching stock...</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = allItemsHtml;

            // Using your column names from 'Siemens stock'
            const itemNumCol = 'index';
            const conditionCol = 'Condition / Notes'; // <-- FIX: Using correct column name
            const locationCol = 'Location';
            const verifiedCol = 'location verified date';

            // Now, asynchronously fetch and populate the stock for each item
            for (const quote of quotes) {
                const quoteId = quote.id;
                const stockListContainer = document.getElementById(`stock-list-${quoteId}`);
                const stockItems = await fetchStockByPN(quote.pn);
                const display = document.getElementById(`display-${quoteId}`);
                
                let stockHtml = '';
                if (stockItems && stockItems.length > 0) {
                    // Add the "Skip" option first, and check it by default
                    stockHtml += `
                        <div class="form-group" style="padding: 8px; background: #f9fafb; border-radius: 6px; border: 2px solid #3b82f6; margin-top: 12px;">
                            <label style="cursor: pointer; font-weight: bold; margin-bottom: 0;">
                                <input type="radio" name="item-select-${quoteId}" value="skip" checked 
                                       onchange="updateSelectionDisplay('${quoteId}', this)" 
                                       style="width: auto; margin-right: 8px;">
                                Skip (Don't assign an Item Number)
                            </label>
                        </div>
                    `;
                    // Set default display text
                    display.textContent = "Selected: Skip (Don't assign an Item Number)";
                    
                    // Add each matching stock item as a radio button
                    stockItems.forEach(item => {
                        const itemNum = item[itemNumCol] || 'N/A';
                        const condition = item[conditionCol] || 'N/A'; // <-- FIX: Using correct column
                        const location = item[locationCol] || 'N/A';
                        
                        // Handle the date formatting
                        let verifiedDate = 'N/A';
                        if (item[verifiedCol]) {
                            try {
                                verifiedDate = new Date(item[verifiedCol]).toLocaleDateString("en-US");
                            } catch (e) {
                                verifiedDate = item[verifiedCol]; // fallback to raw string
                            }
                        }
                        
                        // Using your requested labels
                        stockHtml += `
                            <div class="form-group" style="padding: 8px; background: #f9fafb; border-radius: 6px; margin-top: 8px;">
                                <label style="cursor: pointer; font-size: 14px; line-height: 1.5; display: block; margin-bottom: 0;">
                                    <input type="radio" name="item-select-${quoteId}" value="${itemNum}" 
                                           onchange="updateSelectionDisplay('${quoteId}', this)" 
                                           style="width: auto; margin-right: 8px;">
                                    <strong>Item:</strong> ${itemNum} | 
                                    <strong>Condition:</strong> ${condition} | 
                                    <strong>Location:</strong> ${location} | 
                                    <strong>Verrified Date:</strong> ${verifiedDate}
                                </label>
                            </div>
                        `;
                    });
                } else {
                    // No stock found
                    stockHtml = `
                        <p style="color: #92400e; background: #fef3c7; padding: 10px; border-radius: 6px; margin-top: 12px;">
                            No matching stock found for PN: ${quote.pn}. This exchange will be created without an Item Number.
                        </p>
                        <div class="form-group" style="display: none;">
                            <input type="radio" name="item-select-${quoteId}" value="skip" checked>
                        </div>
                    `;
                    // Set default display text
                    display.textContent = "No matching stock found";
                    // Auto-collapse this section since there are no choices
                    toggleSelectionGroup(quoteId);
                }
                stockListContainer.innerHTML = stockHtml;
            }
        }

        function closeItemSelectionModal() {
            const modal = document.getElementById('selectItemNumberModal');
            modal.classList.remove('visible');
            document.body.classList.remove('modal-open');
            currentQuotesForExchange = []; // Clear the items
        }

async function processAndSendExchanges() {
            // *** FIX for race condition ***
            const quotesToProcess = [...currentQuotesForExchange];
            
            if (quotesToProcess.length === 0) {
                return;
            }
            
            // Show loading message
            const loadingMessage = document.createElement('div');
            loadingMessage.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #2d7a7f; color: white; padding: 16px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; font-size: 14px;';
            loadingMessage.textContent = `Creating ${quotesToProcess.length} exchange(s)...`;
            document.body.appendChild(loadingMessage);
            
            // Close the selection modal
            closeItemSelectionModal();
            
            try {
                const exchangeRows = [];
                
                // Build the rows based on user's modal selections
                for (const quote of quotesToProcess) {
                    const selectedRadio = document.querySelector(`input[name="item-select-${quote.id}"]:checked`);
                    const selectedValue = selectedRadio ? selectedRadio.value : 'skip';
                    
                    // This uses the column name from your 'Exchanges' table screenshot
                    const itemNumberOut = (selectedValue === 'skip') ? "" : selectedValue;
                    
                    const outrightPrice = quote.outrightPrice ? parseFloat(quote.outrightPrice) : null;
                    const exchangePrice = quote.exchangePrice ? parseFloat(quote.exchangePrice) : null;
                    
                    // *** FIX: Check for valid customer and PN ***
                    const hasCustomer = quote.sold && quote.sold.trim() !== '';
                    const hasPartNumber = quote.pn && quote.pn !== 'N/A' && quote.pn.trim() !== '';
                    
                    if (!hasCustomer || !hasPartNumber) {
                        // This quote is invalid, skip it
                        console.warn(`Skipping quote ${quote.id}: Missing ${!hasCustomer ? 'customer' : 'part number'}.`);
                        continue; 
                    }
                    
                    // Build the row object for AppSheet
                    // These keys MUST match your 'Exchanges' table columns
                    const exchangeRow = {
                        "Sold to": quote.sold,
                        "PN Out": quote.pn || '',
                        "Item Number Inventory OUT": itemNumberOut
                    };
                    
                    // Add other fields from your 'Exchanges' table image
                    if (outrightPrice !== null && outrightPrice > 0) {
                        exchangeRow["Sold Outright Price"] = outrightPrice;
                    }
                    if (exchangePrice !== null && exchangePrice > 0) {
                        exchangeRow["Sold Exchange Price"] = exchangePrice;
                    }
                    if (quote.notes && quote.notes.trim() !== '') {
                        exchangeRow["Notes"] = quote.notes;
                    }
                    if (quote.soldPO && quote.soldPO.trim() !== '') {
                        exchangeRow["Sold PO"] = quote.soldPO;
                    }
                    
                    exchangeRows.push(exchangeRow);
                }
                
                if (exchangeRows.length === 0) {
                    // This will now only trigger if all selected quotes were invalid (e.g., all missing a PN)
                    throw new Error('No valid exchanges to create');
                }
                
                // Prepare data for AppSheet API
                const exchangeData = {
                    "Action": "Add",
                    "Properties": { "Locale": "en-US" },
                    "Rows": exchangeRows
                };
                
                const encodedTableName = encodeURIComponent(APPSHEET_CONFIG.EXCHANGES_TABLE); // "Exchanges" table
                const API_URL = `https://api.appsheet.com/api/v2/apps/${APPSHEET_CONFIG.APP_ID}/tables/${encodedTableName}/Action`;
                
                // Send to AppSheet
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ApplicationAccessKey': APPSHEET_CONFIG.API_KEY
                    },
                    body: JSON.stringify(exchangeData)
                });
                
                const responseText = await response.text();
                if (!response.ok) {
                    throw new Error(`AppSheet API Error: ${response.status} - ${responseText}`);
                }
                
                // Show success
                loadingMessage.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
                loadingMessage.innerHTML = `
                    ✓ ${exchangeRows.length} exchange(s) created!<br>
                    <span style="font-size: 12px; opacity: 0.9;">Check AppSheet to confirm details.</span>
                `;
                
                setTimeout(() => {
                    document.body.removeChild(loadingMessage);
                }, 5000);
                
            } catch (error) {
                console.error('Error creating bulk exchanges:', error);
                
                // Show error
                loadingMessage.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                loadingMessage.innerHTML = `
                    ✗ Failed to create exchanges<br>
                    <span style="font-size: 12px;">${error.message}</span>
                `;
                
                setTimeout(() => {
                    document.body.removeChild(loadingMessage);
                }, 5000);
            }
        }
         

        // ===================================
        // CREATE EXCHANGE FROM QUOTE
        // ===================================
        async function createExchangeFromQuote(quote) {
            // New logic: Open the item selection modal for just this one quote
            await openItemSelectionModal([quote]);
        }

 // ===================================
        // CREATE BULK EXCHANGES
        // ===================================
        async function createBulkExchanges() {
            if (selectedQuotes.size === 0) {
                alert('Please select at least one quote to create exchanges.');
                return;
            }
            
            const selected = allQuotesCache.filter(q => selectedQuotes.has(q.id));
            
            // New logic: Open the item selection modal for all selected quotes
            await openItemSelectionModal(selected);
        }
        // ===================================
        // PRICE HISTORY CHART
        // ===================================
        function calculatePriceHistory(pn) {
            if (!pn) return [];
            
            return allQuotesCache
                .filter(quote => quote.pn === pn)
                .map(quote => ({
                    date: new Date(quote.date),
                    outrightPrice: quote.outrightPrice || null,
                    exchangePrice: quote.exchangePrice || null,
                    status: quote.status
                }))
                .sort((a, b) => a.date - b.date);
        }

        function renderPriceHistoryChart(pn) {
            currentPriceHistoryPn = pn;
            const canvas = document.getElementById('priceHistoryChart');
            const noDataMessage = document.getElementById('noPriceHistoryMessage');
            
            const salesData = calculatePriceHistory(pn);
            
            if (salesData.length === 0) {
                canvas.style.display = 'none';
                noDataMessage.style.display = 'block';
                if (priceHistoryChart) {
                    priceHistoryChart.destroy();
                    priceHistoryChart = null;
                }
                return;
            }
            
            canvas.style.display = 'block';
            noDataMessage.style.display = 'none';
            
            const labels = salesData.map(d => d.date.toLocaleDateString());
            
            const quotedExchange = salesData.map(d => d.status === 'Quoted' ? d.exchangePrice : null);
            const quotedOutright = salesData.map(d => d.status === 'Quoted' ? d.outrightPrice : null);
            const soldExchange = salesData.map(d => d.status === 'Sold at Quoted Price Exchange' ? d.exchangePrice : null);
            const soldOutright = salesData.map(d => d.status === 'Sold at Quoted Price Outright' ? d.outrightPrice : null);
            const lostExchange = salesData.map(d => d.status === 'Lost Sale' ? d.exchangePrice : null);
            const lostOutright = salesData.map(d => d.status === 'Lost Sale' ? d.outrightPrice : null);
            
            const config = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Quoted - Exchange',
                            data: quotedExchange,
                            borderColor: '#3b82f6',
                            backgroundColor: '#3b82f6',
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            borderWidth: 2,
                            tension: 0,
                            spanGaps: false
                        },
                        {
                            label: 'Quoted - Outright',
                            data: quotedOutright,
                            borderColor: '#93c5fd',
                            backgroundColor: '#93c5fd',
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            borderWidth: 2,
                            tension: 0,
                            spanGaps: false
                        },
                        {
                            label: 'Sold - Exchange',
                            data: soldExchange,
                            borderColor: '#22c55e',
                            backgroundColor: '#22c55e',
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            borderWidth: 2,
                            tension: 0,
                            spanGaps: false
                        },
                        {
                            label: 'Sold - Outright',
                            data: soldOutright,
                            borderColor: '#4ade80',
                            backgroundColor: '#4ade80',
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            borderWidth: 2,
                            tension: 0,
                            spanGaps: false
                        },
                        {
                            label: 'Lost Sale - Exchange',
                            data: lostExchange,
                            borderColor: '#ef4444',
                            backgroundColor: '#ef4444',
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            borderWidth: 2,
                            tension: 0,
                            spanGaps: false
                        },
                        {
                            label: 'Lost Sale - Outright',
                            data: lostOutright,
                            borderColor: '#f87171',
                            backgroundColor: '#f87171',
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            borderWidth: 2,
                            tension: 0,
                            spanGaps: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'nearest',
                        intersect: false
                    },
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                font: { size: 10 },
                                boxWidth: 12,
                                padding: 8,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.parsed.y === null) return null;
                                    let label = context.dataset.label || '';
                                    label += ': $' + context.parsed.y.toLocaleString('en-US', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    });
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            };
            
            if (priceHistoryChart) {
                priceHistoryChart.destroy();
            }
            priceHistoryChart = new Chart(canvas, config);
            
            document.getElementById('priceHistorySearchInput').value = pn;
            
            setTimeout(() => {
                if (priceHistoryChart) {
                    priceHistoryChart.resize();
                    priceHistoryChart.update();
                }
            }, 100);
        }

        function handlePriceHistorySearch() {
            const searchInput = document.getElementById('priceHistorySearchInput');
            const pn = searchInput.value.trim();
            
            if (!pn) {
                alert('Please enter a part number');
                return;
            }
            
            renderPriceHistoryChart(pn);
        }

// ===================================
        // WEB SCRAPING FUNCTIONS
        // ===================================
        async function scrapeWebPrice(partNumber) {
            if (!partNumber || partNumber === 'N/A') {
                return null;
            }
            
            const url = WEB_SCRAPING_CONFIG.BASE_URL + partNumber;
            
            try {
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const html = await response.text();
                
                const purchaseType = extractPurchaseType(html);
                const prices = extractPrices(html, purchaseType);
                const imageUrl = extractImageUrl(html, partNumber);
                
                const result = {
                    partNumber: partNumber,
                    purchaseType: purchaseType,
                    outrightPrice: prices.outright,
                    exchangePrice: prices.exchange,
                    oemOutrightPrice: prices.oemOutright,
                    oemExchangePrice: prices.oemExchange,
                    imageUrl: imageUrl,
                    lastUpdated: new Date().toISOString(),
                    success: true
                };
                
                await saveWebPriceToCache(partNumber, result);
                
                return result;
                
            } catch (error) {
                console.error('Web scraping error:', error);
                return {
                    partNumber: partNumber,
                    success: false,
                    error: error.message,
                    lastUpdated: new Date().toISOString()
                };
            }
        }

        function extractPurchaseType(html) {
            const regex = /Purchase Type[:\s]+([A-Za-z]+)/i;
            const match = html.match(regex);
            return match ? match[1].trim() : 'N/A';
        }

      function extractPrices(html, purchaseType) {
            const prices = { 
                outright: null, 
                exchange: null,
                oemOutright: null,
                oemExchange: null
            };
            
            // PRIMARY REGEX: Original pattern for lbl-bold price class
            const priceRegex = /<span[^>]*class="[^"]*lbl-bold price[^"]*"[^>]*>\s*\$?([\d,]+\.?\d*)/gi;
            const matches = [];
            let match;
            
            while ((match = priceRegex.exec(html)) !== null) {
                const priceValue = parseFloat(match[1].replace(/,/g, ''));
                if (!isNaN(priceValue)) {
                    matches.push(priceValue);
                }
            }
            
            // FALLBACK REGEX 1: Look for any price-related class with dollar amounts
            if (matches.length === 0) {
                const fallbackRegex1 = /<span[^>]*class="[^"]*price[^"]*"[^>]*>\s*\$?([\d,]+\.?\d*)/gi;
                while ((match = fallbackRegex1.exec(html)) !== null) {
                    const priceValue = parseFloat(match[1].replace(/,/g, ''));
                    if (!isNaN(priceValue) && priceValue > 0) {
                        matches.push(priceValue);
                    }
                }
            }
            
            // FALLBACK REGEX 2: Look for dollar signs followed by numbers anywhere in spans
            if (matches.length === 0) {
                const fallbackRegex2 = /<span[^>]*>\s*\$\s*([\d,]+\.?\d*)/gi;
                while ((match = fallbackRegex2.exec(html)) !== null) {
                    const priceValue = parseFloat(match[1].replace(/,/g, ''));
                    if (!isNaN(priceValue) && priceValue > 10) {
                        matches.push(priceValue);
                    }
                }
            }
            
            // FALLBACK REGEX 3: Look for text patterns like "Price: $1,234.56" or "USD $1,234"
            if (matches.length === 0) {
                const fallbackRegex3 = /(?:price|cost|USD|your price)[:\s]*\$?\s*([\d,]+\.?\d*)/gi;
                while ((match = fallbackRegex3.exec(html)) !== null) {
                    const priceValue = parseFloat(match[1].replace(/,/g, ''));
                    if (!isNaN(priceValue) && priceValue > 10) {
                        matches.push(priceValue);
                    }
                }
            }
            
            // FALLBACK REGEX 4: Look in div elements with price-related classes
            if (matches.length === 0) {
                const fallbackRegex4 = /<div[^>]*class="[^"]*price[^"]*"[^>]*>[^<]*\$?\s*([\d,]+\.?\d*)/gi;
                while ((match = fallbackRegex4.exec(html)) !== null) {
                    const priceValue = parseFloat(match[1].replace(/,/g, ''));
                    if (!isNaN(priceValue) && priceValue > 10) {
                        matches.push(priceValue);
                    }
                }
            }
            
            console.log('Price extraction - Found matches:', matches);
            console.log('Purchase type:', purchaseType);
            
            // Sort prices to identify refurb vs OEM (typically refurb is lower)
            const sortedMatches = [...matches].sort((a, b) => a - b);
            
            if (purchaseType.toUpperCase() === 'EXCHANGE') {
                // For EXCHANGE type, expect up to 4 prices:
                // [0] = Refurb Exchange (lowest)
                // [1] = Refurb Outright
                // [2] = OEM Exchange
                // [3] = OEM Outright (highest)
                if (sortedMatches.length >= 1) prices.exchange = sortedMatches[0];
                if (sortedMatches.length >= 2) prices.outright = sortedMatches[1];
                if (sortedMatches.length >= 3) prices.oemExchange = sortedMatches[2];
                if (sortedMatches.length >= 4) prices.oemOutright = sortedMatches[3];
            } else if (purchaseType.toUpperCase() === 'OUTRIGHT') {
                // For OUTRIGHT type, expect up to 2 prices:
                // [0] = Refurb Outright (lower)
                // [1] = OEM Outright (higher)
                if (sortedMatches.length >= 1) prices.outright = sortedMatches[0];
                if (sortedMatches.length >= 2) prices.oemOutright = sortedMatches[1];
             } else {
                // Unknown type - intelligently assign based on number of prices found
                if (sortedMatches.length === 1) {
                    // Only 1 price - assume it's refurb outright
                    prices.outright = sortedMatches[0];
                } else if (sortedMatches.length === 2) {
                    // 2 prices - assume refurb and OEM outright
                    prices.outright = sortedMatches[0];
                    prices.oemOutright = sortedMatches[1];
                } else if (sortedMatches.length >= 3) {
                    // 3+ prices - assume: refurb outright, OEM exchange, OEM outright
                    prices.outright = sortedMatches[0];
                    prices.oemExchange = sortedMatches[1];
                    prices.oemOutright = sortedMatches[2];
                }
            }
            
            console.log('Final extracted prices:', prices);
            return prices;
        }
            
             


        function extractImageUrl(html, partNumber) {
            // Regex to find all src attributes from img tags.
            // This is more robust and acts like the VB.NET loop.
            const imgRegex = /<img[^>]+src=["']?([^"'>\s]+)["']?/gi;
            let match;
            const lowerPn = partNumber.toLowerCase();

            // Loop through all image tags found in the HTML
            while ((match = imgRegex.exec(html)) !== null) {
                const src = match[1]; // Get the URL (capture group 1)
                
                if (!src) continue; // Skip if src is empty

                const lowerSrc = src.toLowerCase();

                // Skip common tracking/ad pixels (like in the VB code)
                if (lowerSrc.includes('adroll') || lowerSrc.includes('pixel')) {
                    continue;
                }
                
                // Check if the src contains both the part number and "dam"
                if (lowerSrc.includes(lowerPn) && lowerSrc.includes('dam')) {
                    // Found a match. Handle relative URLs (e.g., /path/image.jpg)
                    if (src.startsWith('/')) {
                        // Prepend the domain to make it an absolute URL
                        return 'https://www.partssource.com' + src;
                    }
                    // It's already an absolute URL (e.g., https://...)
                    return src;
                }
            }
            
            return ''; // No match found after checking all images
        }

        async function saveWebPriceToCache(partNumber, priceData) {
            try {
                if (!currentUser) {
                    console.warn('No authenticated user - skipping database save');
                    webPriceCache[partNumber] = priceData;
                    return;
                }
                await database.ref(`webPriceCache/${partNumber}`).set(priceData);
                webPriceCache[partNumber] = priceData;
            } catch (error) {
                console.warn('Could not save to database, using memory cache only:', error.message);
                webPriceCache[partNumber] = priceData;
            }
        }

        async function getWebPriceFromCache(partNumber) {
            if (webPriceCache[partNumber]) {
                return webPriceCache[partNumber];
            }
            
            if (!currentUser) {
                return null;
            }
            
            try {
                const snapshot = await database.ref(`webPriceCache/${partNumber}`).once('value');
                const data = snapshot.val();
                
                if (data) {
                    webPriceCache[partNumber] = data;
                    return data;
                }
            } catch (error) {
                console.warn('Could not read from database cache:', error.message);
            }
            
            return null;
        }

        async function displayWebPrice(partNumber) {
            const section = document.getElementById('webPricingSection');
            const content = document.getElementById('webPriceContent');
            const refreshBtn = document.getElementById('refreshPriceBtn');
            
            // Also handle image display
            displayProductImage(partNumber);
            
            if (!partNumber || partNumber === 'N/A') {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            content.innerHTML = '<p style="margin: 0; color: #6b7280; font-size: 14px;">Loading web price...</p>';
            refreshBtn.disabled = true;
            
            const cachedPrice = await getWebPriceFromCache(partNumber);
            
            // AUTO-FETCH: If no cached price exists, automatically fetch it (like VB.NET Timer behavior)
            if (!cachedPrice || !cachedPrice.success) {
                console.log('No cached price found, auto-fetching...');
                await refreshWebPrice(true); // Silent auto-fetch
                return; // refreshWebPrice will call displayWebPrice again after fetching
            }
            
            if (cachedPrice && cachedPrice.success) {
                const lastUpdated = new Date(cachedPrice.lastUpdated);
                const ageInDays = (Date.now() - lastUpdated.getTime()) / (1000 * 60 * 60 * 24);
                const ageText = ageInDays < 1 ? 'today' : `${Math.floor(ageInDays)} days ago`;
                
                let html = '<div>';
                html += `<p style="margin: 0 0 8px 0; color: #374151; font-weight: 600; font-size: 14px;">Purchase Type: ${cachedPrice.purchaseType}</p>`;
                
                // Refurbished Prices Section
                if (cachedPrice.outrightPrice || cachedPrice.exchangePrice) {
                    html += `<p style="margin: 8px 0 4px 0; color: #2d7a7f; font-weight: 600; font-size: 13px;">Refurbished:</p>`;
                    if (cachedPrice.exchangePrice) {
                        html += `<p style="margin: 0 0 4px 0; padding-left: 12px; color: #374151; font-size: 14px;"><strong>Exchange:</strong> ${formatPrice(cachedPrice.exchangePrice)}</p>`;
                    }
                    if (cachedPrice.outrightPrice) {
                        html += `<p style="margin: 0 0 4px 0; padding-left: 12px; color: #374151; font-size: 14px;"><strong>Outright:</strong> ${formatPrice(cachedPrice.outrightPrice)}</p>`;
                    }
                }
                
                // OEM New Prices Section
                if (cachedPrice.oemOutrightPrice || cachedPrice.oemExchangePrice) {
                    html += `<p style="margin: 8px 0 4px 0; color: #f39237; font-weight: 600; font-size: 13px;">OEM New:</p>`;
                    if (cachedPrice.oemExchangePrice) {
                        html += `<p style="margin: 0 0 4px 0; padding-left: 12px; color: #374151; font-size: 14px;"><strong>Exchange:</strong> ${formatPrice(cachedPrice.oemExchangePrice)}</p>`;
                    }
                    if (cachedPrice.oemOutrightPrice) {
                        html += `<p style="margin: 0 0 4px 0; padding-left: 12px; color: #374151; font-size: 14px;"><strong>Outright:</strong> ${formatPrice(cachedPrice.oemOutrightPrice)}</p>`;
                    }
                }
                
                const color = ageInDays > 7 ? '#f59e0b' : (ageInDays > 3 ? '#f97316' : '#22c55e');
                html += `<p style="margin: 8px 0 0 0; color: ${color}; font-size: 12px; font-style: italic;">Updated: ${lastUpdated.toLocaleDateString()} (${ageText})</p>`;
                html += '</div>';
                
                content.innerHTML = html;
                // Store the current price data in the content element for persistence
                content.dataset.lastPrice = JSON.stringify({
                    purchaseType: cachedPrice.purchaseType,
                    outrightPrice: cachedPrice.outrightPrice,
                    exchangePrice: cachedPrice.exchangePrice,
                    oemOutrightPrice: cachedPrice.oemOutrightPrice,
                    oemExchangePrice: cachedPrice.oemExchangePrice,
                    lastUpdated: cachedPrice.lastUpdated
                });
                refreshBtn.disabled = false;
                
                if (ageInDays > WEB_SCRAPING_CONFIG.AUTO_REFRESH_DAYS) {
                    setTimeout(() => refreshWebPrice(true), 1000);
                }
            } else {
                // Check if we have a previously stored price to preserve
                const lastPriceData = content.dataset.lastPrice;
                if (lastPriceData) {
                    try {
                        const lastPrice = JSON.parse(lastPriceData);
                        const lastUpdated = new Date(lastPrice.lastUpdated);
                        const ageInDays = (Date.now() - lastUpdated.getTime()) / (1000 * 60 * 60 * 24);
                        const ageText = ageInDays < 1 ? 'today' : `${Math.floor(ageInDays)} days ago`;
                        
                        let html = '<div style="background: #fef3c7; padding: 12px; border-radius: 6px; border: 1px solid #fbbf24;">';
                        html += `<p style="margin: 0 0 8px 0; color: #92400e; font-weight: 600; font-size: 14px;">⚠️ Price from ${lastUpdated.toLocaleDateString()}</p>`;
                        html += `<p style="margin: 0 0 4px 0; color: #92400e; font-size: 13px;"><em>PartsSource currently unavailable - showing last known price:</em></p>`;
                        html += `<p style="margin: 0 0 8px 0; color: #374151; font-weight: 600; font-size: 14px;">Purchase Type: ${lastPrice.purchaseType}</p>`;
                        
                        if (lastPrice.outrightPrice) {
                            html += `<p style="margin: 0 0 4px 0; color: #374151; font-size: 14px;"><strong>Outright:</strong> ${formatPrice(lastPrice.outrightPrice)}</p>`;
                        }
                        
                        // Refurbished Prices
                        if (lastPrice.outrightPrice || lastPrice.exchangePrice) {
                            html += `<p style="margin: 8px 0 4px 0; color: #2d7a7f; font-weight: 600; font-size: 13px;">Refurbished:</p>`;
                            if (lastPrice.exchangePrice) {
                                html += `<p style="margin: 0 0 4px 0; padding-left: 12px; color: #374151; font-size: 14px;"><strong>Exchange:</strong> ${formatPrice(lastPrice.exchangePrice)}</p>`;
                            }
                            if (lastPrice.outrightPrice) {
                                html += `<p style="margin: 0 0 4px 0; padding-left: 12px; color: #374151; font-size: 14px;"><strong>Outright:</strong> ${formatPrice(lastPrice.outrightPrice)}</p>`;
                            }
                        }
                        
                        // OEM New Prices
                        if (lastPrice.oemOutrightPrice || lastPrice.oemExchangePrice) {
                            html += `<p style="margin: 8px 0 4px 0; color: #f39237; font-weight: 600; font-size: 13px;">OEM New:</p>`;
                            if (lastPrice.oemExchangePrice) {
                                html += `<p style="margin: 0 0 4px 0; padding-left: 12px; color: #374151; font-size: 14px;"><strong>Exchange:</strong> ${formatPrice(lastPrice.oemExchangePrice)}</p>`;
                            }
                            if (lastPrice.oemOutrightPrice) {
                                html += `<p style="margin: 0 0 4px 0; padding-left: 12px; color: #374151; font-size: 14px;"><strong>Outright:</strong> ${formatPrice(lastPrice.oemOutrightPrice)}</p>`;
                            }
                        }
                        
                        html += `<p style="margin: 8px 0 0 0; color: #92400e; font-size: 11px; font-style: italic;">Price cached from ${ageText}</p>`;
                        html += '</div>';
                        
                        content.innerHTML = html;
                    } catch (e) {
                        content.innerHTML = '<p style="margin: 0; color: #6b7280; font-size: 14px;">Web price: Not available <span style="color: #ef4444;">[Click Refresh to load]</span></p>';
                    }
                } else {
                    content.innerHTML = '<p style="margin: 0; color: #6b7280; font-size: 14px;">Web price: Not available <span style="color: #ef4444;">[Click Refresh to load]</span></p>';
                }
                refreshBtn.disabled = false;
            }
        }
// ===================================
        // PN-SPECIFIC VENDOR PRICING FUNCTIONS
        // ===================================
        async function loadPnPricingNotes(partNumber) {
            const section = document.getElementById('pnPricingNotesSection');
            const tableBody = document.getElementById('pnPricingTableBody');
            
            if (!partNumber || partNumber === 'N/A') {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            try {
                const snapshot = await database.ref(`pnPricingNotes/${partNumber}`).once('value');
                const pricesData = snapshot.val();
                
                if (pricesData && pricesData.prices && pricesData.prices.length > 0) {
                    renderPricingTable(pricesData.prices);
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" style="padding: 20px; text-align: center; color: #9ca3af; font-size: 14px;">
                                No vendor prices added yet. Click "+ Add Price" to add one.
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading PN pricing notes:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="padding: 20px; text-align: center; color: #991b1b; font-size: 14px;">
                            Error loading prices
                        </td>
                    </tr>
                `;
            }
        }

        function renderPricingTable(prices) {
            const tableBody = document.getElementById('pnPricingTableBody');
            
            // Sort by date descending (newest first)
            const sortedPrices = prices.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tableBody.innerHTML = sortedPrices.map((price, index) => {
                const formattedDate = new Date(price.date).toLocaleDateString();
                const exchangePrice = price.exchangePrice ? formatPrice(price.exchangePrice) : '—';
                const outrightPrice = price.outrightPrice ? formatPrice(price.outrightPrice) : '—';
                
                return `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 10px 8px; font-size: 13px; color: #374151;">${formattedDate}</td>
                        <td style="padding: 10px 8px; font-size: 13px; color: #374151; font-weight: 500;">${price.vendor}</td>
                        <td style="padding: 10px 8px; font-size: 13px; color: #374151; text-align: right;">${exchangePrice}</td>
                        <td style="padding: 10px 8px; font-size: 13px; color: #374151; text-align: right;">${outrightPrice}</td>
                        <td style="padding: 10px 8px; text-align: center;">
                            ${price.notes ? `<button onclick="viewPriceNotes(${index})" style="background: none; border: none; color: #2d7a7f; cursor: pointer; font-size: 12px; padding: 4px 8px; text-decoration: underline;" title="${price.notes}">Notes</button>` : ''}
                            <button onclick="deletePriceEntry(${index})" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 18px; padding: 4px;" title="Delete">×</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showAddPriceModal() {
            const modal = document.getElementById('addPriceModal');
            modal.classList.add('visible');
            document.body.classList.add('modal-open');
            
            // Set today's date as default
            document.getElementById('priceDate').valueAsDate = new Date();
            document.getElementById('addPriceForm').reset();
            document.getElementById('priceDate').valueAsDate = new Date();
        }

        function closeAddPriceModal() {
            document.getElementById('addPriceModal').classList.remove('visible');
            document.body.classList.remove('modal-open');
        }

// ===================================
        // VIEW PRICE NOTES FUNCTION
        // ===================================
        async function viewPriceNotes(index) {
            const partNumber = document.getElementById('partNumber').textContent;
            
            try {
                const snapshot = await database.ref(`pnPricingNotes/${partNumber}`).once('value');
                const pricesData = snapshot.val();
                
                if (pricesData && pricesData.prices && pricesData.prices[index]) {
                    const price = pricesData.prices[index];
                    alert(`Notes for ${price.vendor} (${new Date(price.date).toLocaleDateString()}):\n\n${price.notes || 'No notes'}`);
                }
            } catch (error) {
                console.error('Error viewing price notes:', error);
                alert('Error loading notes');
            }
        }

        // ===================================
        // DELETE PRICE ENTRY FUNCTION
        // ===================================
        async function deletePriceEntry(index) {
            const partNumber = document.getElementById('partNumber').textContent;
            
            if (!confirm('Are you sure you want to delete this price entry?')) {
                return;
            }
            
            try {
                const snapshot = await database.ref(`pnPricingNotes/${partNumber}`).once('value');
                const pricesData = snapshot.val();
                
                if (pricesData && pricesData.prices) {
                    pricesData.prices.splice(index, 1);
                    
                    await database.ref(`pnPricingNotes/${partNumber}`).set(pricesData);
                    
                    // Reload the pricing table
                    loadPnPricingNotes(partNumber);
                    
                    await logActivity('delete_vendor_price', partNumber, `Deleted vendor price #${index + 1}`);
                }
            } catch (error) {
                console.error('Error deleting price entry:', error);
                alert('Error deleting price entry: ' + error.message);
            }
        }

        // ===================================
        // SHOW ALL PRICES MODAL FUNCTION
        // ===================================
        async function showAllPricesModal() {
            const partNumber = document.getElementById('partNumber').textContent;
            
            if (!partNumber || partNumber === 'N/A') {
                alert('No part number selected');
                return;
            }
            
            const modal = document.getElementById('allPricesModal');
            const content = document.getElementById('allPricesContent');
            const pnDisplay = document.getElementById('allPricesPN');
            
            pnDisplay.textContent = partNumber;
            
            try {
                const snapshot = await database.ref(`pnPricingNotes/${partNumber}`).once('value');
                const pricesData = snapshot.val();
                
                if (pricesData && pricesData.prices && pricesData.prices.length > 0) {
                    const sortedPrices = pricesData.prices.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    let html = '<table style="width: 100%; border-collapse: collapse;">';
                    html += '<thead><tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">';
                    html += '<th style="padding: 12px 8px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280;">DATE</th>';
                    html += '<th style="padding: 12px 8px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280;">VENDOR</th>';
                    html += '<th style="padding: 12px 8px; text-align: right; font-size: 12px; font-weight: 600; color: #6b7280;">EXCHANGE</th>';
                    html += '<th style="padding: 12px 8px; text-align: right; font-size: 12px; font-weight: 600; color: #6b7280;">OUTRIGHT</th>';
                    html += '<th style="padding: 12px 8px; text-align: center; font-size: 12px; font-weight: 600; color: #6b7280;">NOTES</th>';
                    html += '</tr></thead><tbody>';
                    
                    sortedPrices.forEach((price, index) => {
                        const formattedDate = new Date(price.date).toLocaleDateString();
                        const exchangePrice = price.exchangePrice ? formatPrice(price.exchangePrice) : '—';
                        const outrightPrice = price.outrightPrice ? formatPrice(price.outrightPrice) : '—';
                        
                        html += `<tr style="border-bottom: 1px solid #e5e7eb;">`;
                        html += `<td style="padding: 10px 8px; font-size: 13px; color: #374151;">${formattedDate}</td>`;
                        html += `<td style="padding: 10px 8px; font-size: 13px; color: #374151; font-weight: 500;">${price.vendor}</td>`;
                        html += `<td style="padding: 10px 8px; font-size: 13px; color: #374151; text-align: right;">${exchangePrice}</td>`;
                        html += `<td style="padding: 10px 8px; font-size: 13px; color: #374151; text-align: right;">${outrightPrice}</td>`;
                        html += `<td style="padding: 10px 8px; text-align: center;">`;
                        html += price.notes ? `<span style="color: #2d7a7f; font-size: 12px;" title="${price.notes}">📝</span>` : '—';
                        html += `</td></tr>`;
                    });
                    
                    html += '</tbody></table>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 40px;">No prices available for this part number.</p>';
                }
                
                modal.classList.add('visible');
                document.body.classList.add('modal-open');
                
            } catch (error) {
                console.error('Error loading all prices:', error);
                content.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 40px;">Error loading prices</p>';
            }
        }

        async function saveVendorPrice() {
            const partNumber = document.getElementById('partNumber').textContent;
            
            if (!partNumber || partNumber === 'N/A') {
                alert('No part number selected');
                return;
            }
            
            const date = document.getElementById('priceDate').value;
            const vendor = document.getElementById('priceVendor').value.trim();
            const exchangeValue = document.getElementById('priceExchange').value.replace(/,/g, '');
            const outrightValue = document.getElementById('priceOutright').value.replace(/,/g, '');
            const notes = document.getElementById('priceNotes').value.trim();
            
            if (!date || !vendor) {
                alert('Please fill in Date and Vendor');
                return;
            }
            
            if (!exchangeValue && !outrightValue) {
                alert('Please enter at least one price (Exchange or Outright)');
                return;
            }
            
            const newPrice = {
                date: date,
                vendor: vendor,
                exchangePrice: exchangeValue ? parseFloat(exchangeValue) : null,
                outrightPrice: outrightValue ? parseFloat(outrightValue) : null,
                notes: notes || null,
                addedBy: currentUserData?.name || 'Unknown',
                addedAt: new Date().toISOString()
            };
            
            try {
                const snapshot = await database.ref(`pnPricingNotes/${partNumber}`).once('value');
                const existingData = snapshot.val() || { prices: [] };
                
                if (!existingData.prices) {
                    existingData.prices = [];
                }
                
                existingData.prices.push(newPrice);
                
                await database.ref(`pnPricingNotes/${partNumber}`).set(existingData);
                
                closeAddPriceModal();
                await loadPnPricingNotes(partNumber);
                
                const successMsg = document.createElement('div');
                successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #22c55e; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; font-size: 14px;';
                successMsg.textContent = '✓ Vendor price added!';
                document.body.appendChild(successMsg);
                
                setTimeout(() => document.body.removeChild(successMsg), 2000);
                
            } catch (error) {
                console.error('Error saving vendor price:', error);
                alert('Failed to save vendor price');
            }
        }

        async function deletePriceEntry(index) {
            const partNumber = document.getElementById('partNumber').textContent;
            
            if (!confirm('Delete this price entry?')) {
                return;
            }
            
            try {
                const snapshot = await database.ref(`pnPricingNotes/${partNumber}`).once('value');
                const existingData = snapshot.val();
                
                if (existingData && existingData.prices) {
                    existingData.prices.splice(index, 1);
                    
                    if (existingData.prices.length === 0) {
                        await database.ref(`pnPricingNotes/${partNumber}`).remove();
                    } else {
                        await database.ref(`pnPricingNotes/${partNumber}`).set(existingData);
                    }
                    
                    await loadPnPricingNotes(partNumber);
                    
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #22c55e; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; font-size: 14px;';
                    successMsg.textContent = '✓ Price entry deleted!';
                    document.body.appendChild(successMsg);
                    
                    setTimeout(() => document.body.removeChild(successMsg), 2000);
                }
            } catch (error) {
                console.error('Error deleting price entry:', error);
                alert('Failed to delete price entry');
            }
        }

        function viewPriceNotes(index) {
            const partNumber = document.getElementById('partNumber').textContent;
            
            database.ref(`pnPricingNotes/${partNumber}`).once('value').then(snapshot => {
                const data = snapshot.val();
                if (data && data.prices && data.prices[index] && data.prices[index].notes) {
                    alert(`Notes:\n\n${data.prices[index].notes}`);
                }
            });
        }        function displayProductImage(partNumber) {
            const imageSection = document.getElementById('productImageSection');
            const imageElement = document.getElementById('productImage');
            const noImageMessage = document.getElementById('noImageMessage');
            const imageExpandable = document.getElementById('imageExpandable');
            const summary = imageExpandable ? imageExpandable.querySelector('summary') : null;
            
            if (!partNumber || partNumber === 'N/A') {
                imageSection.style.display = 'none';
                return;
            }
            
            imageSection.style.display = 'block';
            
            // Reset to collapsed state
            if (imageExpandable) {
                imageExpandable.open = false;
                if (summary) {
                    summary.innerHTML = '<span style="display: inline-block; margin-right: 8px;">▶</span>📷 Click to load Product Image';
                }
            }
            
            // Clear previous image
            imageElement.src = '';
            imageElement.style.display = 'none';
            noImageMessage.style.display = 'block';
            noImageMessage.textContent = 'Click above to load image';
        }
        
        // NEW FUNCTION: Load image on demand when expandable is opened
        function loadProductImageOnDemand(partNumber) {
            const imageElement = document.getElementById('productImage');
            const noImageMessage = document.getElementById('noImageMessage');
            const imageExpandable = document.getElementById('imageExpandable');
            const summary = imageExpandable ? imageExpandable.querySelector('summary') : null;
            
            if (summary) {
                summary.innerHTML = '<span style="display: inline-block; margin-right: 8px;">▼</span>📷 Loading image...';
            }
            
            noImageMessage.textContent = 'Loading...';
            noImageMessage.style.display = 'block';
            imageElement.style.display = 'none';
            
            // Check cache first
            getWebPriceFromCache(partNumber).then(cachedPrice => {
                if (cachedPrice && cachedPrice.imageUrl) {
                    const proxiedImageUrl = `https://corsproxy.io/?${encodeURIComponent(cachedPrice.imageUrl)}`;
                    imageElement.src = proxiedImageUrl;
                    imageElement.style.display = 'block';
                    noImageMessage.style.display = 'none';
                    
                    if (summary) {
                        summary.innerHTML = '<span style="display: inline-block; margin-right: 8px;">▼</span>📷 Product Image (click to collapse)';
                    }
                    
                    imageElement.onerror = function() {
                        imageElement.style.display = 'none';
                        noImageMessage.style.display = 'block';
                        noImageMessage.textContent = 'Image failed to load';
                        if (summary) {
                            summary.innerHTML = '<span style="display: inline-block; margin-right: 8px;">▼</span>📷 Image failed to load';
                        }
                    };
                } else {
                    imageElement.style.display = 'none';
                    noImageMessage.style.display = 'block';
                    noImageMessage.textContent = 'No image available';
                    if (summary) {
                        summary.innerHTML = '<span style="display: inline-block; margin-right: 8px;">▼</span>📷 No image available';
                    }
                }
            }).catch(error => {
                console.error('Error loading image:', error);
                imageElement.style.display = 'none';
                noImageMessage.style.display = 'block';
                noImageMessage.textContent = 'Error loading image';
                if (summary) {
                    summary.innerHTML = '<span style="display: inline-block; margin-right: 8px;">▼</span>📷 Error loading image';
                }
            });
        }


        async function refreshWebPrice(silent = false) {
            const partNumber = document.getElementById('partNumber').textContent;
            
            if (!partNumber || partNumber === 'N/A') {
                if (!silent) alert('No part number selected');
                return;
            }
            
            const content = document.getElementById('webPriceContent');
            const refreshBtn = document.getElementById('refreshPriceBtn');
            
            refreshBtn.disabled = true;
            refreshBtn.textContent = '⟳ Updating...';
            
            if (!silent) {
                content.innerHTML = '<p style="margin: 0; color: #6b7280; font-size: 14px;">Fetching current web price...</p>';
            }
            
            const result = await scrapeWebPrice(partNumber);
            
            if (result && result.success) {
                await displayWebPrice(partNumber);
                
                if (!silent) {
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #22c55e; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; font-size: 14px;';
                    successMsg.textContent = '✓ Web price updated successfully!';
                    document.body.appendChild(successMsg);
                    
                    setTimeout(() => document.body.removeChild(successMsg), 3000);
                }
            } else {
                content.innerHTML = `<p style="margin: 0; color: #ef4444; font-size: 14px;">Failed to fetch web price. ${result?.error || 'Unknown error'}</p>`;
            }
            
            refreshBtn.disabled = false;
            refreshBtn.textContent = '🔄 Refresh Price';
        }

        // ===================================
        // APPSHEET INTEGRATION
        // ===================================
        async function fetchCustomersFromAppSheet() {
            const customerSelect = document.getElementById('customer');
            const encodedTableName = encodeURIComponent(APPSHEET_CONFIG.TABLE_NAME);
            const API_URL = `https://api.appsheet.com/api/v2/apps/${APPSHEET_CONFIG.APP_ID}/tables/${encodedTableName}/Action`;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ApplicationAccessKey': APPSHEET_CONFIG.API_KEY
                    },
                    body: JSON.stringify({
                        "Action": "Find",
                        "Properties": {},
                        "Rows": []
                    })
                });
                
                if (!response.ok) throw new Error(`Failed to fetch customers: ${response.statusText}`);
                
                const data = await response.json();
                customerSelect.innerHTML = '<option value="" disabled selected>Select from Sold List...</option>';
                
                const customerNames = new Set();
                if (Array.isArray(data)) {
                    data.forEach(item => {
                        const customerName = item[APPSHEET_CONFIG.CUSTOMER_COLUMN];
                        if (customerName && customerName.trim() !== '') {
                            customerNames.add(customerName.trim());
                        }
                    });
                }
                
                const allCustomers = Array.from(customerNames);
                
                if (allQuotesCache.length > 0) {
                    const customerLastUsed = new Map();
                    
                    allQuotesCache.forEach(quote => {
                        if (quote.sold) {
                            const quoteDate = new Date(quote.date).getTime();
                            const existingDate = customerLastUsed.get(quote.sold);
                            
                            if (!existingDate || quoteDate > existingDate) {
                                customerLastUsed.set(quote.sold, quoteDate);
                            }
                        }
                    });
                    
                    allCustomers.sort((a, b) => {
                        const aDate = customerLastUsed.get(a) || 0;
                        const bDate = customerLastUsed.get(b) || 0;
                        
                        if (aDate === 0 && bDate === 0) {
                            return a.localeCompare(b);
                        }
                        if (aDate === 0) return 1;
                        if (bDate === 0) return -1;
                        
                        return bDate - aDate;
                    });
                } else {
                    allCustomers.sort();
                }
                
                soldListCache = allCustomers;
                
                allCustomers.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    customerSelect.appendChild(option);
                // Mirror the Sold list into the Vendor dropdown
                const vendorSelect = document.getElementById('priceVendor');
                if (vendorSelect) {
                    vendorSelect.innerHTML = '<option value="">-- Select Vendor --</option>';
                    soldListCache.forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        vendorSelect.appendChild(opt);
                    });
                }

                });
            } catch (error) {
                console.error("Error fetching customers:", error);
                customerSelect.innerHTML = '<option value="" disabled>Error loading customers</option>';
            }
        }

        async function getNextOrderNumber() {
            try {
                const encodedTableName = encodeURIComponent(APPSHEET_CONFIG.ORDERS_TABLE);
                const API_URL = `https://api.appsheet.com/api/v2/apps/${APPSHEET_CONFIG.APP_ID}/tables/${encodedTableName}/Action`;
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ApplicationAccessKey': APPSHEET_CONFIG.API_KEY
                    },
                    body: JSON.stringify({
                        "Action": "Find",
                        "Properties": {},
                        "Rows": []
                    })
                });
                
                let maxOrderNum = 0;
                
                if (response.ok) {
                    const data = await response.json();
                    if (Array.isArray(data)) {
                        data.forEach(order => {
                            const orderNum = order["Order Num"];
                            if (orderNum && orderNum.startsWith("SO-")) {
                                const num = parseInt(orderNum.replace("SO-", ""));
                                if (!isNaN(num) && num > maxOrderNum) {
                                    maxOrderNum = num;
                                }
                            }
                        });
                    }
                }
                
                const counterRef = database.ref('orderCounter');
                const snapshot = await counterRef.once('value');
                const firebaseCounter = snapshot.val() || 0;
                
                const nextNumber = Math.max(maxOrderNum, firebaseCounter) + 1;
                
                await counterRef.set(nextNumber);
                
                return `SO-${nextNumber}`;
            } catch (error) {
                console.error("Error generating order number:", error);
                return `SO-${Date.now()}`;
            }
        }

        // ===================================
        // QUOTE EXPIRATION CHECK
        // ===================================
        async function checkAndExpireQuotes() {
            const quotesRef = database.ref('quotes');
            const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);

            try {
                const snapshot = await quotesRef.orderByChild('status').equalTo('Quoted').once('value');
                if (snapshot.exists()) {
                    const updates = {};
                    snapshot.forEach(childSnapshot => {
                        const quote = childSnapshot.val();
                        const quoteDate = new Date(quote.date).getTime();

                        if (quoteDate < sevenDaysAgo) {
                            updates[`${childSnapshot.key}/status`] = 'Lost Sale';
                        }
                    });

                    if (Object.keys(updates).length > 0) {
                        await database.ref('quotes').update(updates);
                    }
                }
            } catch (error) {
                console.error("Error checking for expired quotes:", error);
            }
        }
// ===================================
        // PDF GENERATION
        // ===================================
        async function generatePDF() {
            if (selectedQuotes.size === 0) {
                alert('Please select at least one quote to generate a PDF.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const selected = allQuotesCache.filter(q => selectedQuotes.has(q.id));
            
            const hasOutright = selected.some(q => q.outrightPrice && !isNaN(parseFloat(q.outrightPrice)));
            const hasExchange = selected.some(q => q.exchangePrice && !isNaN(parseFloat(q.exchangePrice)));
            const hasNotes = selected.some(q => q.notes && q.notes.trim() !== '');
            
            const quoteNumber = await getNextQuoteNumber();
            const customerName = selected[0]?.sold || 'N/A';
            const quoteDate = new Date().toLocaleDateString();
            
            doc.setFontSize(8);
            doc.setTextColor(60, 60, 60);
            const companyInfo = [
                'iMED All, Inc.',
                '727 N Main St.',
                'Orange CA, 92868',
                '+1 (714)-271-2721'
            ];
            let yPos = 12;
            companyInfo.forEach(line => {
                doc.text(line, 195, yPos, { align: 'right' });
                yPos += 4;
            });
            
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.5);
            doc.line(15, 30, 195, 30);
            
            doc.setFontSize(10);
            doc.setTextColor(60, 60, 60);
            doc.text(`Customer: ${customerName}`, 15, 38);
            doc.text(`Date: ${quoteDate}`, 15, 44);
            
            doc.setFontSize(28);
            doc.setTextColor(45, 122, 127);
            doc.setFont(undefined, 'bold');
            doc.text('QUOTE', 15, 60);
            
            doc.setFontSize(11);
            doc.setTextColor(100, 100, 100);
            doc.setFont(undefined, 'normal');
            doc.text(`Quote Number: ${quoteNumber}`, 15, 68);
            
            let totalOutright = 0;
            let totalExchange = 0;
            
            selected.forEach(quote => {
                if (quote.outrightPrice && !isNaN(parseFloat(quote.outrightPrice))) {
                    totalOutright += parseFloat(quote.outrightPrice);
                }
                if (quote.exchangePrice && !isNaN(parseFloat(quote.exchangePrice))) {
                    totalExchange += parseFloat(quote.exchangePrice);
                }
            });
            
            const headers = ['Item Name', 'PN'];
            if (hasExchange) headers.push('Exchange');
            if (hasOutright) headers.push('Outright');
            headers.push('Warranty');
            if (hasNotes) headers.push('Notes');
            
            const tableData = selected.map(quote => {
                const row = [
                    quote.itemName || 'N/A',
                    quote.pn || 'N/A'
                ];
                
                if (hasExchange) {
                    row.push(formatPrice(quote.exchangePrice));
                }
                if (hasOutright) {
                    row.push(formatPrice(quote.outrightPrice));
                }
                row.push(`${quote.warrantyDays || 90} days`);
                if (hasNotes) {
                    row.push(quote.notes || '—');
                }
                
                return row;
            });
            
            const columnStyles = {};
            let colIndex = 0;
            
            if (hasNotes) {
                // With Notes column - specific widths
                columnStyles[colIndex] = { cellWidth: 40 };  // Item Name
                colIndex++;
                columnStyles[colIndex] = { cellWidth: 28 };  // PN
                colIndex++;
                
                if (hasExchange) {
                    columnStyles[colIndex] = { cellWidth: 24 };  // Exchange
                    colIndex++;
                }
                
                if (hasOutright) {
                    columnStyles[colIndex] = { cellWidth: 24 };  // Outright
                    colIndex++;
                }
                
                columnStyles[colIndex] = { cellWidth: 22 };  // Warranty
                colIndex++;
                columnStyles[colIndex] = { cellWidth: 'auto' };  // Notes - fills remaining
            } else {
                // Without Notes - all columns expand proportionally
                columnStyles[colIndex] = { cellWidth: 'auto' };  // Item Name
                colIndex++;
                columnStyles[colIndex] = { cellWidth: 'auto' };  // PN
                colIndex++;
                
                if (hasExchange) {
                    columnStyles[colIndex] = { cellWidth: 'auto' };  // Exchange
                    colIndex++;
                }
                
                if (hasOutright) {
                    columnStyles[colIndex] = { cellWidth: 'auto' };  // Outright
                    colIndex++;
                }
                
                columnStyles[colIndex] = { cellWidth: 'auto' };  // Warranty
            }
            
            doc.autoTable({
                startY: 75,
                head: [headers],
                body: tableData,
                theme: 'plain',
                headStyles: {
                    fillColor: [45, 122, 127],
                    textColor: [255, 255, 255],
                    fontSize: 9,
                    fontStyle: 'bold',
                    lineWidth: 0,
                    minCellHeight: 8,
                    valign: 'middle'
                },
                styles: {
                    fontSize: 8,
                    cellPadding: 4,
                    lineColor: [220, 220, 220],
                    lineWidth: 0.5,
                    fillColor: [250, 250, 250],
                    overflow: 'linebreak',
                    cellWidth: 'wrap'
                },
                alternateRowStyles: {
                    fillColor: [240, 240, 240]
                },
                columnStyles: columnStyles,
                margin: { left: 15, right: 15 },
                tableLineWidth: 0
            });
            
            const finalY = doc.lastAutoTable.finalY;
            
            if (hasExchange && totalExchange > 0) {
                doc.setFillColor(45, 122, 127);
                doc.rect(15, finalY + 10, 180, 10, 'F');
                doc.setFontSize(12);
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.text(`Total Exchange Price: ${formatPrice(totalExchange)}`, 20, finalY + 17);
            }
            
            if (hasOutright && totalOutright > 0) {
                const yPos = (hasExchange && totalExchange > 0) ? finalY + 22 : finalY + 10;
                
                if (hasExchange && totalExchange > 0) {
                    doc.setDrawColor(220, 220, 220);
                    doc.setLineWidth(0.5);
                    doc.line(15, finalY + 21, 195, finalY + 21);
                }
                
                doc.setFillColor(45, 122, 127);
                doc.rect(15, yPos, 180, 10, 'F');
                doc.setFontSize(12);
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.text(`Total Outright Price: ${formatPrice(totalOutright)}`, 20, yPos + 7);
            }

            doc.addPage();
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(quoteNumber, 20, 15);
            
            doc.setFontSize(18);
            doc.setTextColor(45, 122, 127);
            doc.setFont(undefined, 'bold');
            doc.text('Terms and Conditions', 105, 30, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            
            const terms = [
                '',
                'Terms in item entry supersede the following general terms.',
                '',
                'SHIPPING',
                'Shipping charges are not included. Shipping terms follow Incoterms 2020 (EXW Orange, California).',
                '',
                'INSURANCE',
                'Buyer is responsible for insuring the package and content.',
                '',
                'SALES',
                'Sales are final and for working genuine used parts. The customer is aware that the items purchased are in used condition and as such may show slight abrasion, scratches or discoloration.',
                '',
                'RESTOCKING',
                'If permitted by seller, items must be returned within 10 days. Buyer pays 25% restocking fee. Seller returns 75% upon return and testing of the restocked parts. Parts must be returned in working condition or the parts will not be accepted for restocking; customer will be responsible for 100% purchase price and shipping cost of the part back to customer.',
                '',
                '',
                '',
                'EXCHANGE SALE',
                'Exchange item needs to be returned prior to shipping of ordered parts unless otherwise agreed and stated, but in any case not later than 30 days. Exchange items must be repairable or outright sale applies.',
                '',
                'WARRANTY',
                '60 days from date of delivery.',
                '',
                'TAXES AND DUTIES',
                'The customer is responsible for all federal, state or local taxes, customs, or duties as they apply by governing agencies.',
                '',
                'PAYMENT',
                'Payment via bank transfer, direct deposit or secured check. Credit card payments incur an additional 3% processing fee.',
                '',
                'Mail checks to:',
                'iMed All, Inc.',
                '727 N Main St.',
                'Orange, CA 92868',
                ''
            ];
            
            let yPosition = 45;
            const lineHeight = 5.5;
            const pageHeight = doc.internal.pageSize.getHeight();
            const bottomMargin = 20;
            
            terms.forEach(line => {
                if (yPosition > pageHeight - bottomMargin) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                if (line.match(/^[A-Z\s]+$/) && line.trim() !== '') {
                    doc.setFont(undefined, 'bold');
                } else {
                    doc.setFont(undefined, 'normal');
                }
                
                doc.text(line, 20, yPosition, { maxWidth: 170 });
                yPosition += lineHeight;
            });
            
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.setFont(undefined, 'normal');
                doc.text(`${quoteNumber} - Page ${i} of ${totalPages}`, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
            }
            
            const fileName = `iMED_Quote_${quoteNumber}.pdf`;
            doc.save(fileName);
        }

        async function getNextQuoteNumber() {
            try {
                // Try to get counter from database
                const counterRef = database.ref('quoteCounter');
                const snapshot = await counterRef.once('value');
                let currentNumber = snapshot.val() || 0;
                const newNumber = currentNumber + 1;
                
                // Try to update counter
                try {
                    await counterRef.set(newNumber);
                } catch (setError) {
                    console.warn("Could not update counter in database, using timestamp fallback");
                }
                
                return `IMA_Q${newNumber}`;
            } catch (error) {
                // Fallback: Use timestamp-based quote number
                console.warn("Using timestamp-based quote number due to database access error:", error);
                const timestamp = Date.now();
                return `IMA_Q${timestamp}`;
            }
        }

        // ===================================
        // USER MANAGEMENT FUNCTIONS
        // ===================================
        async function loadUsers() {
            if (currentUserData?.role !== 'Admin') return;

            const container = document.getElementById('usersContainer');
            container.innerHTML = '<div class="spinner"></div>';

            try {
                const snapshot = await database.ref('users').once('value');
                const users = [];
                snapshot.forEach(childSnapshot => {
                    users.push(childSnapshot.val());
                });

                renderUsers(users);

            } catch (error) {
                console.error('Error loading users:', error);
                container.innerHTML = '<div class="empty-state" style="color: #991b1b;">Error loading users</div>';
                showMessage('userManagementMessage', 'error', 'Could not load users.');
            }
        }

        function renderUsers(users) {
            const container = document.getElementById('usersContainer');
            if (!users || users.length === 0) {
                container.innerHTML = '<div class="empty-state">No users found</div>';
                return;
            }

            users.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            container.innerHTML = users.map(user => {
                const roleClass = `badge-${user.role?.toLowerCase().replace(' ', '') || 'viewer'}`;
                const statusClass = `badge-${user.status || 'inactive'}`;
                const isCurrentUser = user.uid === currentUser.uid;

                const activateButton = `
                    <button class="btn btn-secondary btn-small"
                            onclick="toggleUserStatus('${user.uid}', '${user.status}')"
                            ${isCurrentUser ? 'disabled title="Cannot change own status"' : ''}>
                        ${user.status === 'active' ? 'Deactivate' : 'Activate'}
                    </button>`;
                const deleteButton = `
                    <button class="btn btn-danger btn-small"
                            onclick="deleteUser('${user.uid}')"
                            ${isCurrentUser ? 'disabled title="Cannot delete self"' : ''}>
                        Delete
                    </button>`;

                return `
                    <div class="user-card">
                        <div class="user-card-info">
                            <div class="user-avatar">${user.name ? user.name.charAt(0).toUpperCase() : '?'}</div>
                            <div class="user-card-details">
                                <h3>
                                    ${user.name || 'No Name'}
                                    <span class="badge ${roleClass}">${user.role || 'No Role'}</span>
                                    <span class="badge ${statusClass}">${user.status || 'Unknown'}</span>
                                </h3>
                                <p>${user.email}</p>
                                <p style="font-size: 12px;">Created: ${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A'}</p>
                                <p style="font-size: 12px;">Verified: ${user.emailVerified ? 'Yes' : 'No'}</p>
                            </div>
                        </div>
                        <div class="action-buttons">
                            ${isCurrentUser ? '<span style="color: #6b7280; font-size: 13px;">(Your Account)</span>' : activateButton + deleteButton}
                        </div>
                    </div>`;
            }).join('');
        }

        function showAddUserModal() {
            if (currentUserData?.role !== 'Admin') return;

            document.getElementById('addUserModal').classList.add('active');
            document.getElementById('addUserForm').reset();
            document.getElementById('addUserMessage').style.display = 'none';
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.remove('active');
        }

        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (currentUserData?.role !== 'Admin') {
                return showMessage('addUserMessage', 'error', 'Only Admins can add users.');
            }

            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;

            const addUserBtn = document.getElementById('addUserBtn');
            const messageDiv = document.getElementById('addUserMessage');

            messageDiv.className = 'message';
            messageDiv.style.display = 'none';

            if (!name || !email || !password || !role) {
                return showMessage('addUserMessage', 'error', 'Please fill in all required fields.');
            }
            if (password.length < 8 || !/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(password)) {
                return showMessage('addUserMessage', 'error', 'Password must meet complexity requirements.');
            }

            addUserBtn.disabled = true;
            addUserBtn.textContent = 'Creating...';

            let secondaryApp = null;
            try {
                secondaryApp = firebase.initializeApp(firebaseConfig, "SecondaryUserCreate");
                const secondaryAuth = secondaryApp.auth();

                const userCredential = await secondaryAuth.createUserWithEmailAndPassword(email, password);
                const newUser = userCredential.user;

                await newUser.sendEmailVerification();

                const newUserDbData = {
                    uid: newUser.uid,
                    email: email,
                    name: name,
                    role: role,
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.uid,
                    emailVerified: false
                };
                await database.ref(`users/${newUser.uid}`).set(newUserDbData);

                await logActivity('create_user', newUser.uid, `Admin created user: ${name} (${email}) with role ${role}`);

                showMessage('addUserMessage', 'success', `User ${name} created. Verification email sent.`);
                setTimeout(() => {
                    closeAddUserModal();
                    loadUsers();
                }, 2000);

            } catch (error) {
                console.error('Error creating user:', error);
                let errorMessage = 'Failed to create user.';
                switch (error.code) {
                    case 'auth/email-already-in-use': errorMessage = 'This email is already registered.'; break;
                    case 'auth/invalid-email': errorMessage = 'Invalid email address format.'; break;
                }
                showMessage('addUserMessage', 'error', errorMessage);
                await logActivity('create_user_error', null, `Error creating user (${email}): ${error.message}`);
            } finally {
                addUserBtn.disabled = false;
                addUserBtn.textContent = 'Add User';
                if (secondaryApp) {
                    try {
                        await secondaryApp.delete();
                    } catch (deleteError) {
                        console.error("Error deleting secondary app:", deleteError);
                    }
                }
            }
        });

        async function toggleUserStatus(userId, currentStatus) {
            if (currentUserData?.role !== 'Admin') {
                return showMessage('userManagementMessage', 'error', 'Only Admins can change user status.');
            }
            if (userId === currentUser.uid) {
                return showMessage('userManagementMessage', 'error', 'You cannot change your own status.');
            }

            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            const actionVerb = newStatus === 'active' ? 'activate' : 'deactivate';

            if (confirm(`Are you sure you want to ${actionVerb} this user?`)) {
                try {
                    await database.ref(`users/${userId}`).update({
                        status: newStatus,
                        lastModifiedBy: currentUser.uid,
                        lastModifiedAt: new Date().toISOString()
                    });

                    const targetUserSnap = await database.ref(`users/${userId}/email`).once('value');
                    const targetUserEmail = targetUserSnap.val() || 'Unknown Email';

                    await logActivity('toggle_user_status', userId, `Admin ${actionVerb}d user: ${targetUserEmail}. New status: ${newStatus}`);
                    showMessage('userManagementMessage', 'success', `User status updated to ${newStatus}.`);
                    loadUsers();
                } catch (error) {
                    console.error('Error updating user status:', error);
                    showMessage('userManagementMessage', 'error', 'Failed to update status.');
                    await logActivity('toggle_user_status_error', userId, `Error changing status: ${error.message}`);
                }
            }
        }

        async function deleteUser(userId) {
            if (currentUserData?.role !== 'Admin') {
                return showMessage('userManagementMessage', 'error', 'Only Admins can delete users.');
            }
            if (userId === currentUser.uid) {
                return showMessage('userManagementMessage', 'error', 'You cannot delete your own account.');
            }

            const userRef = database.ref(`users/${userId}`);
            const userSnapshot = await userRef.once('value');
            const userToDelete = userSnapshot.val();

            if (!userToDelete) {
                return showMessage('userManagementMessage', 'error', 'User not found.');
            }

            if (confirm(`DELETE USER: ${userToDelete.name} (${userToDelete.email})?\n\nThis action is permanent and only removes the database record. The authentication record must be removed manually in Firebase Console if needed.`)) {
                try {
                    await logActivity('delete_user', userId, `Admin deleted user record: ${userToDelete.name} (${userToDelete.email})`);
                    await userRef.remove();
                    showMessage('userManagementMessage', 'success', 'User database record deleted successfully!');
                    loadUsers();

                    alert(`User record for ${userToDelete.email} deleted from the database.\n\nPlease remember to also delete this user from the Firebase Authentication console to fully remove their access.`);

                } catch (error) {
                    console.error('Error deleting user record:', error);
                    showMessage('userManagementMessage', 'error', 'Failed to delete user record.');
                    await logActivity('delete_user_error', userId, `Error deleting user record: ${error.message}`);
                }
            }
        }

        // ===================================
        // EMERGENCY RESTORE FUNCTIONALITY
        // ===================================
        let restoreData = null;
        let restoreAnalysis = null;

        // Open Emergency Restore Modal
        document.getElementById('emergencyRestoreBtn')?.addEventListener('click', () => {
            if (currentUserData?.role !== 'Admin') {
                alert('Access Denied: Only Admins can use Emergency Restore.');
                return;
            }
            document.getElementById('emergencyRestoreModal').classList.add('visible');
            document.body.classList.add('modal-open');
            restoreData = null;
            restoreAnalysis = null;
            document.getElementById('restoreFileInput').value = '';
            document.getElementById('restorePreview').style.display = 'none';
            document.getElementById('analyzeRestoreBtn').disabled = true;
            document.getElementById('executeRestoreBtn').disabled = true;
            
            // Hide message manually
            const messageDiv = document.getElementById('emergencyRestoreMessage');
            if (messageDiv) {
                messageDiv.style.display = 'none';
                messageDiv.className = 'message';
                messageDiv.textContent = '';
            }
        });

        // Close Emergency Restore Modal
        document.getElementById('closeEmergencyRestoreModal')?.addEventListener('click', () => {
            document.getElementById('emergencyRestoreModal').classList.remove('visible');
            document.body.classList.remove('modal-open');
        });

        // Handle file selection
        document.getElementById('restoreFileInput')?.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
                document.getElementById('analyzeRestoreBtn').disabled = true;
                return;
            }

            if (!file.name.endsWith('.json')) {
                showMessage('emergencyRestoreMessage', 'error', 'Please select a valid JSON file.');
                document.getElementById('analyzeRestoreBtn').disabled = true;
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    restoreData = JSON.parse(event.target.result);
                    if (!restoreData || typeof restoreData !== 'object') {
                        throw new Error('Invalid JSON structure');
                    }
                    
                    // Check if this is a full Firebase backup or quotes-only
                    if (restoreData.quotes && typeof restoreData.quotes === 'object') {
                        // Full backup detected - will extract quotes automatically
                        console.log('Full Firebase backup detected');
                    } else if (Object.keys(restoreData).length === 0) {
                        throw new Error('No data found in file');
                    }
                    document.getElementById('analyzeRestoreBtn').disabled = false;
                    showMessage('emergencyRestoreMessage', 'success', 'File loaded successfully. Click "Analyze File" to preview.');
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    showMessage('emergencyRestoreMessage', 'error', 'Invalid JSON file format.');
                    document.getElementById('analyzeRestoreBtn').disabled = true;
                    restoreData = null;
                }
            };
            reader.readAsText(file);
        });

        // Analyze the restore file
        document.getElementById('analyzeRestoreBtn')?.addEventListener('click', async () => {
            if (!restoreData) {
                showMessage('emergencyRestoreMessage', 'error', 'No data loaded.');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeRestoreBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = '⏳ Analyzing...';

            try {
                // Fetch all existing quotes from Firebase
                const snapshot = await database.ref('quotes').once('value');
                const existingQuotes = snapshot.val() || {};
                
                const existingQuoteIds = new Set(Object.keys(existingQuotes));
                
                let newQuotes = [];
                let duplicates = [];
                
                // Extract quotes from backup (handle both full backup and quotes-only format)
                let quotesData = restoreData;
                if (restoreData.quotes) {
                    // Full Firebase backup format
                    quotesData = restoreData.quotes;
                }
                
                // Check each quote in the restore file
                Object.entries(quotesData).forEach(([quoteId, quoteData]) => {
                    if (existingQuoteIds.has(quoteId)) {
                        duplicates.push({ id: quoteId, data: quoteData });
                    } else {
                        newQuotes.push({ id: quoteId, data: quoteData });
                    }
                });

                restoreAnalysis = {
                    total: Object.keys(quotesData).length,
                    newQuotes: newQuotes,
                    duplicates: duplicates
                };

                // Display analysis
                document.getElementById('totalQuotesCount').textContent = restoreAnalysis.total;
                document.getElementById('newQuotesCount').textContent = restoreAnalysis.newQuotes.length;
                document.getElementById('duplicateQuotesCount').textContent = restoreAnalysis.duplicates.length;
                document.getElementById('restorePreview').style.display = 'block';

                if (restoreAnalysis.newQuotes.length > 0) {
                    document.getElementById('executeRestoreBtn').disabled = false;
                    showMessage('emergencyRestoreMessage', 'success', 
                        `Analysis complete! ${restoreAnalysis.newQuotes.length} new quote(s) ready to restore.`);
                } else {
                    document.getElementById('executeRestoreBtn').disabled = true;
                    showMessage('emergencyRestoreMessage', 'info', 
                        'No new quotes to restore. All quotes already exist in the system.');
                }

            } catch (error) {
                console.error('Error analyzing restore file:', error);
                showMessage('emergencyRestoreMessage', 'error', 'Error analyzing file: ' + error.message);
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = '🔍 Analyze File';
            }
        });

        // Execute the restore
        document.getElementById('executeRestoreBtn')?.addEventListener('click', async () => {
            if (currentUserData?.role !== 'Admin') {
                showMessage('emergencyRestoreMessage', 'error', 'Access Denied: Only Admins can execute restore.');
                return;
            }

            if (!restoreAnalysis || restoreAnalysis.newQuotes.length === 0) {
                showMessage('emergencyRestoreMessage', 'error', 'No new quotes to restore.');
                return;
            }

            const confirmMsg = `Are you sure you want to restore ${restoreAnalysis.newQuotes.length} quote(s)?\n\n` +
                              `This will add them to your Firebase database.`;
            
            if (!confirm(confirmMsg)) {
                return;
            }

            const executeBtn = document.getElementById('executeRestoreBtn');
            executeBtn.disabled = true;
            executeBtn.textContent = '⏳ Restoring...';

            try {
                let successCount = 0;
                let errorCount = 0;

                // Restore each new quote
                for (const { id, data } of restoreAnalysis.newQuotes) {
                    try {
                        await database.ref(`quotes/${id}`).set(data);
                        successCount++;
                    } catch (error) {
                        console.error(`Error restoring quote ${id}:`, error);
                        errorCount++;
                    }
                }

                // Log the activity
                await logActivity('emergency_restore', null, 
                    `Restored ${successCount} quotes from backup. Skipped ${restoreAnalysis.duplicates.length} duplicates. Errors: ${errorCount}`);

                // Show success message
                showMessage('emergencyRestoreMessage', 'success', 
                    `✅ Restore complete! Added ${successCount} quote(s). ` +
                    `Skipped ${restoreAnalysis.duplicates.length} duplicate(s). ` +
                    (errorCount > 0 ? `Errors: ${errorCount}` : ''));

                // Refresh the quotes list
                fetchAllQuotesForSearch();

                // Reset the form
                setTimeout(() => {
                    document.getElementById('emergencyRestoreModal').classList.remove('visible');
                    document.body.classList.remove('modal-open');
                }, 3000);

            } catch (error) {
                console.error('Error executing restore:', error);
                showMessage('emergencyRestoreMessage', 'error', 'Error during restore: ' + error.message);
                await logActivity('emergency_restore_error', null, `Error during restore: ${error.message}`);
            } finally {
                executeBtn.disabled = false;
                executeBtn.textContent = '✅ Execute Restore';
            }
        });

// ===================================
        // BODY CLICK HANDLER FOR ACTIONS
        // ===================================
        function handleBodyClick(e) {
            const actionButton = e.target.closest('[data-action]');
            if (actionButton) {
                const action = actionButton.dataset.action;
                const quote = JSON.parse(actionButton.dataset.quote || '{}');

                 if (action === 'edit-quote') {
                    openEditModal(quote);
                } else if (action === 'view-notes') {
                    alert(quote.notes || 'No notes for this quote.');
                } else if (action === 'create-exchange') {
                    createExchangeFromQuote(quote);
                }
                return;
            }

            const searchRow = e.target.closest('#searchHistoryBody tr');
            if (searchRow) {
                if (e.target.closest('select, button, input[type="checkbox"]')) {
                    return;
                }

                const pn = searchRow.dataset.pn;
                const itemName = searchRow.dataset.itemName;
                if (pn && itemName) {
                    updateMainView(pn, itemName);
                    window.scrollTo(0, 0);
                }
            }
        }

        // ===================================
        // INITIALIZE EVENT LISTENERS
        // ===================================
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const initialPartNumber = urlParams.get('pn');
            const initialItemName = urlParams.get('name');
            
            if (!initialPartNumber) { 
                document.getElementById('itemName').textContent = 'N/A';
                document.getElementById('partNumber').textContent = 'N/A';
            } else {
                updateMainView(initialPartNumber, initialItemName);
            }

            // Set up image expandable toggle event listener
            const imageExpandable = document.getElementById('imageExpandable');
            if (imageExpandable) {
                imageExpandable.addEventListener('toggle', function() {
                    if (this.open) {
                        const partNumberElement = document.getElementById('partNumber');
                        const partNumber = partNumberElement?.textContent?.trim();
                        
                        if (partNumber && partNumber !== 'N/A') {
                            loadProductImageOnDemand(partNumber);
                        }
                    } else {
                        // When collapsed, update the arrow
                        const summary = this.querySelector('summary');
                        if (summary && !summary.textContent.includes('Loading')) {
                            summary.innerHTML = '<span style="display: inline-block; margin-right: 8px;">▶</span>📷 Click to load Product Image';
                        }
                    }
                });
            }
            
            // Set up event listeners for currency inputs
            ['outrightPrice', 'exchangePrice', 'editOutrightPrice', 'editExchangePrice'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', handleCurrencyInput);
                    element.addEventListener('blur', handleCurrencyBlur);
                }
            });

            // Set up search input listener
            const searchInput = document.getElementById('quoteSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => filterAndDisplayQuotes(e.target.value));
            }

            // Set up results limit change listener
            const resultsLimit = document.getElementById('resultsLimit');
            if (resultsLimit) {
                resultsLimit.addEventListener('change', handleResultsLimitChange);
            }

            // Set up select all checkbox listener
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', handleSelectAll);
            }

            // Set up edit modal listeners
            const cancelEditButton = document.getElementById('cancelEditButton');
            if (cancelEditButton) {
                cancelEditButton.addEventListener('click', closeEditModal);
            }

            const saveEditButton = document.getElementById('saveEditButton');
            if (saveEditButton) {
                saveEditButton.addEventListener('click', handleEditFormSubmit);
            }

            const deleteQuoteButton = document.getElementById('deleteQuoteButton');
            if (deleteQuoteButton) {
                deleteQuoteButton.addEventListener('click', handleDeleteQuote);
            }

            const editModal = document.getElementById('editModal');
            if (editModal) {
                editModal.addEventListener('click', (e) => {
                    if (e.target.id === 'editModal') closeEditModal();
                });
            }

            // Set up body click handler
            document.body.addEventListener('click', handleBodyClick);
// Set up Item Number Selection Modal listeners
            const cancelExchangeBtn = document.getElementById('cancelExchangeSelectionBtn');
            if (cancelExchangeBtn) {
                cancelExchangeBtn.addEventListener('click', closeItemSelectionModal);
            }

            const confirmExchangeBtn = document.getElementById('confirmExchangeCreationBtn');
            if (confirmExchangeBtn) {
                confirmExchangeBtn.addEventListener('click', processAndSendExchanges);
            }
// Set up All Prices Modal close
            const closeAllPricesBtn = document.getElementById('closeAllPricesModal');
            if (closeAllPricesBtn) {
                closeAllPricesBtn.addEventListener('click', () => {
                    document.getElementById('allPricesModal').classList.remove('visible');
                    document.body.classList.remove('modal-open');
                });
            }
            
            const allPricesModal = document.getElementById('allPricesModal');
            if (allPricesModal) {
                allPricesModal.addEventListener('click', (e) => {
                    if (e.target.id === 'allPricesModal') {
                        allPricesModal.classList.remove('visible');
                        document.body.classList.remove('modal-open');
                    }
                });
            }

            // Fetch customers and quotes
            fetchCustomersFromAppSheet();
            fetchAllQuotesForSearch();
            checkAndExpireQuotes();
        });

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Sales Quote</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .page-container { width: 100%; max-width: 900px; }
        .main-card { background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .card-header { background: linear-gradient(135deg, #2d7a7f 0%, #1f5a5e 100%); color: white; padding: 32px; text-align: center; position: relative; }
        .user-info-header {
            position: absolute;
            top: 16px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }
        .user-name {
            color: white;
            font-weight: 600;
        }
        .user-role-badge {
            background: rgba(243, 146, 55, 0.2);
            color: #f39237;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .header-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .header-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(0);
        }
        .card-header h1 { font-size: 32px; font-weight: 700; margin-bottom: 8px; letter-spacing: -0.5px; }
        .card-header h2 { font-size: 18px; font-weight: 400; opacity: 0.95; color: #f39237; }
        .card-content { padding: 32px; }
        section { margin-bottom: 32px; }
        section:last-child { margin-bottom: 0; }
        h3 { font-size: 18px; font-weight: 600; color: #1f2937; margin-bottom: 16px; }
        .item-info p { font-size: 15px; color: #4b5563; margin-bottom: 8px; line-height: 1.6; }
        .item-info strong { color: #1f2937; font-weight: 600; }
        .divider { border: none; border-top: 1px solid #e5e7eb; margin: 32px 0; }
        .form-group { margin-bottom: 20px; }
        .price-group { display: flex; gap: 20px; }
        .price-group .form-group { flex: 1; }
        label { display: block; font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 14px; }
        input[type="text"], input[type="number"], input[type="search"], select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
            background: white;
        }
        textarea { resize: vertical; }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2d7a7f;
            box-shadow: 0 0 0 3px rgba(45, 122, 127, 0.1);
        }
        input::placeholder, textarea::placeholder { color: #9ca3af; }
        button {
            background: linear-gradient(135deg, #2d7a7f 0%, #1f5a5e 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }
        button:hover { transform: translateY(-1px); }
        button:disabled { background: #9ca3af; cursor: not-allowed; box-shadow: none; }
        #formMessage { margin-top: 16px; padding: 12px; border-radius: 8px; font-size: 14px; text-align: center; display: none; }
        #formMessage.success { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; display: block; }
        #formMessage.error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; display: block; }
        .history-container { background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; padding: 16px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f3f4f6; }
        th { text-align: left; padding: 12px; font-weight: 600; color: #374151; font-size: 14px; border-bottom: 2px solid #e5e7eb; white-space: nowrap; }
        td { padding: 12px; color: #4b5563; font-size: 14px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        .price-cell { min-width: 120px; }
        .status-cell { min-width: 180px; }
        .notes-cell button { font-size: 14px; color: #2d7a7f; background: none; border: none; padding: 4px; cursor: pointer; font-weight: 600; }
        .notes-cell button:hover { text-decoration: underline; }
        tbody tr:last-child td { border-bottom: none; }
        #searchHistoryTable tbody tr:hover { background: #f0f9ff; cursor: pointer; } 
        .no-history-message { display: none; text-align: center; padding: 32px; color: #9ca3af; font-size: 15px; }
        
        .action-button { background: none; border: none; cursor: pointer; padding: 4px; border-radius: 50%; margin-right: 4px; }
        .action-button:hover { background-color: #e5e7eb; }
        .action-button svg { width: 20px; height: 20px; color: #6b7280; }
        .action-button.create-order-btn svg { color: #f39237; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { 
    background: white; 
    border-radius: 12px; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
    width: 90%; 
    max-width: 500px; 
    max-height: 90vh; 
    transform: scale(0.95); 
    transition: transform 0.3s ease; 
    display: flex; 
    flex-direction: column; 
    overflow: hidden; 
}
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { padding: 20px; border-bottom: 1px solid #e5e7eb; }
        .modal-header h4 { font-size: 18px; font-weight: 600; }
        .modal-body { 
    padding: 20px; 
    overflow-y: auto; 
    flex: 1; 
    -webkit-overflow-scrolling: touch; 
}
        .modal-footer { padding: 15px 20px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .modal-footer .btn-secondary { background: #e5e7eb; color: #374151; }
        .modal-footer .btn-danger { background: #ef4444; color: white; }
        .modal-footer .btn-primary { background: #2d7a7f; color: white; }

        .hot-item-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
            box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: white;
            border: 2px solid #e5e7eb;
            color: #374151;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            width: auto;
        }

        .filter-btn:hover {
            border-color: #2d7a7f;
            background: #f0f9ff;
            transform: none;
        }

        .filter-btn.active {
            background: #2d7a7f;
            color: white;
            border-color: #2d7a7f;
        }

        body.modal-open {
            overflow: hidden;
        }

        @media (max-width: 640px) {
            .card-header h1 { font-size: 24px; }
            .card-header h2 { font-size: 16px; }
            .card-content { padding: 24px; }
            th, td { padding: 8px; font-size: 13px; }
            .price-group { flex-direction: column; gap: 0; }
        }
    </style>
</head>
<body>

    <div class="page-container">
        <div class="main-card">
            <header class="card-header">
                <div class="user-info-header">
                    <span class="user-name" id="currentUserName">Loading...</span>
                    <span class="user-role-badge" id="currentUserRole"></span>
                    <button class="header-button" onclick="handleLogout()">Logout</button>
                </div>
                <h1>iMED ALL inc.</h1>
                <h2>Sales Quote</h2>
            </header>
            <div class="card-content">
                <section class="item-info">
                    <h3>Item Details</h3>
                    <div style="display: flex; gap: 20px; margin-bottom: 16px;">
                        <button onclick="toggleManualEntry()" style="width: auto; padding: 6px 12px; font-size: 13px;">
                            Manual Entry
                        </button>
                    </div>
                    <div id="autoItemDetails">
                        <p><strong>Name:</strong> <span id="itemName">Loading...</span><span id="hotItemBadge"></span></p>
                        <p><strong>Part Number:</strong> <span id="partNumber">...</span></p>
                    </div>
                    <div id="manualItemDetails" style="display: none;">
                        <div class="form-group">
                            <label for="manualItemName">Item Name:</label>
                            <input type="text" id="manualItemName" placeholder="Enter item name">
                        </div>
                        <div class="form-group">
                            <label for="manualPartNumber">Part Number:</label>
                            <input type="text" id="manualPartNumber" placeholder="Enter part number">
                        </div>
                    </div>
                </section>

                <hr class="divider">

                <section>
                    <h3>Customer & Quote Information</h3>
                    <form id="quoteForm">
                        <div class="form-group">
                            <label for="customer">Sold To (Select from List):</label>
                            <select id="customer" required>
                                <option value="" disabled selected>Loading customers...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="qnum">Quote Number:</label>
                            <input type="text" id="qnum" readonly style="background-color: #f9fafb; cursor: not-allowed;">
                        </div>
                        <div class="price-group">
                            <div class="form-group">
                                <label for="cprice">Cost Price (CAD):</label>
                                <input type="text" id="cprice" inputmode="decimal" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label for="sprice">Sell Price (CAD):</label>
                                <input type="text" id="sprice" inputmode="decimal" placeholder="0.00" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="warranty">Warranty:</label>
                            <select id="warranty" required>
                                <option value="" disabled selected>Select warranty period</option>
                                <option value="No Warranty">No Warranty</option>
                                <option value="30 Days">30 Days</option>
                                <option value="90 Days">90 Days</option>
                                <option value="6 Months">6 Months</option>
                                <option value="1 Year">1 Year</option>
                                <option value="2 Years">2 Years</option>
                                <option value="3 Years">3 Years</option>
                                <option value="Lifetime">Lifetime</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="notes">Notes (Optional):</label>
                            <textarea id="notes" rows="3" placeholder="Add any additional notes here..."></textarea>
                        </div>
                        <button type="submit" id="submitBtn">Submit Quote</button>
                        <div id="formMessage"></div>
                    </form>
                </section>

                <hr class="divider">

                <section id="searchSection">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0;">Search Quote History</h3>
                        <button onclick="toggleSearchSection()" style="width: auto; padding: 8px 16px; font-size: 14px;">
                            Toggle Search
                        </button>
                    </div>
                    <div id="searchContent">
                        <div class="form-group">
                            <label for="searchInput">Search by Part Number or Item Name:</label>
                            <input type="search" id="searchInput" placeholder="Type to search...">
                        </div>
                        
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all" onclick="handleTimeFilter('all')">All Time</button>
                            <button class="filter-btn" data-filter="today" onclick="handleTimeFilter('today')">Today</button>
                            <button class="filter-btn" data-filter="week" onclick="handleTimeFilter('week')">This Week</button>
                            <button class="filter-btn" data-filter="month" onclick="handleTimeFilter('month')">This Month</button>
                            <button class="filter-btn" data-filter="year" onclick="handleTimeFilter('year')">This Year</button>
                        </div>

                        <div class="history-container">
                            <table id="searchHistoryTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Item Name</th>
                                        <th>Part Number</th>
                                        <th class="price-cell">Cost (CAD)</th>
                                        <th class="price-cell">Sell (CAD)</th>
                                        <th class="status-cell">Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="searchHistoryBody">
                                    <tr><td colspan="7" style="text-align: center; padding: 20px; color: #9ca3af;">Search for an item to see history</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <hr class="divider">

                <section>
                    <h3>Quote History</h3>
                    
                    <div style="display: flex; gap: 12px; margin-bottom: 16px; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label for="historyTimeFilter" style="margin-bottom: 4px;">Filter by Time:</label>
                            <select id="historyTimeFilter" style="width: 100%;">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month" selected>This Month</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label for="resultsLimit" style="margin-bottom: 4px;">Results to Show:</label>
                            <select id="resultsLimit" style="width: 100%;">
                                <option value="25">25 results</option>
                                <option value="50" selected>50 results</option>
                                <option value="100">100 results</option>
                                <option value="all">All results</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                        <button onclick="copySelectedQuotes()" style="width: auto; padding: 10px 20px; font-size: 14px;">
                            Copy Selected Quotes
                        </button>
                        <button onclick="createBulkOrders()" style="width: auto; padding: 10px 20px; font-size: 14px; background: #f39237;">
                            Create Bulk Orders
                        </button>
                    </div>

                    <div class="history-container">
                        <table id="historyTable">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAll" onchange="handleSelectAll()" 
                                               style="width: 18px; height: 18px; cursor: pointer;">
                                    </th>
                                    <th>Date</th>
                                    <th>Quote #</th>
                                    <th>Item Name</th>
                                    <th>Part Number</th>
                                    <th>Customer</th>
                                    <th class="price-cell">Cost (CAD)</th>
                                    <th class="price-cell">Sell (CAD)</th>
                                    <th>Warranty</th>
                                    <th class="status-cell">Status</th>
                                    <th class="notes-cell">Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody">
                                <tr><td colspan="12" style="text-align: center; padding: 20px; color: #9ca3af;">Loading history...</td></tr>
                            </tbody>
                        </table>
                        <div id="noHistoryMessage" class="no-history-message">
                            No quotes found for this time period.
                        </div>
                    </div>
                    <div style="margin-top: 12px; color: #6b7280; font-size: 14px; text-align: center;" id="selectedCount">
                        0 quotes selected
                    </div>
                </section>
            </div>
        </div>
    </div>
    <!-- Edit Quote Modal -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Edit Quote</h4>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editQuoteId">
                    
                    <div class="form-group">
                        <label>Item Name:</label>
                        <input type="text" id="editItemName" readonly style="background-color: #f9fafb;">
                    </div>
                    
                    <div class="form-group">
                        <label>Part Number:</label>
                        <input type="text" id="editPartNumber" readonly style="background-color: #f9fafb;">
                    </div>
                    
                    <div class="form-group">
                        <label for="editCustomer">Customer:</label>
                        <input type="text" id="editCustomer" required>
                    </div>
                    
                    <div class="price-group">
                        <div class="form-group">
                            <label for="editCostPrice">Cost Price (CAD):</label>
                            <input type="text" id="editCostPrice" inputmode="decimal" required>
                        </div>
                        <div class="form-group">
                            <label for="editSellPrice">Sell Price (CAD):</label>
                            <input type="text" id="editSellPrice" inputmode="decimal" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="editWarranty">Warranty:</label>
                        <select id="editWarranty" required>
                            <option value="No Warranty">No Warranty</option>
                            <option value="30 Days">30 Days</option>
                            <option value="90 Days">90 Days</option>
                            <option value="6 Months">6 Months</option>
                            <option value="1 Year">1 Year</option>
                            <option value="2 Years">2 Years</option>
                            <option value="3 Years">3 Years</option>
                            <option value="Lifetime">Lifetime</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editStatus">Status:</label>
                        <select id="editStatus" required>
                            <option value="Quoted">Quoted</option>
                            <option value="Sold">Sold</option>
                            <option value="Lost Sale">Lost Sale</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editNotes">Notes:</label>
                        <textarea id="editNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn-danger" onclick="handleDeleteQuote()">Delete</button>
                <button class="btn-primary" onclick="handleEditFormSubmit()">Save Changes</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
const APPSHEET_CONFIG = {
    APP_ID: 'a9c07aae-2e81-461c-aa15-5e75cffd9e5f',
    API_KEY: 'V2-4Lggx-z6RgL-DchS5-2yBot-QGoeI-4zkBN-zF5ud-OarOy',
    TABLE_NAME: 'Sold List',
    CUSTOMER_COLUMN: 'Sold To',
    ORDERS_TABLE: 'Orders'
};

const firebaseConfig = {
    apiKey: "AIzaSyCe0u6B6qA9y6xvSR_jbY1Do-ljPKy5Lu8",
    authDomain: "imed-sales-quote.firebaseapp.com",
    databaseURL: "https://imed-sales-quote-default-rtdb.firebaseio.com",
    projectId: "imed-sales-quote",
    storageBucket: "imed-sales-quote.firebasestorage.app",
    messagingSenderId: "830326754595",
    appId: "1:830326754595:web:ca03272749599736fad096",
    measurementId: "G-6TCTDFX5PL"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();

let currentUser = null;
let currentUserData = null;

// Authentication check
firebase.auth().onAuthStateChanged(async (user) => {
    if (!user) {
        window.location.href = 'login.html';
        return;
    }

    try {
        const userSnapshot = await database.ref(`users/${user.uid}`).once('value');
        const userData = userSnapshot.val();

        if (!userData) {
            alert('User profile not found. Please contact administrator.');
            await auth.signOut();
            window.location.href = 'login.html';
            return;
        }

        if (userData.status !== 'active') {
            alert('Your account has been disabled. Please contact an administrator.');
            await auth.signOut();
            window.location.href = 'login.html';
            return;
        }

        currentUser = user;
        currentUserData = userData;

        // Update UI with user info
        document.getElementById('currentUserName').textContent = userData.name;
        document.getElementById('currentUserRole').textContent = userData.role;

        // Initialize the page
        initializePage();

    } catch (error) {
        console.error('Error checking user:', error);
        alert('Error loading user data. Please try again.');
        window.location.href = 'login.html';
    }
});

// Logout function
async function handleLogout() {
    if (confirm('Are you sure you want to logout?')) {
        try {
            await logActivity('logout');
            await auth.signOut();
            window.location.href = 'login.html';
        } catch (error) {
            console.error('Logout error:', error);
            alert('Error logging out. Please try again.');
        }
    }
}

// Activity logging
async function logActivity(action, additionalData = {}) {
    if (!currentUser) return;
    
    try {
        await database.ref('activityLog').push({
            userId: currentUser.uid,
            userEmail: currentUser.email,
            action: action,
            timestamp: Date.now(),
            date: new Date().toISOString(),
            ...additionalData
        });
    } catch (error) {
        console.error('Error logging activity:', error);
    }
}

// Initialize page
function initializePage() {
    const pn = new URLSearchParams(window.location.search).get('pn') || '3032450-001';
    const itemName = new URLSearchParams(window.location.search).get('item') || 'HP 3PAR 8000 4-PORT 8GB FC ADAPTER';

    document.getElementById('itemName').textContent = itemName;
    document.getElementById('partNumber').textContent = pn;

    updateHotItemBadge(pn, itemName);
    getNextQuoteNumber();
    fetchCustomersFromAppSheet();
    listenForQuoteHistory();
    fetchAllQuotesForSearch();

    const cpriceInput = document.getElementById('cprice');
    const spriceInput = document.getElementById('sprice');
    cpriceInput.addEventListener('input', handleCurrencyInput);
    cpriceInput.addEventListener('blur', handleCurrencyBlur);
    spriceInput.addEventListener('input', handleCurrencyInput);
    spriceInput.addEventListener('blur', handleCurrencyBlur);

    const editCostInput = document.getElementById('editCostPrice');
    const editSellInput = document.getElementById('editSellPrice');
    editCostInput.addEventListener('input', handleCurrencyInput);
    editCostInput.addEventListener('blur', handleCurrencyBlur);
    editSellInput.addEventListener('input', handleCurrencyInput);
    editSellInput.addEventListener('blur', handleCurrencyBlur);

    document.getElementById('warranty').addEventListener('change', handleWarrantyChange);
    document.getElementById('editWarranty').addEventListener('change', handleEditWarrantyChange);
    document.getElementById('historyTimeFilter').addEventListener('change', handleHistoryTimeFilterChange);
    document.getElementById('resultsLimit').addEventListener('change', handleResultsLimitChange);
    document.getElementById('searchInput').addEventListener('input', handlePriceHistorySearch);
    document.getElementById('quoteForm').addEventListener('submit', handleFormSubmit);

    document.body.addEventListener('click', handleBodyClick);

    checkAndExpireQuotes();
    setInterval(checkAndExpireQuotes, 60 * 60 * 1000);
}

function handleCurrencyInput(e) {
    let value = e.target.value.replace(/[^\d.]/g, '');
    const parts = value.split('.');
    if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
    }
    if (parts[1] && parts[1].length > 2) {
        value = parts[0] + '.' + parts[1].substring(0, 2);
    }
    e.target.value = value;
}

function handleCurrencyBlur(e) {
    let value = e.target.value.replace(/[^\d.]/g, '');
    if (value === '' || value === '.') {
        e.target.value = '';
        return;
    }
    const num = parseFloat(value);
    if (!isNaN(num)) {
        e.target.value = num.toFixed(2);
    }
}

function formatPrice(price) {
    const num = typeof price === 'string' ? parseFloat(price) : price;
    return isNaN(num) ? '0.00' : num.toFixed(2);
}
        function handleWarrantyChange() {
    const warranty = document.getElementById('warranty').value;
    const days = getWarrantyDays(warranty);
    console.log(`Warranty selected: ${warranty}, Valid for ${days} days`);
}

function handleEditWarrantyChange() {
    const warranty = document.getElementById('editWarranty').value;
    const days = getEditWarrantyDays(warranty);
    console.log(`Edit warranty selected: ${warranty}, Valid for ${days} days`);
}

function getWarrantyDays(warranty) {
    const warrantyMap = {
        'No Warranty': 0,
        '30 Days': 30,
        '90 Days': 90,
        '6 Months': 180,
        '1 Year': 365,
        '2 Years': 730,
        '3 Years': 1095,
        'Lifetime': 3650
    };
    return warrantyMap[warranty] || 0;
}

function getEditWarrantyDays(warranty) {
    return getWarrantyDays(warranty);
}

function toggleManualEntry() {
    const autoDetails = document.getElementById('autoItemDetails');
    const manualDetails = document.getElementById('manualItemDetails');
    
    if (manualDetails.style.display === 'none') {
        autoDetails.style.display = 'none';
        manualDetails.style.display = 'block';
    } else {
        autoDetails.style.display = 'block';
        manualDetails.style.display = 'none';
        document.getElementById('manualItemName').value = '';
        document.getElementById('manualPartNumber').value = '';
    }
}

async function handleFormSubmit(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const messageDiv = document.getElementById('formMessage');
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    messageDiv.style.display = 'none';

    const manualMode = document.getElementById('manualItemDetails').style.display !== 'none';
    
    let itemName, partNumber;
    if (manualMode) {
        itemName = document.getElementById('manualItemName').value.trim();
        partNumber = document.getElementById('manualPartNumber').value.trim();
        
        if (!itemName || !partNumber) {
            messageDiv.className = 'message error';
            messageDiv.textContent = 'Please fill in both Item Name and Part Number for manual entry.';
            messageDiv.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Quote';
            return;
        }
    } else {
        itemName = document.getElementById('itemName').textContent;
        partNumber = document.getElementById('partNumber').textContent;
    }

    const formData = {
        pn: partNumber,
        item: itemName,
        sold: document.getElementById('customer').value,
        qnum: document.getElementById('qnum').value,
        cprice: parseFloat(document.getElementById('cprice').value),
        sprice: parseFloat(document.getElementById('sprice').value),
        warranty: document.getElementById('warranty').value,
        notes: document.getElementById('notes').value.trim(),
        status: 'Quoted',
        date: new Date().toISOString(),
        timestamp: Date.now(),
        createdBy: currentUser.uid,
        createdByEmail: currentUser.email,
        createdByName: currentUserData.name
    };

    try {
        await database.ref('quotes').push(formData);
        
        await logActivity('quote_created', {
            quoteNumber: formData.qnum,
            itemName: formData.item,
            partNumber: formData.pn,
            customer: formData.sold
        });

        messageDiv.className = 'message success';
        messageDiv.textContent = 'Quote submitted successfully!';
        messageDiv.style.display = 'block';

        document.getElementById('quoteForm').reset();
        document.getElementById('cprice').value = '';
        document.getElementById('sprice').value = '';
        
        await getNextQuoteNumber();

        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 3000);

    } catch (error) {
        console.error('Error submitting quote:', error);
        messageDiv.className = 'message error';
        messageDiv.textContent = 'Error submitting quote. Please try again.';
        messageDiv.style.display = 'block';
    }

    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit Quote';
}

async function getNextQuoteNumber() {
    try {
        const counterRef = database.ref('quoteCounter');
        const snapshot = await counterRef.once('value');
        let counter = snapshot.val() || 0;
        counter++;
        await counterRef.set(counter);
        
        const quoteNumber = `IMA_Q${counter}`;
        document.getElementById('qnum').value = quoteNumber;
        
        return quoteNumber;
    } catch (error) {
        console.error("Error generating quote number:", error);
        return `IMA_Q${Date.now()}`;
    }
}

async function getNextOrderNumber() {
    try {
        const encodedTableName = encodeURIComponent(APPSHEET_CONFIG.ORDERS_TABLE);
        const API_URL = `https://api.appsheet.com/api/v2/apps/${APPSHEET_CONFIG.APP_ID}/tables/${encodedTableName}/Action`;
        
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'ApplicationAccessKey': APPSHEET_CONFIG.API_KEY
            },
            body: JSON.stringify({
                "Action": "Find",
                "Properties": {},
                "Rows": []
            })
        });
        
        let maxOrderNum = 0;
        
        if (response.ok) {
            const data = await response.json();
            if (Array.isArray(data)) {
                data.forEach(order => {
                    const orderNum = order["Order Num"];
                    if (orderNum && orderNum.startsWith("SO-")) {
                        const num = parseInt(orderNum.replace("SO-", ""));
                        if (!isNaN(num) && num > maxOrderNum) {
                            maxOrderNum = num;
                        }
                    }
                });
            }
        }
        
        const counterRef = database.ref('orderCounter');
        const snapshot = await counterRef.once('value');
        const firebaseCounter = snapshot.val() || 0;
        
        const nextNumber = Math.max(maxOrderNum, firebaseCounter) + 1;
        
        await counterRef.set(nextNumber);
        
        return `SO-${nextNumber}`;
    } catch (error) {
        console.error("Error generating order number:", error);
        return `SO-${Date.now()}`;
    }
}

async function fetchCustomersFromAppSheet() {
    const customerSelect = document.getElementById('customer');
    const encodedTableName = encodeURIComponent(APPSHEET_CONFIG.TABLE_NAME);
    const API_URL = `https://api.appsheet.com/api/v2/apps/${APPSHEET_CONFIG.APP_ID}/tables/${encodedTableName}/Action`;
    
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'ApplicationAccessKey': APPSHEET_CONFIG.API_KEY
            },
            body: JSON.stringify({
                "Action": "Find",
                "Properties": {},
                "Rows": []
            })
        });
        
        if (!response.ok) throw new Error(`Failed to fetch customers: ${response.statusText}`);
        
        const data = await response.json();
        customerSelect.innerHTML = '<option value="" disabled selected>Select from Sold List...</option>';
        
        const customerNames = new Set();
        if (Array.isArray(data)) {
            data.forEach(item => {
                const customerName = item[APPSHEET_CONFIG.CUSTOMER_COLUMN];
                if (customerName && customerName.trim() !== '') {
                    customerNames.add(customerName.trim());
                }
            });
        }
        
        const allCustomers = Array.from(customerNames);
        
        if (allQuotesCache.length > 0) {
            const customerLastUsed = new Map();
            
            allQuotesCache.forEach(quote => {
                if (quote.sold) {
                    const quoteDate = new Date(quote.date).getTime();
                    const existingDate = customerLastUsed.get(quote.sold);
                    
                    if (!existingDate || quoteDate > existingDate) {
                        customerLastUsed.set(quote.sold, quoteDate);
                    }
                }
            });
            
            allCustomers.sort((a, b) => {
                const aDate = customerLastUsed.get(a) || 0;
                const bDate = customerLastUsed.get(b) || 0;
                
                if (aDate === 0 && bDate === 0) {
                    return a.localeCompare(b);
                }
                if (aDate === 0) return 1;
                if (bDate === 0) return -1;
                
                return bDate - aDate;
            });
        } else {
            allCustomers.sort();
        }
        
        soldListCache = allCustomers;
        
        allCustomers.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            customerSelect.appendChild(option);
        });
    } catch (error) {
        console.error("Error fetching customers:", error);
        customerSelect.innerHTML = '<option value="" disabled>Error loading customers</option>';
    }
}

async function checkAndExpireQuotes() {
    const quotesRef = database.ref('quotes');
    const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);

    try {
        const snapshot = await quotesRef.orderByChild('status').equalTo('Quoted').once('value');
        if (snapshot.exists()) {
            const updates = {};
            snapshot.forEach(childSnapshot => {
                const quote = childSnapshot.val();
                const quoteDate = new Date(quote.date).getTime();

                if (quoteDate < sevenDaysAgo) {
                    updates[`${childSnapshot.key}/status`] = 'Lost Sale';
                }
            });

            if (Object.keys(updates).length > 0) {
                await database.ref('quotes').update(updates);
            }
        }
    } catch (error) {
        console.error("Error checking for expired quotes:", error);
    }
}
        let allQuotesCache = [];
let soldListCache = [];
let filteredQuotesCache = [];
let currentTimeFilter = 'month';
let currentResultsLimit = 50;

function listenForQuoteHistory() {
    const quotesRef = database.ref('quotes');
    
    quotesRef.on('value', (snapshot) => {
        allQuotesCache = [];
        
        snapshot.forEach((childSnapshot) => {
            const quote = childSnapshot.val();
            quote.id = childSnapshot.key;
            allQuotesCache.push(quote);
        });
        
        allQuotesCache.sort((a, b) => {
            const dateA = new Date(a.date).getTime();
            const dateB = new Date(b.date).getTime();
            return dateB - dateA;
        });
        
        renderHistoryTable();
    });
}

function handleHistoryTimeFilterChange() {
    currentTimeFilter = document.getElementById('historyTimeFilter').value;
    renderHistoryTable();
}

function handleResultsLimitChange() {
    currentResultsLimit = document.getElementById('resultsLimit').value;
    renderHistoryTable();
}

function getFilteredQuotesByTime(quotes, timeFilter) {
    const now = Date.now();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    switch(timeFilter) {
        case 'today':
            return quotes.filter(q => new Date(q.date).getTime() >= today.getTime());
        
        case 'week':
            const weekAgo = now - (7 * 24 * 60 * 60 * 1000);
            return quotes.filter(q => new Date(q.date).getTime() >= weekAgo);
        
        case 'month':
            const monthAgo = now - (30 * 24 * 60 * 60 * 1000);
            return quotes.filter(q => new Date(q.date).getTime() >= monthAgo);
        
        case 'year':
            const yearAgo = now - (365 * 24 * 60 * 60 * 1000);
            return quotes.filter(q => new Date(q.date).getTime() >= yearAgo);
        
        case 'all':
        default:
            return quotes;
    }
}

function getQuotesToDisplay() {
    let quotes = getFilteredQuotesByTime(allQuotesCache, currentTimeFilter);
    
    if (currentResultsLimit !== 'all') {
        const limit = parseInt(currentResultsLimit);
        quotes = quotes.slice(0, limit);
    }
    
    return quotes;
}

function renderHistoryTable() {
    const tbody = document.getElementById('historyBody');
    const noHistoryMsg = document.getElementById('noHistoryMessage');
    const quotes = getQuotesToDisplay();
    
    if (quotes.length === 0) {
        tbody.innerHTML = '';
        noHistoryMsg.style.display = 'block';
        return;
    }
    
    noHistoryMsg.style.display = 'none';
    tbody.innerHTML = '';
    
    quotes.forEach(quote => {
        const row = tbody.insertRow();
        row.dataset.quoteId = quote.id;
        
        const checkboxCell = row.insertCell();
        checkboxCell.innerHTML = `<input type="checkbox" class="quote-checkbox" data-quote-id="${quote.id}" 
                                         onchange="handleCheckboxChange()" style="width: 18px; height: 18px; cursor: pointer;">`;
        
        const dateCell = row.insertCell();
        dateCell.textContent = new Date(quote.date).toLocaleDateString();
        
        const qnumCell = row.insertCell();
        qnumCell.textContent = quote.qnum || '-';
        
        const itemCell = row.insertCell();
        itemCell.textContent = quote.item;
        
        const pnCell = row.insertCell();
        pnCell.textContent = quote.pn;
        
        const customerCell = row.insertCell();
        customerCell.textContent = quote.sold;
        
        const costCell = row.insertCell();
        costCell.className = 'price-cell';
        costCell.textContent = `$${formatPrice(quote.cprice)}`;
        
        const sellCell = row.insertCell();
        sellCell.className = 'price-cell';
        sellCell.textContent = `$${formatPrice(quote.sprice)}`;
        
        const warrantyCell = row.insertCell();
        warrantyCell.textContent = quote.warranty || '-';
        
        const statusCell = row.insertCell();
        statusCell.className = 'status-cell';
        const statusSelect = document.createElement('select');
        statusSelect.style.width = '100%';
        statusSelect.style.padding = '6px';
        statusSelect.style.border = '1px solid #e5e7eb';
        statusSelect.style.borderRadius = '4px';
        statusSelect.innerHTML = `
            <option value="Quoted" ${quote.status === 'Quoted' ? 'selected' : ''}>Quoted</option>
            <option value="Sold" ${quote.status === 'Sold' ? 'selected' : ''}>Sold</option>
            <option value="Lost Sale" ${quote.status === 'Lost Sale' ? 'selected' : ''}>Lost Sale</option>
        `;
        statusSelect.onchange = () => handleStatusChange(quote.id, statusSelect.value);
        statusCell.appendChild(statusSelect);
        
        const notesCell = row.insertCell();
        notesCell.className = 'notes-cell';
        if (quote.notes && quote.notes.trim() !== '') {
            const notesBtn = document.createElement('button');
            notesBtn.textContent = 'View Notes';
            notesBtn.dataset.action = 'view-notes';
            notesBtn.dataset.quote = JSON.stringify(quote);
            notesCell.appendChild(notesBtn);
        } else {
            notesCell.textContent = '-';
        }
        
        const actionsCell = row.insertCell();
        actionsCell.innerHTML = `
            <button class="action-button" data-action="edit-quote" data-quote='${JSON.stringify(quote)}' title="Edit Quote">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
            </button>
            <button class="action-button create-order-btn" data-action="create-order" data-quote='${JSON.stringify(quote)}' title="Create Order">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </button>
        `;
    });
    
    updateSelectAllCheckbox();
    updateSelectedCount();
}

async function handleStatusChange(quoteId, newStatus) {
    try {
        await database.ref(`quotes/${quoteId}/status`).set(newStatus);
        
        await logActivity('quote_status_changed', {
            quoteId: quoteId,
            newStatus: newStatus
        });
        
        console.log(`Quote ${quoteId} status updated to ${newStatus}`);
    } catch (error) {
        console.error('Error updating status:', error);
        alert('Failed to update status. Please try again.');
    }
}

function handleCheckboxChange() {
    updateSelectAllCheckbox();
    updateSelectedCount();
}

function handleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.quote-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateSelectedCount();
}

function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.quote-checkbox');
    const checkedBoxes = document.querySelectorAll('.quote-checkbox:checked');
    
    if (checkboxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedBoxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedBoxes.length === checkboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

function updateSelectedCount() {
    const checkedBoxes = document.querySelectorAll('.quote-checkbox:checked');
    const countDiv = document.getElementById('selectedCount');
    countDiv.textContent = `${checkedBoxes.length} quote${checkedBoxes.length !== 1 ? 's' : ''} selected`;
}

function copySelectedQuotes() {
    const checkedBoxes = document.querySelectorAll('.quote-checkbox:checked');
    
    if (checkedBoxes.length === 0) {
        alert('Please select at least one quote to copy.');
        return;
    }
    
    const selectedQuotes = Array.from(checkedBoxes).map(checkbox => {
        const quoteId = checkbox.dataset.quoteId;
        return allQuotesCache.find(q => q.id === quoteId);
    }).filter(q => q !== undefined);
    
    const clipboardText = selectedQuotes.map(quote => {
        return `Date: ${new Date(quote.date).toLocaleDateString()}\n` +
               `Quote #: ${quote.qnum}\n` +
               `Item: ${quote.item}\n` +
               `Part #: ${quote.pn}\n` +
               `Customer: ${quote.sold}\n` +
               `Cost: $${formatPrice(quote.cprice)}\n` +
               `Sell: $${formatPrice(quote.sprice)}\n` +
               `Warranty: ${quote.warranty}\n` +
               `Status: ${quote.status}\n` +
               `Notes: ${quote.notes || 'None'}\n`;
    }).join('\n---\n\n');
    
    navigator.clipboard.writeText(clipboardText).then(() => {
        alert(`${selectedQuotes.length} quote(s) copied to clipboard!`);
        
        logActivity('quotes_copied', {
            count: selectedQuotes.length
        });
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy quotes. Please try again.');
    });
}

async function updateHotItemBadge(pn, itemName) {
    try {
        const isHot = await getHotItemStatus(pn, itemName);
        const badgeSpan = document.getElementById('hotItemBadge');
        
        if (isHot) {
            badgeSpan.innerHTML = '<span class="hot-item-badge">🔥 Hot Item</span>';
        } else {
            badgeSpan.innerHTML = '';
        }
    } catch (error) {
        console.error('Error checking hot item status:', error);
    }
}

async function getHotItemStatus(pn, itemName) {
    const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
    
    try {
        const snapshot = await database.ref('quotes')
            .orderByChild('timestamp')
            .startAt(thirtyDaysAgo)
            .once('value');
        
        let count = 0;
        snapshot.forEach((childSnapshot) => {
            const quote = childSnapshot.val();
            if (quote.pn === pn || quote.item === itemName) {
                count++;
            }
        });
        
        return count >= 5;
    } catch (error) {
        console.error('Error getting hot item status:', error);
        return false;
    }
}
        let searchQuotesCache = [];

async function fetchAllQuotesForSearch() {
    try {
        const snapshot = await database.ref('quotes').once('value');
        searchQuotesCache = [];
        
        snapshot.forEach((childSnapshot) => {
            const quote = childSnapshot.val();
            quote.id = childSnapshot.key;
            searchQuotesCache.push(quote);
        });
        
        console.log(`Loaded ${searchQuotesCache.length} quotes for search`);
    } catch (error) {
        console.error('Error fetching quotes for search:', error);
    }
}

function handlePriceHistorySearch() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    
    if (searchTerm === '') {
        const tbody = document.getElementById('searchHistoryBody');
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #9ca3af;">Search for an item to see history</td></tr>';
        return;
    }
    
    const matches = searchQuotesCache.filter(quote => 
        quote.pn.toLowerCase().includes(searchTerm) || 
        quote.item.toLowerCase().includes(searchTerm)
    );
    
    filterAndDisplayQuotes(matches);
}

let currentSearchFilter = 'all';

function handleTimeFilter(filter) {
    currentSearchFilter = filter;
    
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    handlePriceHistorySearch();
}

function filterQuotesByTimeRange(quotes, filter) {
    const now = Date.now();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    switch(filter) {
        case 'today':
            return quotes.filter(q => new Date(q.date).getTime() >= today.getTime());
        
        case 'week':
            const weekAgo = now - (7 * 24 * 60 * 60 * 1000);
            return quotes.filter(q => new Date(q.date).getTime() >= weekAgo);
        
        case 'month':
            const monthAgo = now - (30 * 24 * 60 * 60 * 1000);
            return quotes.filter(q => new Date(q.date).getTime() >= monthAgo);
        
        case 'year':
            const yearAgo = now - (365 * 24 * 60 * 60 * 1000);
            return quotes.filter(q => new Date(q.date).getTime() >= yearAgo);
        
        case 'all':
        default:
            return quotes;
    }
}

function filterAndDisplayQuotes(matches) {
    const filteredMatches = filterQuotesByTimeRange(matches, currentSearchFilter);
    
    filteredMatches.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
    
    const tbody = document.getElementById('searchHistoryBody');
    tbody.innerHTML = '';
    
    if (filteredMatches.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #9ca3af;">No results found</td></tr>';
        return;
    }
    
    filteredMatches.forEach(quote => {
        const row = tbody.insertRow();
        row.dataset.pn = quote.pn;
        row.dataset.itemName = quote.item;
        
        const dateCell = row.insertCell();
        dateCell.textContent = new Date(quote.date).toLocaleDateString();
        
        const itemCell = row.insertCell();
        itemCell.textContent = quote.item;
        
        const pnCell = row.insertCell();
        pnCell.textContent = quote.pn;
        
        const costCell = row.insertCell();
        costCell.className = 'price-cell';
        costCell.textContent = `$${formatPrice(quote.cprice)}`;
        
        const sellCell = row.insertCell();
        sellCell.className = 'price-cell';
        sellCell.textContent = `$${formatPrice(quote.sprice)}`;
        
        const statusCell = row.insertCell();
        statusCell.className = 'status-cell';
        const statusSelect = document.createElement('select');
        statusSelect.style.width = '100%';
        statusSelect.style.padding = '6px';
        statusSelect.style.border = '1px solid #e5e7eb';
        statusSelect.style.borderRadius = '4px';
        statusSelect.innerHTML = `
            <option value="Quoted" ${quote.status === 'Quoted' ? 'selected' : ''}>Quoted</option>
            <option value="Sold" ${quote.status === 'Sold' ? 'selected' : ''}>Sold</option>
            <option value="Lost Sale" ${quote.status === 'Lost Sale' ? 'selected' : ''}>Lost Sale</option>
        `;
        statusSelect.onchange = () => handleStatusChange(quote.id, statusSelect.value);
        statusCell.appendChild(statusSelect);
        
        const actionsCell = row.insertCell();
        actionsCell.innerHTML = `
            <button class="action-button" data-action="edit-quote" data-quote='${JSON.stringify(quote)}' title="Edit Quote">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
            </button>
            <button class="action-button create-order-btn" data-action="create-order" data-quote='${JSON.stringify(quote)}' title="Create Order">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </button>
        `;
    });
}

function toggleSearchSection() {
    const searchContent = document.getElementById('searchContent');
    if (searchContent.style.display === 'none') {
        searchContent.style.display = 'block';
    } else {
        searchContent.style.display = 'none';
    }
}

function updateMainView(pn, itemName) {
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('pn', pn);
    urlParams.set('item', itemName);
    
    const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
    window.history.pushState({}, '', newUrl);
    
    document.getElementById('itemName').textContent = itemName;
    document.getElementById('partNumber').textContent = pn;
    
    updateHotItemBadge(pn, itemName);
    
    const manualDetails = document.getElementById('manualItemDetails');
    const autoDetails = document.getElementById('autoItemDetails');
    if (manualDetails.style.display !== 'none') {
        manualDetails.style.display = 'none';
        autoDetails.style.display = 'block';
    }
}

function calculatePriceHistory(quotes) {
    if (quotes.length === 0) return { avgCost: 0, avgSell: 0, minCost: 0, maxCost: 0, minSell: 0, maxSell: 0 };
    
    const costs = quotes.map(q => parseFloat(q.cprice)).filter(p => !isNaN(p));
    const sells = quotes.map(q => parseFloat(q.sprice)).filter(p => !isNaN(p));
    
    return {
        avgCost: costs.length > 0 ? (costs.reduce((a, b) => a + b, 0) / costs.length) : 0,
        avgSell: sells.length > 0 ? (sells.reduce((a, b) => a + b, 0) / sells.length) : 0,
        minCost: costs.length > 0 ? Math.min(...costs) : 0,
        maxCost: costs.length > 0 ? Math.max(...costs) : 0,
        minSell: sells.length > 0 ? Math.min(...sells) : 0,
        maxSell: sells.length > 0 ? Math.max(...sells) : 0
    };
}

function renderPriceHistoryChart(quotes) {
    console.log('Price history chart rendering would go here');
}

let currentEditQuoteId = null;

function openEditModal(quote) {
    currentEditQuoteId = quote.id;
    
    document.getElementById('editQuoteId').value = quote.id;
    document.getElementById('editItemName').value = quote.item;
    document.getElementById('editPartNumber').value = quote.pn;
    document.getElementById('editCustomer').value = quote.sold;
    document.getElementById('editCostPrice').value = formatPrice(quote.cprice);
    document.getElementById('editSellPrice').value = formatPrice(quote.sprice);
    document.getElementById('editWarranty').value = quote.warranty;
    document.getElementById('editStatus').value = quote.status;
    document.getElementById('editNotes').value = quote.notes || '';
    
    const modal = document.getElementById('editModal');
    modal.classList.add('visible');
    document.body.classList.add('modal-open');
}

function closeEditModal() {
    const modal = document.getElementById('editModal');
    modal.classList.remove('visible');
    document.body.classList.remove('modal-open');
    currentEditQuoteId = null;
}

async function handleEditFormSubmit() {
    if (!currentEditQuoteId) {
        alert('No quote selected for editing.');
        return;
    }
    
    const updatedQuote = {
        sold: document.getElementById('editCustomer').value,
        cprice: parseFloat(document.getElementById('editCostPrice').value),
        sprice: parseFloat(document.getElementById('editSellPrice').value),
        warranty: document.getElementById('editWarranty').value,
        status: document.getElementById('editStatus').value,
        notes: document.getElementById('editNotes').value.trim(),
        lastModified: new Date().toISOString(),
        lastModifiedBy: currentUser.uid,
        lastModifiedByEmail: currentUser.email
    };
    
    try {
        await database.ref(`quotes/${currentEditQuoteId}`).update(updatedQuote);
        
        await logActivity('quote_edited', {
            quoteId: currentEditQuoteId
        });
        
        alert('Quote updated successfully!');
        closeEditModal();
    } catch (error) {
        console.error('Error updating quote:', error);
        alert('Failed to update quote. Please try again.');
    }
}

async function handleDeleteQuote() {
    if (!currentEditQuoteId) {
        alert('No quote selected for deletion.');
        return;
    }
    
    if (!confirm('Are you sure you want to delete this quote? This action cannot be undone.')) {
        return;
    }
    
    try {
        await database.ref(`quotes/${currentEditQuoteId}`).remove();
        
        await logActivity('quote_deleted', {
            quoteId: currentEditQuoteId
        });
        
        alert('Quote deleted successfully!');
        closeEditModal();
    } catch (error) {
        console.error('Error deleting quote:', error);
        alert('Failed to delete quote. Please try again.');
    }
}
        async function createBulkOrders() {
    const checkedBoxes = document.querySelectorAll('.quote-checkbox:checked');
    
    if (checkedBoxes.length === 0) {
        alert('Please select at least one quote to create orders.');
        return;
    }
    
    const selectedQuotes = Array.from(checkedBoxes).map(checkbox => {
        const quoteId = checkbox.dataset.quoteId;
        return allQuotesCache.find(q => q.id === quoteId);
    }).filter(q => q !== undefined && q.status === 'Quoted');
    
    if (selectedQuotes.length === 0) {
        alert('No valid quotes selected. Only quotes with "Quoted" status can be converted to orders.');
        return;
    }
    
    if (!confirm(`Create ${selectedQuotes.length} order(s) from selected quotes?`)) {
        return;
    }
    
    const encodedTableName = encodeURIComponent(APPSHEET_CONFIG.ORDERS_TABLE);
    const API_URL = `https://api.appsheet.com/api/v2/apps/${APPSHEET_CONFIG.APP_ID}/tables/${encodedTableName}/Action`;
    
    let successCount = 0;
    let failCount = 0;
    
    for (const quote of selectedQuotes) {
        try {
            const orderNum = await getNextOrderNumber();
            
            const orderData = {
                "Order Num": orderNum,
                "Part Num": quote.pn,
                "Item": quote.item,
                "Sold To": quote.sold,
                "Cost Price": quote.cprice,
                "Sell Price": quote.sprice,
                "Warranty": quote.warranty,
                "Notes": quote.notes || '',
                "Quote Num": quote.qnum,
                "Date": new Date().toISOString()
            };
            
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'ApplicationAccessKey': APPSHEET_CONFIG.API_KEY
                },
                body: JSON.stringify({
                    "Action": "Add",
                    "Properties": {},
                    "Rows": [orderData]
                })
            });
            
            if (response.ok) {
                await database.ref(`quotes/${quote.id}/status`).set('Sold');
                await database.ref(`quotes/${quote.id}/orderNum`).set(orderNum);
                
                await logActivity('bulk_order_created', {
                    quoteId: quote.id,
                    orderNumber: orderNum,
                    customer: quote.sold
                });
                
                successCount++;
            } else {
                console.error(`Failed to create order for quote ${quote.qnum}`);
                failCount++;
            }
            
        } catch (error) {
            console.error(`Error creating order for quote ${quote.qnum}:`, error);
            failCount++;
        }
    }
    
    if (successCount > 0) {
        alert(`Successfully created ${successCount} order(s)!${failCount > 0 ? ` ${failCount} failed.` : ''}`);
        
        checkedBoxes.forEach(checkbox => checkbox.checked = false);
        updateSelectAllCheckbox();
        updateSelectedCount();
    } else {
        alert('Failed to create any orders. Please try again.');
    }
}

async function createOrderFromQuote(quote) {
    if (quote.status !== 'Quoted') {
        alert('Only quotes with "Quoted" status can be converted to orders.');
        return;
    }
    
    if (!confirm(`Create order for ${quote.item}?`)) {
        return;
    }
    
    try {
        const orderNum = await getNextOrderNumber();
        
        const encodedTableName = encodeURIComponent(APPSHEET_CONFIG.ORDERS_TABLE);
        const API_URL = `https://api.appsheet.com/api/v2/apps/${APPSHEET_CONFIG.APP_ID}/tables/${encodedTableName}/Action`;
        
        const orderData = {
            "Order Num": orderNum,
            "Part Num": quote.pn,
            "Item": quote.item,
            "Sold To": quote.sold,
            "Cost Price": quote.cprice,
            "Sell Price": quote.sprice,
            "Warranty": quote.warranty,
            "Notes": quote.notes || '',
            "Quote Num": quote.qnum,
            "Date": new Date().toISOString()
        };
        
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'ApplicationAccessKey': APPSHEET_CONFIG.API_KEY
            },
            body: JSON.stringify({
                "Action": "Add",
                "Properties": {},
                "Rows": [orderData]
            })
        });
        
        if (response.ok) {
            await database.ref(`quotes/${quote.id}/status`).set('Sold');
            await database.ref(`quotes/${quote.id}/orderNum`).set(orderNum);
            
            await logActivity('order_created', {
                quoteId: quote.id,
                orderNumber: orderNum,
                customer: quote.sold
            });
            
            alert(`Order ${orderNum} created successfully!`);
        } else {
            throw new Error('Failed to create order in AppSheet');
        }
        
    } catch (error) {
        console.error('Error creating order:', error);
        alert('Failed to create order. Please try again.');
    }
}

async function generatePDF() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(20);
        doc.text('iMED ALL inc.', 105, 20, { align: 'center' });
        
        doc.setFontSize(16);
        doc.text('Sales Quote', 105, 30, { align: 'center' });
        
        doc.setFontSize(12);
        const itemName = document.getElementById('itemName').textContent;
        const partNumber = document.getElementById('partNumber').textContent;
        const customer = document.getElementById('customer').value;
        const qnum = document.getElementById('qnum').value;
        const cprice = document.getElementById('cprice').value;
        const sprice = document.getElementById('sprice').value;
        const warranty = document.getElementById('warranty').value;
        const notes = document.getElementById('notes').value;
        
        let yPosition = 50;
        
        doc.text(`Quote Number: ${qnum}`, 20, yPosition);
        yPosition += 10;
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, yPosition);
        yPosition += 15;
        
        doc.text(`Customer: ${customer}`, 20, yPosition);
        yPosition += 10;
        doc.text(`Item Name: ${itemName}`, 20, yPosition);
        yPosition += 10;
        doc.text(`Part Number: ${partNumber}`, 20, yPosition);
        yPosition += 15;
        
        doc.text(`Cost Price: $${formatPrice(cprice)} CAD`, 20, yPosition);
        yPosition += 10;
        doc.text(`Sell Price: $${formatPrice(sprice)} CAD`, 20, yPosition);
        yPosition += 10;
        doc.text(`Warranty: ${warranty}`, 20, yPosition);
        yPosition += 15;
        
        if (notes && notes.trim() !== '') {
            doc.text('Notes:', 20, yPosition);
            yPosition += 7;
            const splitNotes = doc.splitTextToSize(notes, 170);
            doc.text(splitNotes, 20, yPosition);
        }
        
        doc.save(`Quote_${qnum}.pdf`);
        
        await logActivity('pdf_generated', {
            quoteNumber: qnum
        });
        
    } catch (error) {
        console.error('Error generating PDF:', error);
        alert('Failed to generate PDF. Please try again.');
    }
}

function handleBodyClick(e) {
    const actionButton = e.target.closest('[data-action]');
    if (actionButton) {
        const action = actionButton.dataset.action;
        const quote = JSON.parse(actionButton.dataset.quote || '{}');

        if (action === 'edit-quote') {
            openEditModal(quote);
        } else if (action === 'view-notes') {
            alert(quote.notes || 'No notes for this quote.');
        } else if (action === 'create-order') {
            createOrderFromQuote(quote);
        }
        return;
    }

    const searchRow = e.target.closest('#searchHistoryBody tr');
    if (searchRow) {
        if (e.target.closest('select, button, input[type="checkbox"]')) {
            return;
        }

        const pn = searchRow.dataset.pn;
        const itemName = searchRow.dataset.itemName;
        if (pn && itemName) {
            updateMainView(pn, itemName);
            window.scrollTo(0, 0);
        }
    }
}
    </script>
</body>
</html>
